"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[578],{7476:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"developing/command-line-tools/HOW2GORELEASER","title":"Building internal tools with GoReleaser","description":"Overview","source":"@site/docs/developing/command-line-tools/HOW2GORELEASER.md","sourceDirName":"developing/command-line-tools","slug":"/developing/command-line-tools/HOW2GORELEASER","permalink":"/docs/developing/command-line-tools/HOW2GORELEASER","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/developing/command-line-tools/HOW2GORELEASER.md","tags":[],"version":"current","frontMatter":{},"sidebar":"about","previous":{"title":"Command Line Tools","permalink":"/docs/developing/command-line-tools/"},"next":{"title":"direnv","permalink":"/docs/developing/command-line-tools/direnv"}}');var i=o(4848),s=o(8453);const t={},l="Building internal tools with GoReleaser",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Install GoReleaser",id:"install-goreleaser",level:2},{value:"Split a tool out from an existing project",id:"split-a-tool-out-from-an-existing-project",level:2},{value:"Get the project building binaries",id:"get-the-project-building-binaries",level:2},{value:"Generate a <code>go.mod</code> file",id:"generate-a-gomod-file",level:3},{value:"Add pre-commit hooks",id:"add-pre-commit-hooks",level:2},{value:"Example .pre-commit-config.yaml and .markdownlintrc",id:"example-pre-commit-configyaml-and-markdownlintrc",level:3},{value:"Create Docker configuration",id:"create-docker-configuration",level:2},{value:"Example Dockerfile",id:"example-dockerfile",level:3},{value:"Create a Docker repo",id:"create-a-docker-repo",level:2},{value:"Create a Docker Hub repo",id:"create-a-docker-hub-repo",level:3},{value:"Get an API key for pushing the docker image",id:"get-an-api-key-for-pushing-the-docker-image",level:3},{value:"Create goreleaser configuration",id:"create-goreleaser-configuration",level:2},{value:"Example .goreleaser.yml",id:"example-goreleaseryml",level:3},{value:"Test goreleaser locally",id:"test-goreleaser-locally",level:3},{value:"Set up CI",id:"set-up-ci",level:2},{value:"Project Environment Variables",id:"project-environment-variables",level:3},{value:"Run a release from GitHub",id:"run-a-release-from-github",level:3},{value:"Verify the release",id:"verify-the-release",level:2},{value:"Verify you can install from your configured Homebrew Tap",id:"verify-you-can-install-from-your-configured-homebrew-tap",level:3},{value:"Verify you can install from docker hub",id:"verify-you-can-install-from-docker-hub",level:3},{value:"Broadcast this to others",id:"broadcast-this-to-others",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"building-internal-tools-with-goreleaser",children:"Building internal tools with GoReleaser"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"This is a biased document for how to build and release tools written in go."}),"\n",(0,i.jsx)(n.p,{children:"If someone else has already written a tool and open sourced it use it and contribute to it."}),"\n",(0,i.jsx)(n.p,{children:"Feel free to update and make changes!"}),"\n",(0,i.jsx)(n.h2,{id:"install-goreleaser",children:"Install GoReleaser"}),"\n",(0,i.jsxs)(n.p,{children:["To install GoReleaser visit the ",(0,i.jsx)(n.a,{href:"https://goreleaser.com/install/",children:"installation instructions"}),". It can be installed\nwith brew if you use:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"brew install goreleaser/tap/goreleaser\nbrew install goreleaser\n"})}),"\n",(0,i.jsx)(n.h2,{id:"split-a-tool-out-from-an-existing-project",children:"Split a tool out from an existing project"}),"\n",(0,i.jsxs)(n.p,{children:["If you are splitting a tool from an existing project, you can follow the\ninstructions in ",(0,i.jsx)(n.a,{href:"/docs/developing/vcs/git-repos#splitting-out-code-to-a-new-repository",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"get-the-project-building-binaries",children:"Get the project building binaries"}),"\n",(0,i.jsx)(n.p,{children:"This assumes you are creating a binary from a Go project."}),"\n",(0,i.jsxs)(n.h3,{id:"generate-a-gomod-file",children:["Generate a ",(0,i.jsx)(n.code,{children:"go.mod"})," file"]}),"\n",(0,i.jsxs)(n.p,{children:["Your project may not have a ",(0,i.jsx)(n.code,{children:"go.mod"})," file already, you can skip ahead if so."]}),"\n",(0,i.jsxs)(n.p,{children:["Initializes your ",(0,i.jsx)(n.code,{children:"go.mod"})," file with your current version of Go:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"go mod init github.com/OWNER/NEWREPO\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Fills out your ",(0,i.jsx)(n.code,{children:"go.mod"})," and ",(0,i.jsx)(n.code,{children:"go.sum"})," files and builds your binary for your current OS:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"go build\n"})}),"\n",(0,i.jsx)(n.p,{children:"You might run into some issues getting this to work outside of a project you may have split this code from. Spend some time getting it to build."}),"\n",(0,i.jsxs)(n.p,{children:["When you feel good about it, add ",(0,i.jsx)(n.code,{children:"go.mod"})," and ",(0,i.jsx)(n.code,{children:"go.sum"})," to your git index with a commit."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://medium.com/mindorks/create-projects-independent-of-gopath-using-go-modules-802260cdfb51",children:"Blog post I used to figure this out"})}),"\n",(0,i.jsx)(n.h2,{id:"add-pre-commit-hooks",children:"Add pre-commit hooks"}),"\n",(0,i.jsxs)(n.p,{children:["Write a ",(0,i.jsx)(n.code,{children:".pre-commit-config.yaml"})," file and add it to git with a commit.\nThen install the hooks and run the hooks against all files for the first time."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"pre-commit install --install-hooks\npre-commit run --all-files\n"})}),"\n",(0,i.jsx)(n.p,{children:"Fix any issues you find and commit your changes to your repo."}),"\n",(0,i.jsx)(n.h3,{id:"example-pre-commit-configyaml-and-markdownlintrc",children:"Example .pre-commit-config.yaml and .markdownlintrc"}),"\n",(0,i.jsxs)(n.p,{children:["The following example ",(0,i.jsx)(n.code,{children:".pre-commit-config.yaml"})," does some nice things for a basic go project.\nEnsure you're using the latest versions of these tools by running ",(0,i.jsx)(n.code,{children:"pre-commit autoupdate"})," and\nchecking in changes to source control."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"repos:\n  - repo: https://github.com/golangci/golangci-lint\n    rev: v1.51.2\n    hooks:\n      - id: golangci-lint\n        entry: golangci-lint run --fix --timeout 300s\n  - repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v4.4.0\n    hooks:\n      - id: check-merge-conflict\n      - id: check-yaml\n      - id: detect-private-key\n      - id: trailing-whitespace\n\n  - repo: https://github.com/igorshubovych/markdownlint-cli\n    rev: v0.33.0\n    hooks:\n      - id: markdownlint\n\n  - repo: https://github.com/trussworks/pre-commit-hooks\n    rev: v1.1.1\n    hooks:\n      - id: goreleaser-check\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This example ",(0,i.jsx)(n.code,{children:".markdownlintrc"})," will work with the above ",(0,i.jsx)(n.code,{children:".pre-commit-config.yaml"})," example.\nThis ignores some stylistic but annoying triggers."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "default": true,\n  "first-header-h1": false,\n  "first-line-h1": false,\n  "line_length": false,\n  "no-multiple-blanks": false,\n  "fenced-code-language": false\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"create-docker-configuration",children:"Create Docker configuration"}),"\n",(0,i.jsx)(n.p,{children:"Suggested but optional. This is just another distribution method."}),"\n",(0,i.jsxs)(n.p,{children:["Create a ",(0,i.jsx)(n.code,{children:"Dockerfile"})," at the root of your repo and commit it to git."]}),"\n",(0,i.jsx)(n.h3,{id:"example-dockerfile",children:"Example Dockerfile"}),"\n",(0,i.jsxs)(n.p,{children:["This example is a very basic Dockerfile that works with goreleaser with a tool/binary name of ",(0,i.jsx)(n.code,{children:"binaryname"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Goreleaser will use the binary it determines is correct to copy into the container."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:'FROM alpine:3\nCOPY binaryname /bin/binaryname\nENTRYPOINT [ "binaryname" ]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-docker-repo",children:"Create a Docker repo"}),"\n",(0,i.jsx)(n.p,{children:"Create a Docker repo. There's Docker Hub, ECR, and GitHub.\nYou'll need to be sure to enable automation to push into whatever you use."}),"\n",(0,i.jsx)(n.h3,{id:"create-a-docker-hub-repo",children:"Create a Docker Hub repo"}),"\n",(0,i.jsx)(n.p,{children:"We don't use the trussworks Docker Hub org very much so you'll need to reach out to the #infrasec Slack channel to find someone to help you."}),"\n",(0,i.jsxs)(n.p,{children:["Log into ",(0,i.jsx)(n.a,{href:"https://hub.docker.com/",children:"Docker Hub"})," with your personal account. If you don't have an account then make one\nand then have someone on InfraSec add you to the Trussworks organization."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://hub.docker.com/repository/create",children:"Create a new Docker Hub repo"})," following the same naming convention of the\nrepo like ",(0,i.jsx)(n.code,{children:"trussworks/NEWREPO"}),". You should be able to select ",(0,i.jsx)(n.code,{children:"trussworks"})," from a drop down on the form. Then set\nthe name to the same name as your tool or github repository name. The repository should be ",(0,i.jsx)(n.code,{children:"Public"})," and not ",(0,i.jsx)(n.code,{children:"Private"}),"\nif it is an open-source tool."]}),"\n",(0,i.jsxs)(n.p,{children:["After creating the repo configure the permissions to allow the ",(0,i.jsx)(n.code,{children:"bots"})," user group to have ",(0,i.jsx)(n.code,{children:"Read & Write"}),"\naccess to that repo."]}),"\n",(0,i.jsx)(n.h3,{id:"get-an-api-key-for-pushing-the-docker-image",children:"Get an API key for pushing the docker image"}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"trussworksbot"})," user credentials in 1Password to log into ",(0,i.jsx)(n.a,{href:"https://hub.docker.com/",children:"Docker Hub"})," (you may have\nto log out of your personal user session). In the ",(0,i.jsx)(n.a,{href:"https://hub.docker.com/settings/security",children:"Security Settings"}),"\nfor ",(0,i.jsx)(n.code,{children:"trussworksbot"}),' create a "New Access Token" named for the repository you just created. Save this access key to\nthe ',(0,i.jsx)(n.code,{children:"trussworksbot"})," 1Password as you will need it later for configuring GitHub Actions."]}),"\n",(0,i.jsx)(n.h2,{id:"create-goreleaser-configuration",children:"Create goreleaser configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Create a ",(0,i.jsx)(n.code,{children:".goreleaser.yml"})," file and commit it."]}),"\n",(0,i.jsx)(n.h3,{id:"example-goreleaseryml",children:"Example .goreleaser.yml"}),"\n",(0,i.jsx)(n.p,{children:"This has some decent build defaults. This will get dependencies from go.mod then build for both OSX and Linux.\nGoreleaser will also update the release in GitHub with the artifacts it builds.\nIt will also push to a brew tap. Build a Docker container but skip shipping to it."}),"\n",(0,i.jsxs)(n.p,{children:["Note: I had to add ",(0,i.jsx)(n.code,{children:"CGO_ENABLED=0"})," so the linux binary would work in Docker."]}),"\n",(0,i.jsx)(n.p,{children:"If you don't need to build a Docker container, just remove the docker stanza."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:'env:\n  - GO111MODULE=auto\nbefore:\n  hooks:\n    - go mod download\nbuilds:\n  - env:\n      - CGO_ENABLED=0\n    goos:\n      - darwin\n      - linux\n    goarch:\n      - amd64\n    main: main.go\nbrews:\n  - description: "USE THE DESCRIPTION FROM THE GITHUB REPO"\n    github:\n      owner: trussworks\n      name: homebrew-tap\n    homepage: "https://github.com/trussworks/NEWREPO"\n    commit_author:\n      name: trussworks-infra\n      email: infra+github@truss.works\ndockers:\n  - binaries:\n      - <BINARYNAME>\n    image_templates:\n      - "OWNER/NEWREPO:{{ .Tag }}"\n    skip_push: true\narchives:\n  - replacements:\n      darwin: Darwin\n      linux: Linux\n      amd64: x86_64\nchecksum:\n  name_template: "checksums.txt"\n  algorithm: sha256\nsnapshot:\n  name_template: "{{ .Tag }}-next"\nchangelog:\n  sort: asc\n  filters:\n    exclude:\n      - "^docs:"\n      - "^test:"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"test-goreleaser-locally",children:"Test goreleaser locally"}),"\n",(0,i.jsx)(n.p,{children:"Validate your file with the command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"goreleaser check\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then try to build from this configuration using:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"goreleaser build --snapshot --clean\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now you should have build artifacts in the ",(0,i.jsx)(n.code,{children:"dist/"})," directory in your repository. This is a good time to ensure\nthat ",(0,i.jsx)(n.code,{children:"dist/"})," is in your ",(0,i.jsx)(n.code,{children:".gitignore"})," file."]}),"\n",(0,i.jsx)(n.p,{children:"In your terminal from the root of your repo, try runing goreleaser without releasing with:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"goreleaser --snapshot --skip-publish --clean\n"})}),"\n",(0,i.jsx)(n.p,{children:"This goes beyond the build process and tests out the parts of the releaser related to pushing artifacts."}),"\n",(0,i.jsx)(n.h2,{id:"set-up-ci",children:"Set up CI"}),"\n",(0,i.jsx)(n.p,{children:"The next step is to write a GitHub Actions config file and commit it to your repo."}),"\n",(0,i.jsx)(n.h3,{id:"project-environment-variables",children:"Project Environment Variables"}),"\n",(0,i.jsxs)(n.p,{children:["Configure the ",(0,i.jsx)(n.code,{children:"GITHUB_TOKEN"}),", ",(0,i.jsx)(n.code,{children:"DOCKER_USER"}),", and ",(0,i.jsx)(n.code,{children:"DOCKER_PASS"})," environment variables."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"GITHUB_TOKEN"})," is used by goreleaser to update release notes and push binaries to the release on GitHub. It is also\nused to update the ",(0,i.jsx)(n.a,{href:"https://github.com/trussworks/homebrew-tap",children:"trussworks/homebrew-tap"})," with the new artifact\nlocations and checksums. In the ",(0,i.jsx)(n.code,{children:"infra+github@truss.works"})," 1Password you will find an API Key named\n",(0,i.jsx)(n.code,{children:"gorelreaser-homebrew-tap-token"})," which can be used for this value."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"DOCKER_USER"})," and ",(0,i.jsx)(n.code,{children:"DOCKER_PASS"})," are configured from the ",(0,i.jsx)(n.code,{children:"trussworksbot"})," in 1Password. Use the API Key you configured\nin an earlier step to fill out these values. This is how CI will push to Docker Hub."]}),"\n",(0,i.jsx)(n.h3,{id:"run-a-release-from-github",children:"Run a release from GitHub"}),"\n",(0,i.jsxs)(n.p,{children:["Cut a release from ",(0,i.jsx)(n.code,{children:"main"})," with a tag using semantic versioning in the style of ",(0,i.jsx)(n.code,{children:"v0.0.0"})," using:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"git tag v0.0.0\ngit push --tags\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will create a tag and CI will automatically run the ",(0,i.jsx)(n.code,{children:"release"})," workflow. This will work even on\na branch, meaning you can test the release process before merging this code into the mainline branch."]}),"\n",(0,i.jsxs)(n.p,{children:["You can also cut a release from the ",(0,i.jsx)(n.code,{children:"https://github.com/trussworks/$REPO/releases"})," view."]}),"\n",(0,i.jsxs)(n.p,{children:["And if CLI is more your thing, you can cut a release with ",(0,i.jsx)(n.code,{children:'gh release create v0.0.0 --title "My First Release" --notes "Notes go here"'}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"verify-the-release",children:"Verify the release"}),"\n",(0,i.jsx)(n.h3,{id:"verify-you-can-install-from-your-configured-homebrew-tap",children:"Verify you can install from your configured Homebrew Tap"}),"\n",(0,i.jsxs)(n.p,{children:["First see if your tool appears in the ",(0,i.jsx)(n.a,{href:"https://github.com/trussworks/homebrew-tap",children:"trussworks/homebrew-tap"})," repo.\nThere should be a Ruby file with your tool's name. If it is there then proceed to install it."]}),"\n",(0,i.jsx)(n.p,{children:"Install the Trussworks tap to homebrew and then install the tool you built."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"brew tap trussworks/tap\nbrew install tool-name\n"})}),"\n",(0,i.jsx)(n.p,{children:"Test your tool by using the help command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"tool-name -h\ntool-name version\n"})}),"\n",(0,i.jsx)(n.p,{children:"Verify the version matches the release version."}),"\n",(0,i.jsxs)(n.p,{children:["Be sure you updated the ",(0,i.jsx)(n.code,{children:"README.md"})," in the new tool repo to have installation instructions."]}),"\n",(0,i.jsx)(n.h3,{id:"verify-you-can-install-from-docker-hub",children:"Verify you can install from docker hub"}),"\n",(0,i.jsx)(n.p,{children:"You will want to verify that your docker image was pushed to Docker Hub. Try pulling the image and running from\nthe container:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:"docker pull trussworks/tool-name:v0.0.0\ndocker run -it trussworks/tool-name:v0.0.0 --help\ndocker run -it trussworks/tool-name:v0.0.0 version\n"})}),"\n",(0,i.jsx)(n.h2,{id:"broadcast-this-to-others",children:"Broadcast this to others"}),"\n",(0,i.jsx)(n.p,{children:"Be sure you let other folks know you broke this out for them to use and contribute to! Consider doing one of these to help get more eyes on your new tool repo:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add the people you worked with on this tool to your PRs on this repo."}),"\n",(0,i.jsx)(n.li,{children:"Add some documentation to your repo and send the repo to Trussels in Slack!"}),"\n",(0,i.jsx)(n.li,{children:"Do a demo for your team or other teams or as an OTT."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>t,x:()=>l});var r=o(6540);const i={},s=r.createContext(i);function t(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);