"use strict";(self.webpackChunkengineering_playbook=self.webpackChunkengineering_playbook||[]).push([[9091],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),h=r,m=d["".concat(s,".").concat(h)]||d[h]||p[h]||o;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},2591:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));n(8209);const o={},i="CI/CD according to Truss",l={unversionedId:"infrasec/ci_cd",id:"infrasec/ci_cd",title:"CI/CD according to Truss",description:"What is this? Is this for me?",source:"@site/docs/infrasec/ci_cd.md",sourceDirName:"infrasec",slug:"/infrasec/ci_cd",permalink:"/docs/infrasec/ci_cd",draft:!1,editUrl:"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/ci_cd.md",tags:[],version:"current",frontMatter:{},sidebar:"practices",previous:{title:"InfraSec Practice Charter",permalink:"/docs/infrasec/charter"},next:{title:"Good Infrastructure - A Philosophy",permalink:"/docs/infrasec/good-infra"}},s={},u=[{value:"What is this? Is this for me?",id:"what-is-this-is-this-for-me",level:2},{value:"Embrace your constraints",id:"embrace-your-constraints",level:3},{value:"Treat these points as a guiding star",id:"treat-these-points-as-a-guiding-star",level:3},{value:"Platform",id:"platform",level:2},{value:"Run time",id:"run-time",level:2},{value:"Runners",id:"runners",level:2},{value:"Builds",id:"builds",level:2},{value:"Artifact storage",id:"artifact-storage",level:2},{value:"Alerting",id:"alerting",level:2},{value:"Other",id:"other",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"cicd-according-to-truss"},"CI/CD according to Truss"),(0,r.kt)("h2",{id:"what-is-this-is-this-for-me"},"What is this? Is this for me?"),(0,r.kt)("p",null,"You just started on a brand-new project. It's day 1, and everything is\ngreenfield; there is no existing software, let alone anything to continuously\nintegrate or deploy. You are tasked to build CI/CD for the project. How do you\ndesign toward your requirements? How do you set yourself up for success when\nyou don't even know what your requirements are going to be?"),(0,r.kt)("p",null,'Or maybe you inherited a CI/CD system that the client already has. It\'s in bad\nshape, and you are tasked to get it into good shape. But what is "good shape"\nfor CI/CD? What needs to be handled first?'),(0,r.kt)("p",null,"If any of that feels familiar, this document is for you."),(0,r.kt)("h3",{id:"embrace-your-constraints"},"Embrace your constraints"),(0,r.kt)("p",null,"Working with constraints is a fact of life that we accept to deliver value to\nour clients. We expect you will make strategic compromises in engineering\narchitecture where it is necessary or expedient, rather than unthinkingly\nconforming to rules handed down from outside the project."),(0,r.kt)("p",null,"Truss leadership knows that there is no one better equipped and informed to\nmake those compromises than the people working with the project's requirements\nday to day, and we trust you to make those decisions."),(0,r.kt)("p",null,"Also, good documentation is hard. Keeping it up to date is even harder. Some of\nwhat you are about to read is out of date. Use your judgment, absorb what is\nuseful, and disregard what is not."),(0,r.kt)("h3",{id:"treat-these-points-as-a-guiding-star"},"Treat these points as a guiding star"),(0,r.kt)("p",null,"Follow the star if you are lost and need direction. Ask questions. If you know\nbetter than what's written here, update it to help those who will come after\nyou."),(0,r.kt)("h2",{id:"platform"},"Platform"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Use ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/features/actions"},"Github Actions")," (GHA).")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Especially")," on FedGov projects, due to the FedRAMP status (or lack thereof)\nfor the alternatives."),(0,r.kt)("p",null,"GHA has good documentation, and a rich ecosystem for shared Actions. Deployment\norchestration is solid. Support for self-hosted runners is there.\nParallelization is good."),(0,r.kt)("p",null,"Using the same service for source control and CI/CD makes for a clearer access\ncontrol story."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Use ",(0,r.kt)("a",{parentName:"li",href:"https://circleci.com"},"CircleCI")," on Federal government projects.")),(0,r.kt)("p",null,"CircleCI is not FedRAMP'd. That means you must use their self-hosted offering,\nwhich always lags far behind on features and documentation."),(0,r.kt)("p",null,"We have had good experiences with CircleCI's cloud service. If a commercial\nclient wants it, then we should consider it."),(0,r.kt)("p",null,"However, using GHA means you have a smaller stack, so lean that way anyhow."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Use ",(0,r.kt)("a",{parentName:"li",href:"https://bitbucket.org/product/features/pipelines"},"Bitbucket Pipelines"),", at all.")),(0,r.kt)("p",null,"Documentation is wholly inadequate."),(0,r.kt)("p",null,"It does not have feature parity with GHA or CircleCI, by a long shot."),(0,r.kt)("p",null,"The API is poorly implemented."),(0,r.kt)("h2",{id:"run-time"},"Run time"),(0,r.kt)("p",null,"CI/CD systems are classic accumulators of tech debt. Maintaining the\nreliability and run time of these processes requires setting boundaries up\nfront and then doggedly sticking to them."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Maintain focus on how the run time for build and deploy workflows impacts\ndeveloper effectiveness iterating on the app.")),(0,r.kt)("p",null,"If a workflow increases the overhead on developers trying to iterate on the\nsoftware, it should be ",(0,r.kt)("em",{parentName:"p"},"removed")," until it can be fixed."),(0,r.kt)("p",null,"This often shows up as: \"We don't know how to make it faster, but that's on our\nroadmap.\" No. Make the time now, or get rid of the slow thing until you can do\nit right."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Lose sight of how long build and deploy workflows ",(0,r.kt)("em",{parentName:"li"},"will")," inhibit fixes\nduring an incident. Slow CI/CD is a security and availability risk to your\nproject!")),(0,r.kt)("p",null,"See above."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Tolerate flaky tests in CI.")),(0,r.kt)("p",null,"Flaky tests in CI are even worse than a slow build because they add routine\ntoil for developers monitoring and re-running their builds."),(0,r.kt)("p",null,'"That test is flaky, just re-run it!" No. Remove the flaky test, or configure\nit to run locally only. If it can be re-engineered later to fix the flakiness,\n',(0,r.kt)("em",{parentName:"p"},"then")," it can be restored to CI."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Get buy-in from product management on these points early.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Norm early and often on what is an acceptable duration for builds and\ndeployments, and then ",(0,r.kt)("em",{parentName:"p"},"stick to the norm"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Parallelize as much as you can."))),(0,r.kt)("p",null,"Include parallelization as part of the acceptance criteria for planned\nexpansions to CI/CD workflows."),(0,r.kt)("p",null,"Routinely revisit the overall architecture to look for what else could be\nparallelized."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Gate deploy steps on any kind of human intervention.")),(0,r.kt)("p",null,"A merge to the main branch should be the final human action required to deploy\nto production."),(0,r.kt)("p",null,"If you need blue/green deploys or such to avoid unplanned downtime with this\nmodel, then you need blue/green deploys."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Accept the introduction of manual testing.")),(0,r.kt)("p",null,"Manual tests are time consuming and tedious. They are a drag on the development\ncycle like flaky or slow tests, except far worse."),(0,r.kt)("p",null,"It is not temporary, no matter what anyone says. Our experience shows clearly\nthat once there are any manual tests, you are on a slippery slope."),(0,r.kt)("h2",{id:"runners"},"Runners"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Use self-hosted runners if CD can deploy into production.")),(0,r.kt)("p",null,"This avoids complex credential management solutions."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Have separate runners following the principle of least privilege.")),(0,r.kt)("p",null,"For example, a runner that only runs pre-commit doesn't need to have the same\naccess as a runner that deploys to a test environment, which doesn't need the\nsame access as a runner that deploys to production."),(0,r.kt)("p",null,"If you are dealing with an ATO process, your security officer will appreciate\nthis. If you don't have one, it's still best practice."),(0,r.kt)("h2",{id:"builds"},"Builds"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Pin the version of everything using deterministic, calculated tags, like\nthe git commit digest, a unix timestamp, or a combination.",(0,r.kt)("sup",{parentName:"p",id:"fnref-1"},(0,r.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DON'T: Tag anything with ","`",":latest","`",", ","`",":staging","`"," or anything of such.",(0,r.kt)("sup",{parentName:"p",id:"fnref-2"},(0,r.kt)("a",{parentName:"sup",href:"#fn-2",className:"footnote-ref"},"2")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Use distroless base images in docker, and build everything on top of\nthose."))),(0,r.kt)("h2",{id:"artifact-storage"},"Artifact storage"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Get money for ",(0,r.kt)("a",{parentName:"li",href:"https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts"},"artifact storage")," into the budget ASAP.")),(0,r.kt)("p",null,"Budget amendments are hard, especially if they require contract modifications.\nSo get the paperwork in line well before you want artifact storage (and you'll\nwant artifact storage early)."),(0,r.kt)("p",null,"Artifact storage is extremely cheap compared to the engineering time you will\nbill the client later trying to work around not having it."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Set up artifact storage for caching builds.")),(0,r.kt)("p",null,"Whether it's uploading a zip file to S3 or pushing a built image to ECR,\nartifact caching and storage enables later optimizations for automated\nvulnerability scanning, build promotion, sharing artifacts (e.g. docker layers)\nbetween builds to accelerate build and deploy times, getting visibility into\nfailed builds, and more."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DON'T: Fragment your artifact storage repositories.")),(0,r.kt)("p",null,"For example, you need ",(0,r.kt)("em",{parentName:"p"},"one")," ECR repo shared across AWS accounts."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\x3c!--  TODO: Explain why. --\x3e\n")),(0,r.kt)("h2",{id:"alerting"},"Alerting"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Alert on build failures from the main branch.")),(0,r.kt)("p",null,"A broken main branch is a fire drill."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DO: Control ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Alarm_fatigue"},"alert fatigue"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DON'T: Alert on successful builds.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"DON'T: Put alerts in their own Slack channel."))),(0,r.kt)("p",null,"If there are so many alerts from CI/CD that you feel tempted to put them in a\nseparate channel, then you have too many alerts."),(0,r.kt)("h2",{id:"other"},"Other"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"DO: Apply the ",(0,r.kt)("a",{parentName:"li",href:"https://playbook.truss.works/docs/01-how-we-execute/06-steel-cable/"},"steel cable")," approach to building CI/CD.")),(0,r.kt)("div",{className:"footnotes"},(0,r.kt)("hr",{parentName:"div"}),(0,r.kt)("ol",{parentName:"div"},(0,r.kt)("li",{parentName:"ol",id:"fn-1"},(0,r.kt)("a",{parentName:"li",href:"https://vsupalov.com/docker-better-image-tags/"},"https://vsupalov.com/docker-better-image-tags/"),(0,r.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")),(0,r.kt)("li",{parentName:"ol",id:"fn-2"},(0,r.kt)("a",{parentName:"li",href:"https://vsupalov.com/docker-latest-tag/"},"https://vsupalov.com/docker-latest-tag/"),(0,r.kt)("a",{parentName:"li",href:"#fnref-2",className:"footnote-backref"},"\u21a9")))))}p.isMDXComponent=!0},8209:(e,t,n)=>{n(7294)}}]);