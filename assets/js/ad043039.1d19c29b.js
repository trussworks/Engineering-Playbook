"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[8581],{2977:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>s,metadata:()=>o,toc:()=>h});const o=JSON.parse('{"id":"infrasec/terraform/README","title":"Terraform","description":"Overview","source":"@site/docs/infrasec/terraform/README.md","sourceDirName":"infrasec/terraform","slug":"/infrasec/terraform/","permalink":"/docs/infrasec/terraform/","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/terraform/README.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"Project Teardown Guide","permalink":"/docs/infrasec/teardown"},"next":{"title":"Atlantis","permalink":"/docs/infrasec/terraform/atlantis"}}');var i=t(4848),n=t(8453);const s={},a="Terraform",l={},h=[{value:"Overview",id:"overview",level:2},{value:"Semantic Versioning",id:"semantic-versioning",level:3},{value:"Starting a module experiment",id:"starting-a-module-experiment",level:3},{value:"Splitting a git repo",id:"splitting-a-git-repo",level:3},{value:"Going public",id:"going-public",level:3},{value:"Publishing a release",id:"publishing-a-release",level:3},{value:"Updating a module for a new version of Terraform",id:"updating-a-module-for-a-new-version-of-terraform",level:3},{value:"Version support policy",id:"version-support-policy",level:3},{value:"Version not appearing in the registry",id:"version-not-appearing-in-the-registry",level:3},{value:"Terraform state mv",id:"terraform-state-mv",level:3},{value:"Terraform import",id:"terraform-import",level:3},{value:"How to layout/structure a Terraform Project",id:"how-to-layoutstructure-a-terraform-project",level:3},{value:"How to test your Terraform code",id:"how-to-test-your-terraform-code",level:3}];function d(e){const r={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"terraform",children:"Terraform"})}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(r.p,{children:["Terraform is our tool of choice for automating our 'cloud infrastructure'. In particular, we expect all but the earliest of prototype ",(0,i.jsx)(r.a,{href:"/docs/infrasec/aws/",children:"AWS"})," resources to be created/deployed using terraform rather than by hand."]}),"\n",(0,i.jsx)(r.p,{children:"If you're new to Terraform, you can find a very useful resource for beginners\nfrom HashiCorp's Learning platform."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsxs)(r.a,{href:"https://developer.hashicorp.com/terraform/tutorials/aws-get-started",children:["\u27a1\ufe0f Read ",(0,i.jsx)(r.strong,{children:"Get Started - AWS"})," HashiCorp Learning using Terraform."]})}),"\n",(0,i.jsx)(r.h3,{id:"semantic-versioning",children:"Semantic Versioning"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["When publishing a module for the first time, if you're uncertain what version to use, use ",(0,i.jsx)(r.code,{children:"v1.0.0"})]}),"\n",(0,i.jsxs)(r.li,{children:["Any changes to a module that don't result in a resource being recreated, increment the ",(0,i.jsx)(r.em,{children:"patch"})," version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n",(0,i.jsxs)(r.li,{children:["Any changes to a module that results in a resource being recreated, increment the ",(0,i.jsx)(r.em,{children:"minor"})," version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n",(0,i.jsxs)(r.li,{children:["Any changes to support GovCloud that do not result in changes to resources, increment the ",(0,i.jsx)(r.em,{children:"minor"})," version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n",(0,i.jsxs)(r.li,{children:["Any changes that results in a user having to update the module, increment the ",(0,i.jsx)(r.em,{children:"major"})," version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n",(0,i.jsxs)(r.li,{children:["Upgrading a module from <0.12 to 0.12, increment the ",(0,i.jsx)(r.em,{children:"major"})," version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"starting-a-module-experiment",children:"Starting a module experiment"}),"\n",(0,i.jsx)(r.p,{children:"..."}),"\n",(0,i.jsx)(r.h3,{id:"splitting-a-git-repo",children:"Splitting a git repo"}),"\n",(0,i.jsxs)(r.p,{children:["We often start out with Terraform code embedded into the infrastructure for a specific project before we decide we want to publish a chunk of it as stand-alone module. When moving code from one git repository to another, it is useful to maintain the revision history. To split a git repository while preserving the history, see ",(0,i.jsx)(r.a,{href:"/docs/developing/vcs/git-repos",children:"this page"})," in the Engineering Playbook."]}),"\n",(0,i.jsx)(r.p,{children:"Once the Terraform code has been split into a separate repo, you can add the usual trimmings for a Terraform module: README, pre-commit/CircleCI configuration, terratest(s), etc."}),"\n",(0,i.jsxs)(r.p,{children:["Before going public, consider sourcing the module from github as described in the ",(0,i.jsx)(r.a,{href:"https://www.terraform.io/docs/modules/sources.html",children:"sources"})," documentation to confirm that no changes are planned after the migration."]}),"\n",(0,i.jsx)(r.h3,{id:"going-public",children:"Going public"}),"\n",(0,i.jsx)(r.p,{children:"When you're ready to turn the prototype module into a published one, there are a few things you'll need to do if you haven't already:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["\ud83d\udd12 Add a subscription to your repo in our ",(0,i.jsx)(r.a,{href:"https://trussworks.slack.com/messages/C91SHMKFV/",children:"#infra-feed"})," channel:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"/github subscribe trussworks/your-repo-here"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.code,{children:"/github unsubscribe trussworks/your-repo-here commits deployments releases"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["Wire the repo up to the ",(0,i.jsx)(r.a,{href:"https://registry.terraform.io",children:"terraform module registry"}),".","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["First read through the Terraform docs on ",(0,i.jsx)(r.a,{href:"https://www.terraform.io/docs/registry/modules/publish.html",children:"Publishing Modules"})," and make appropriate changes to your repository"]}),"\n",(0,i.jsxs)(r.li,{children:["Ensure that the module you wish to publish has a SemVer tag attached to it. If not use ",(0,i.jsx)(r.code,{children:"v1.0.0"}),"."]}),"\n",(0,i.jsx)(r.li,{children:"Sign into the registry using the trussworks-infra Github credentials (available in 1Password)"}),"\n",(0,i.jsxs)(r.li,{children:['In the upper right corner select "Publish" or go directly to the ',(0,i.jsx)(r.a,{href:"https://registry.terraform.io/github/create",children:"Publish URL"})]}),"\n",(0,i.jsx)(r.li,{children:"Select the repository you wish to publish from the drop down list. If you don't see it hit the refresh icon."}),"\n",(0,i.jsx)(r.li,{children:'Select the "Publish Module" button.'}),"\n",(0,i.jsx)(r.li,{children:"Verify on the next screen that everything you expect to see is correct."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"publishing-a-release",children:"Publishing a release"}),"\n",(0,i.jsxs)(r.p,{children:["To publish a release from a terraform module that's already connected to the ",(0,i.jsx)(r.a,{href:"https://registry.terraform.io",children:"terraform module registry"}),", all you need to do after your PR merges is:"]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:'From the releases tab, click the "Draft a release" button.'}),"\n",(0,i.jsx)(r.li,{children:"Add a meaningful description."}),"\n",(0,i.jsxs)(r.li,{children:["Increment the package version per ",(0,i.jsx)(r.a,{href:"https://semver.org/",children:"semantic versioning"})," guidelines."]}),"\n",(0,i.jsx)(r.li,{children:'Click the "Publish release" button.'}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"You don't need to add any binary files. GitHub will do this automatically for you."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{src:"images/draft-release.png",alt:"Screenshot of a release draft",title:"Screenshot of a release draft"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{src:"images/publish-release.png",alt:"Screenshot of a published release",title:"Screenshot of a published release"})}),"\n",(0,i.jsx)(r.h3,{id:"updating-a-module-for-a-new-version-of-terraform",children:"Updating a module for a new version of Terraform"}),"\n",(0,i.jsx)(r.p,{children:"In order to preserve the ability to release updates for previous Terraform versions, when you update a module to support a new version, you should cut a separate branch we can use to publish updates for the old version. Follow this procedure:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:"Compose your PR for the module updating it to the new version of Terraform and get it approved."}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.em,{children:"Before you merge"}),", create a branch off the ",(0,i.jsx)(r.em,{children:"current"})," default branch named after the previous Terraform version (for instance, if the old version is 0.11, create a ",(0,i.jsx)(r.code,{children:"terraform011"})," branch) and push it to origin."]}),"\n",(0,i.jsxs)(r.li,{children:['Add a note to the README in your PR that describes which major version of the module supports which version of Terraform and which branch to submit a PR to for each (e.g., "For Terraform 0.12, pin the module version to ',(0,i.jsx)(r.code,{children:"~> 2.0"}),". Submit pull requests to the default branch. For Terraform 0.11, pin the module version to ",(0,i.jsx)(r.code,{children:"~> 1.0"}),". Submit pull requests to the ",(0,i.jsx)(r.code,{children:"terraform011"}),' branch.")']}),"\n",(0,i.jsx)(r.li,{children:"Merge your changes in to the module's default branch."}),"\n",(0,i.jsxs)(r.li,{children:["Cut a new release as described above. Increment the ",(0,i.jsx)(r.em,{children:"major"})," version of the module as you described in the README."]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"version-support-policy",children:"Version support policy"}),"\n",(0,i.jsx)(r.p,{children:'Truss policy is to support no more than 2 "current" versions of a\nTerraform module; this usually means a version to support the latest\nrelease of Terraform and the previous release, e.g. Terraform 1.0 and\nTerraform 0.15.'}),"\n",(0,i.jsx)(r.h3,{id:"version-not-appearing-in-the-registry",children:"Version not appearing in the registry"}),"\n",(0,i.jsxs)(r.p,{children:["If a release published in GitHub does not appear properly in the Terraform registry, see ",(0,i.jsx)(r.a,{href:"https://www.terraform.io/docs/registry/modules/publish.html#releasing-new-versions",children:"Releasing New Versions"})," for instructions on how to address."]}),"\n",(0,i.jsx)(r.p,{children:"If the steps outlined in the above link do not work, try publishing a new patch release with the same commit id."}),"\n",(0,i.jsx)(r.h3,{id:"terraform-state-mv",children:"Terraform state mv"}),"\n",(0,i.jsxs)(r.p,{children:["Refer to the Truss ",(0,i.jsxs)(r.a,{href:"/docs/infrasec/terraform/terraform-state-mv",children:[(0,i.jsx)(r.code,{children:"terraform state mv"})," info sheet"]}),"."]}),"\n",(0,i.jsx)(r.h3,{id:"terraform-import",children:"Terraform import"}),"\n",(0,i.jsxs)(r.p,{children:["Refer to the Truss ",(0,i.jsxs)(r.a,{href:"/docs/infrasec/terraform/terraform-import",children:[(0,i.jsx)(r.code,{children:"terraform import"})," info sheet"]}),"."]}),"\n",(0,i.jsx)(r.h3,{id:"how-to-layoutstructure-a-terraform-project",children:"How to layout/structure a Terraform Project"}),"\n",(0,i.jsxs)(r.p,{children:["Refer to the Truss ",(0,i.jsx)(r.a,{href:"https://github.com/trussworks/terraform-layout-example",children:"Terraform Layout Example"}),"."]}),"\n",(0,i.jsx)(r.h3,{id:"how-to-test-your-terraform-code",children:"How to test your Terraform code"}),"\n",(0,i.jsxs)(r.p,{children:["Refer to the Truss ",(0,i.jsx)(r.a,{href:"/docs/infrasec/terraform/terratest",children:"Terratest Guide"}),"."]})]})}function c(e={}){const{wrapper:r}={...(0,n.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,r,t)=>{t.d(r,{R:()=>s,x:()=>a});var o=t(6540);const i={},n=o.createContext(i);function s(e){const r=o.useContext(n);return o.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(n.Provider,{value:r},e.children)}}}]);