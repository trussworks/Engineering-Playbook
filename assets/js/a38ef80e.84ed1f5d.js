"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[1373],{4559:(o,n,e)=>{e.r(n),e.d(n,{assets:()=>r,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"infrasec/aws/govcloud/gov-orgs","title":"Setting Up a GovCloud Organization","description":"Setting up organizations in GovCloud requires some additional steps due","source":"@site/docs/infrasec/aws/govcloud/gov-orgs.md","sourceDirName":"infrasec/aws/govcloud","slug":"/infrasec/aws/govcloud/gov-orgs","permalink":"/docs/infrasec/aws/govcloud/gov-orgs","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/aws/govcloud/gov-orgs.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"ACM in GovCloud","permalink":"/docs/infrasec/aws/govcloud/gov-acm"},"next":{"title":"GuardDuty for Organizations","permalink":"/docs/infrasec/aws/guardduty"}}');var t=e(4848),c=e(8453);const i={},s="Setting Up a GovCloud Organization",r={},l=[{value:"GovCloud Organization master account",id:"govcloud-organization-master-account",level:2},{value:"Additional GovCloud accounts",id:"additional-govcloud-accounts",level:2},{value:"Adding new GovCloud accounts to the GovCloud Organization",id:"adding-new-govcloud-accounts-to-the-govcloud-organization",level:2},{value:"Handling GovCloud dummy accounts in AWS commercial",id:"handling-govcloud-dummy-accounts-in-aws-commercial",level:2},{value:"Enabling Business Support in GovCloud",id:"enabling-business-support-in-govcloud",level:2}];function u(o){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,c.R)(),...o.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"setting-up-a-govcloud-organization",children:"Setting Up a GovCloud Organization"})}),"\n",(0,t.jsx)(n.p,{children:"Setting up organizations in GovCloud requires some additional steps due\nto the way GovCloud interacts (or rather, doesn't interact) with commercial\nAWS accounts. The instructions below will take you through the process of\ngetting an organization and its accounts set up properly."}),"\n",(0,t.jsx)(n.h2,{id:"govcloud-organization-master-account",children:"GovCloud Organization master account"}),"\n",(0,t.jsx)(n.p,{children:'To set up a new GovCloud AWS Organization, you must log in as root to the\norg-root account of your commercial AWS Organization. Then go to the "My\nAccount" screen with the pulldown in the upper right of the AWS dashboard,\nand scroll down; there will be a "Sign up for AWS GovCloud" button. When\nyou click that, you will need to accept an appendix to the AWS Customer\nAgreement; once you do so, you will get an email with instructions on how\nto log in to your GovCloud account.'}),"\n",(0,t.jsxs)(n.p,{children:["Once you create the account, you can create a temporary IAM user with full\ncredentials you can use to ",(0,t.jsx)(n.a,{href:"https://github.com/trussworks/terraform-aws-bootstrap",children:"bootstrap\nTerraform"})," in the\naccount as you would in commercial AWS."]}),"\n",(0,t.jsxs)(n.p,{children:["Once you have bootstrapped Terraform, you can create the GovCloud\norganization the same way you would in commercial; however, you cannot\nadd ",(0,t.jsx)(n.code,{children:"cloudtrail.amazonaws.com"})," as a service access principal in your\norganization definition because organization CloudTrails are not available\nin GovCloud."]}),"\n",(0,t.jsx)(n.h2,{id:"additional-govcloud-accounts",children:"Additional GovCloud accounts"}),"\n",(0,t.jsxs)(n.p,{children:["To add more accounts to your GovCloud organization, you ",(0,t.jsx)(n.em,{children:"cannot"})," simply\nuse the Terraform ",(0,t.jsx)(n.code,{children:"aws_organizations_account"})," resource. Using credentials\nfor the org-root account in your commercial AWS Organization, use the\nfollowing AWS CLI command. This will create two accounts; a dummy account\nin the commercial AWS Organization and a new corresponding GovCloud\naccount, both with the same account alias."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ aws organizations create-gov-cloud-account \\\n  --email spacecats-infra+spacecats-govcloud-id@example.com \\\n  --account-name spacecats-govcloud-id\n"})}),"\n",(0,t.jsxs)(n.p,{children:["(You can add ",(0,t.jsx)(n.code,{children:"--iam-user-access-to-billing DENY"})," if you want, but this\nwon't really matter once we lock down the dummy account later.)"]}),"\n",(0,t.jsx)(n.p,{children:"This will give you output that looks something like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "CreateAccountStatus": {\n    "Id": "car-8d813980526511ea7184124ac536023e",\n    "AccountName": "spacecats-govcloud-id",\n    "State": "IN_PROGRESS",\n    "RequestedTimestamp": 1582040671.363\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"You can then run the following command to get the account ID of your new\nGovCloud account:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ aws organizations describe-create-account-status \\\n  --create-account-request-id car-8d813980526511ea7184124ac536023e\n"})}),"\n",(0,t.jsx)(n.p,{children:"You'll get output that looks like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "CreateAccountStatus": {\n    "Id": "car-8d813980526511ea7184124ac536023e",\n    "AccountName": "spacecats-govcloud-id",\n    "State": "SUCCEEDED",\n    "RequestedTimestamp": 1582040671.446,\n    "CompletedTimestamp": 1582040736.794,\n    "AccountId": "123456789000",\n    "GovCloudAccountId": "000987654321"\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In that output, ",(0,t.jsx)(n.code,{children:"AccountId"})," is the account number for the dummy account,\nand the ",(0,t.jsx)(n.code,{children:"GovCloudAccountId"})," is the account number for your new GovCloud\naccount."]}),"\n",(0,t.jsxs)(n.p,{children:["Now that you have that, you can assume the ",(0,t.jsx)(n.code,{children:"OrganizationAccountAccessRole"}),"\nin the new account from an account with sufficient privileges in the\n",(0,t.jsx)(n.em,{children:"GovCloud"})," organization org-root account. ",(0,t.jsx)(n.em,{children:"Note that this is the case even\nthough at this point the GovCloud organization does not show up if you\nlook at the organization membership in the console."})]}),"\n",(0,t.jsxs)(n.p,{children:["To do this, add a new profile to your ",(0,t.jsx)(n.code,{children:".aws/config"}),"; this assumes we\nalready have a working profile for the organization org-root account,\ncalled ",(0,t.jsx)(n.code,{children:"spacecats-govcloud-org-root"}),". The new profile for your\n",(0,t.jsx)(n.code,{children:"spacecats-govcloud-id"})," account should look like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"[profile spacecats-govcloud-id]\nsource_profile=spacecats-govcloud-org-root\nrole_arn=arn:aws-us-gov:iam::000987654321:role/OrganizationAccountAccessRole\nregion=us-gov-west-1\noutput=json\n# If you have MFA turned on, you will also need to add the mfa_serial line\n# from the source_profile.\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Once you've added IAM users in the ",(0,t.jsx)(n.code,{children:"-id"})," account later on, you can change this profile to not use the OrganizationAccountAccessRole anymore; as with commercial AWS accounts, you should use resources from the organization org-root account as sparingly as possible."]}),"\n",(0,t.jsx)(n.h2,{id:"adding-new-govcloud-accounts-to-the-govcloud-organization",children:"Adding new GovCloud accounts to the GovCloud Organization"}),"\n",(0,t.jsx)(n.p,{children:"To add the account you just created to your GovCloud organization, run\nthis command with your appropriate credentials from the GovCloud\norganization's org-root account."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ aws organizations invite-account-to-organization \\\n  --target Id=000987654321,Type=ACCOUNT\n"})}),"\n",(0,t.jsx)(n.p,{children:"This will return output that looks like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:'{\n  "Handshake": {\n    "Id": "h-d6ac6154ef6a42e68513d0d8460af49a",\n\n...\n'})}),"\n",(0,t.jsx)(n.p,{children:"Using the credentials in the new account, run this command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ aws organizations accept-handshake \\\n  --handshake-id h-d6ac6154ef6a42e68513d0d8460af49a\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The account will now be in your GovCloud organization. You will want to\n",(0,t.jsx)(n.a,{href:"https://www.terraform.io/docs/providers/aws/r/organizations_account.html#import",children:"import this account"}),"\ninto your Terraform state for the GovCloud organization org-root account\nlike so:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'resource "aws_organizations_account" "spacecats_govcloud_id" {\n  name      = "spacecats-govcloud-id"\n  email     = "spacecats-infra+spacecats-govcloud-id@example.com"\n  parent_id = aws_organizations_organizational_unit.spacecats_govcloud.id\n  tags = {\n    Automation = "Terraform"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Then run this command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-console",children:"$ terraform import aws_organizations_account.spacecats_govcloud_id 000987654321\n"})}),"\n",(0,t.jsx)(n.h2,{id:"handling-govcloud-dummy-accounts-in-aws-commercial",children:"Handling GovCloud dummy accounts in AWS commercial"}),"\n",(0,t.jsxs)(n.p,{children:["As stated above, when you use the AWS CLI to create your new GovCloud\naccounts, it will also create a dummy account with the same account name\nin your commercial AWS organization. In order to prevent misuse of these\naccounts (and any confusion, since they have the same account alias as\nyour GovCloud account), we can lock these down with the ",(0,t.jsx)(n.code,{children:"suspended"})," OU\nwe usually create in the commercial AWS organization."]}),"\n",(0,t.jsxs)(n.p,{children:["To do this, import the account's Terraform resource into your commercial\nAWS organization by using the same sort of procedure described above to\nimport the new GovCloud account into the GovCloud organization, but\nreplace the ",(0,t.jsx)(n.code,{children:"parent_id"})," parameter with the Terraform resource describing\nyour ",(0,t.jsx)(n.code,{children:"suspended"})," OU -- usually something like\n",(0,t.jsx)(n.code,{children:"aws_organizations_organizational_unit.suspended.id"}),". This will make it\nimpossible to use that account for anything else, and has no effect on\nthe corresponding GovCloud account."]}),"\n",(0,t.jsx)(n.h2,{id:"enabling-business-support-in-govcloud",children:"Enabling Business Support in GovCloud"}),"\n",(0,t.jsx)(n.p,{children:"If you intend to have more than just the basic AWS support for your GovCloud\naccount, you will need to enable it in the corresponding dummy account in your\ncommercial AWS organization. Yes you read that right, to enable the AWS Support\nin GovCloud you need to actually enable it in AWS commercial. It's also\nimportant to note that as of this writing Business Support needs to be enabled\non an account by account basis and can't be enabled at the Organization level."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["If the dummy commercial AWS account is in the ",(0,t.jsx)(n.code,{children:"suspended"})," OU, you will need\nto temporarily remove it from the",(0,t.jsx)(n.code,{children:"suspended"})," OU first."]}),"\n",(0,t.jsx)(n.li,{children:"Reset the root password for the dummy commercial AWS account tied to your\nGovCloud account. These credentials should be thrown away once you're done."}),"\n",(0,t.jsx)(n.li,{children:"Log into the AWS account as root and enable Business Support."}),"\n",(0,t.jsx)(n.li,{children:"Log into the corresponding GovCloud account and confirm you have Business\nSupport enabled."}),"\n",(0,t.jsxs)(n.li,{children:["Move the dummy commercial AWS account back into the ",(0,t.jsx)(n.code,{children:"suspended"})," OU."]}),"\n"]})]})}function d(o={}){const{wrapper:n}={...(0,c.R)(),...o.components};return n?(0,t.jsx)(n,{...o,children:(0,t.jsx)(u,{...o})}):u(o)}},8453:(o,n,e)=>{e.d(n,{R:()=>i,x:()=>s});var a=e(6540);const t={},c=a.createContext(t);function i(o){const n=a.useContext(c);return a.useMemo(function(){return"function"==typeof o?o(n):{...n,...o}},[n,o])}function s(o){let n;return n=o.disableParentContext?"function"==typeof o.components?o.components(t):o.components||t:i(o.components),a.createElement(c.Provider,{value:n},o.children)}}}]);