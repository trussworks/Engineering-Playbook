"use strict";(self.webpackChunkengineering_playbook=self.webpackChunkengineering_playbook||[]).push([[1016],{3905:function(e,r,t){t.d(r,{Zo:function(){return p},kt:function(){return f}});var a=t(7294);function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function n(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?n(Object(t),!0).forEach((function(r){o(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):n(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function l(e,r){if(null==e)return{};var t,a,o=function(e,r){if(null==e)return{};var t,a,o={},n=Object.keys(e);for(a=0;a<n.length;a++)t=n[a],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(a=0;a<n.length;a++)t=n[a],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),u=function(e){var r=a.useContext(s),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},p=function(e){var r=u(e.components);return a.createElement(s.Provider,{value:r},e.children)},m={inlineCode:"code",wrapper:function(e){var r=e.children;return a.createElement(a.Fragment,{},r)}},c=a.forwardRef((function(e,r){var t=e.components,o=e.mdxType,n=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(t),f=o,h=c["".concat(s,".").concat(f)]||c[f]||m[f]||n;return t?a.createElement(h,i(i({ref:r},p),{},{components:t})):a.createElement(h,i({ref:r},p))}));function f(e,r){var t=arguments,o=r&&r.mdxType;if("string"==typeof e||o){var n=t.length,i=new Array(n);i[0]=c;var l={};for(var s in r)hasOwnProperty.call(r,s)&&(l[s]=r[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var u=2;u<n;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},8439:function(e,r,t){t.r(r),t.d(r,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return u},assets:function(){return p},toc:function(){return m},default:function(){return f}});var a=t(7462),o=t(3366),n=(t(7294),t(3905)),i=["components"],l={},s="[InfraSec](/engineering-playbook/docs/infrasec/) / Terraform",u={unversionedId:"infrasec/terraform/README",id:"infrasec/terraform/README",title:"[InfraSec](../README.md) / Terraform",description:"Overview",source:"@site/docs/infrasec/terraform/README.md",sourceDirName:"infrasec/terraform",slug:"/infrasec/terraform/",permalink:"/engineering-playbook/docs/infrasec/terraform/",editUrl:"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/terraform/README.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"[InfraSec](README.md) / Project Teardown Guide",permalink:"/engineering-playbook/docs/infrasec/teardown"},next:{title:"[Terraform](README.md) / Atlantis",permalink:"/engineering-playbook/docs/infrasec/terraform/atlantis"}},p={},m=[{value:"Overview",id:"overview",level:2},{value:"Contents",id:"contents",level:2},{value:"Semantic Versioning",id:"semantic-versioning",level:3},{value:"Starting a module experiment",id:"starting-a-module-experiment",level:3},{value:"Splitting a git repo",id:"splitting-a-git-repo",level:3},{value:"Going public",id:"going-public",level:3},{value:"Publishing a release",id:"publishing-a-release",level:3},{value:"Updating a module for a new version of Terraform",id:"updating-a-module-for-a-new-version-of-terraform",level:3},{value:"Version support policy",id:"version-support-policy",level:3},{value:"Version not appearing in the registry",id:"version-not-appearing-in-the-registry",level:3},{value:"Terraform state mv",id:"terraform-state-mv",level:3},{value:"Terraform import",id:"terraform-import",level:3},{value:"How to layout/structure a Terraform Project",id:"how-to-layoutstructure-a-terraform-project",level:3},{value:"How to test your Terraform code",id:"how-to-test-your-terraform-code",level:3}],c={toc:m};function f(e){var r=e.components,t=(0,o.Z)(e,i);return(0,n.kt)("wrapper",(0,a.Z)({},c,t,{components:r,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"infrasec--terraform"},(0,n.kt)("a",{parentName:"h1",href:"/engineering-playbook/docs/infrasec/"},"InfraSec")," / Terraform"),(0,n.kt)("h2",{id:"overview"},"Overview"),(0,n.kt)("p",null,"Terraform is our tool of choice for automating our 'cloud infrastructure'. In particular, we expect all but the earliest of prototype ",(0,n.kt)("a",{parentName:"p",href:"/engineering-playbook/docs/infrasec/aws/"},"AWS")," resources to be created/deployed using terraform rather than by hand."),(0,n.kt)("h2",{id:"contents"},"Contents"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#semantic-versioning"},"Semantic Versioning")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#splitting-a-git-repo"},"Splitting a git repo")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#going-public"},"Going public")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#publishing-a-release"},"Publishing a release")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#updating-a-module-for-a-new-version-of-terraform"},"Updating a module for a new version of Terraform")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#version-not-appearing-in-the-registry"},"Version not appearing in the registry")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#terraform-state-mv"},"Terraform state mv")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#how-to-layoutstructure-a-terraform-project"},"How to layout/structure a Terraform Project")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#how-to-test-your-terraform-code"},"How to test your Terraform code"))),(0,n.kt)("h3",{id:"semantic-versioning"},"Semantic Versioning"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"When publishing a module for the first time, if you're uncertain what version to use, use ",(0,n.kt)("inlineCode",{parentName:"li"},"v1.0.0")),(0,n.kt)("li",{parentName:"ul"},"Any changes to a module that don't result in a resource being recreated, increment the ",(0,n.kt)("em",{parentName:"li"},"patch")," version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,n.kt)("li",{parentName:"ul"},"Any changes to a module that results in a resource being recreated, increment the ",(0,n.kt)("em",{parentName:"li"},"minor")," version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,n.kt)("li",{parentName:"ul"},"Any changes to support GovCloud that do not result in changes to resources, increment the ",(0,n.kt)("em",{parentName:"li"},"minor")," version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,n.kt)("li",{parentName:"ul"},"Any changes that results in a user having to update the module, increment the ",(0,n.kt)("em",{parentName:"li"},"major")," version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,n.kt)("li",{parentName:"ul"},"Upgrading a module from \\<0.12 to 0.12, increment the ",(0,n.kt)("em",{parentName:"li"},"major")," version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines.")),(0,n.kt)("h3",{id:"starting-a-module-experiment"},"Starting a module experiment"),(0,n.kt)("p",null,"..."),(0,n.kt)("h3",{id:"splitting-a-git-repo"},"Splitting a git repo"),(0,n.kt)("p",null,"We often start out with Terraform code embedded into the infrastructure for a specific project before we decide we want to publish a chunk of it as stand-alone module. When moving code from one git repository to another, it is useful to maintain the revision history. To split a git repository while preserving the history, see ",(0,n.kt)("a",{parentName:"p",href:"/engineering-playbook/docs/developing/vcs/git-repos"},"this page")," in the Engineering Playbook."),(0,n.kt)("p",null,"Once the Terraform code has been split into a separate repo, you can add the usual trimmings for a Terraform module: README, pre-commit/CircleCI configuration, terratest(s), etc."),(0,n.kt)("p",null,"Before going public, consider sourcing the module from github as described in the ",(0,n.kt)("a",{parentName:"p",href:"https://www.terraform.io/docs/modules/sources.html"},"sources")," documentation to confirm that no changes are planned after the migration."),(0,n.kt)("h3",{id:"going-public"},"Going public"),(0,n.kt)("p",null,"When you're ready to turn the prototype module into a published one, there are a few things you'll need to do if you haven't already:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"\ud83d\udd12 Add your repo to the ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/trussworks/legendary-waddle/blob/master/trussworks-prod/github-global/main.tf"},"list of repos")," managed by our GitHub repo management module."),(0,n.kt)("li",{parentName:"ol"},"\ud83d\udd12 Add a subscription to your repo in our ",(0,n.kt)("a",{parentName:"li",href:"https://trussworks.slack.com/messages/C91SHMKFV/"},"#infra-feed")," channel:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"/github subscribe trussworks/your-repo-here")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"/github unsubscribe trussworks/your-repo-here commits deployments releases")))),(0,n.kt)("li",{parentName:"ol"},"Wire the repo up to the ",(0,n.kt)("a",{parentName:"li",href:"https://registry.terraform.io"},"terraform module registry"),".",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"First read through the Terraform docs on ",(0,n.kt)("a",{parentName:"li",href:"https://www.terraform.io/docs/registry/modules/publish.html"},"Publishing Modules")," and make appropriate changes to your repository"),(0,n.kt)("li",{parentName:"ul"},"Ensure that the module you wish to publish has a SemVer tag attached to it. If not use ",(0,n.kt)("inlineCode",{parentName:"li"},"v1.0.0"),"."),(0,n.kt)("li",{parentName:"ul"},"Sign into the registry using the trussworks-infra Github credentials (available in 1Password)"),(0,n.kt)("li",{parentName:"ul"},'In the upper right corner select "Publish" or go directly to the ',(0,n.kt)("a",{parentName:"li",href:"https://registry.terraform.io/github/create"},"Publish URL")),(0,n.kt)("li",{parentName:"ul"},"Select the repository you wish to publish from the drop down list. If you don't see it hit the refresh icon."),(0,n.kt)("li",{parentName:"ul"},'Select the "Publish Module" button.'),(0,n.kt)("li",{parentName:"ul"},"Verify on the next screen that everything you expect to see is correct.")))),(0,n.kt)("h3",{id:"publishing-a-release"},"Publishing a release"),(0,n.kt)("p",null,"To publish a release from a terraform module that's already connected to the ",(0,n.kt)("a",{parentName:"p",href:"https://registry.terraform.io"},"terraform module registry"),", all you need to do after your PR merges is:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},'From the releases tab, click the "Draft a release" button.'),(0,n.kt)("li",{parentName:"ol"},"Add a meaningful description."),(0,n.kt)("li",{parentName:"ol"},"Increment the package version per ",(0,n.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,n.kt)("li",{parentName:"ol"},'Click the "Publish release" button.')),(0,n.kt)("p",null,"You don't need to add any binary files. GitHub will do this automatically for you."),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"images/draft-release.png",alt:"Screenshot of a release draft",title:"Screenshot of a release draft"})),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"images/publish-release.png",alt:"Screenshot of a published release",title:"Screenshot of a published release"})),(0,n.kt)("h3",{id:"updating-a-module-for-a-new-version-of-terraform"},"Updating a module for a new version of Terraform"),(0,n.kt)("p",null,"In order to preserve the ability to release updates for previous Terraform versions, when you update a module to support a new version, you should cut a separate branch we can use to publish updates for the old version. Follow this procedure:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Compose your PR for the module updating it to the new version of Terraform and get it approved."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("em",{parentName:"li"},"Before you merge"),", create a branch off the ",(0,n.kt)("em",{parentName:"li"},"current")," default branch named after the previous Terraform version (for instance, if the old version is 0.11, create a ",(0,n.kt)("inlineCode",{parentName:"li"},"terraform011")," branch) and push it to origin."),(0,n.kt)("li",{parentName:"ol"},'Add a note to the README in your PR that describes which major version of the module supports which version of Terraform and which branch to submit a PR to for each (e.g., "For Terraform 0.12, pin the module version to ',(0,n.kt)("inlineCode",{parentName:"li"},"~> 2.0"),". Submit pull requests to the default branch. For Terraform 0.11, pin the module version to ",(0,n.kt)("inlineCode",{parentName:"li"},"~> 1.0"),". Submit pull requests to the ",(0,n.kt)("inlineCode",{parentName:"li"},"terraform011"),' branch.")'),(0,n.kt)("li",{parentName:"ol"},"Merge your changes in to the module's default branch."),(0,n.kt)("li",{parentName:"ol"},"Cut a new release as described above. Increment the ",(0,n.kt)("em",{parentName:"li"},"major")," version of the module as you described in the README.")),(0,n.kt)("h3",{id:"version-support-policy"},"Version support policy"),(0,n.kt)("p",null,'Truss policy is to support no more than 2 "current" versions of a\nTerraform module; this usually means a version to support the latest\nrelease of Terraform and the previous release, e.g. Terraform 1.0 and\nTerraform 0.15.'),(0,n.kt)("h3",{id:"version-not-appearing-in-the-registry"},"Version not appearing in the registry"),(0,n.kt)("p",null,"If a release published in GitHub does not appear properly in the Terraform registry, see ",(0,n.kt)("a",{parentName:"p",href:"https://www.terraform.io/docs/registry/modules/publish.html#releasing-new-versions"},"Releasing New Versions")," for instructions on how to address."),(0,n.kt)("p",null,"If the steps outlined in the above link do not work, try publishing a new patch release with the same commit id."),(0,n.kt)("h3",{id:"terraform-state-mv"},"Terraform state mv"),(0,n.kt)("p",null,"Refer to the Truss ",(0,n.kt)("a",{parentName:"p",href:"/engineering-playbook/docs/infrasec/terraform/terraform-state-mv"},(0,n.kt)("inlineCode",{parentName:"a"},"terraform state mv")," info sheet"),"."),(0,n.kt)("h3",{id:"terraform-import"},"Terraform import"),(0,n.kt)("p",null,"Refer to the Truss ",(0,n.kt)("a",{parentName:"p",href:"/engineering-playbook/docs/infrasec/terraform/terraform-import"},(0,n.kt)("inlineCode",{parentName:"a"},"terraform import")," info sheet"),"."),(0,n.kt)("h3",{id:"how-to-layoutstructure-a-terraform-project"},"How to layout/structure a Terraform Project"),(0,n.kt)("p",null,"Refer to the Truss ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/trussworks/terraform-layout-example"},"Terraform Layout Example"),"."),(0,n.kt)("h3",{id:"how-to-test-your-terraform-code"},"How to test your Terraform code"),(0,n.kt)("p",null,"Refer to the Truss ",(0,n.kt)("a",{parentName:"p",href:"/engineering-playbook/docs/infrasec/terraform/terratest"},"Terratest Guide"),"."))}f.isMDXComponent=!0}}]);