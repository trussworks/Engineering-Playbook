"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[9691],{1040:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"web/api/rest-api-design/Concurrency-Control","title":"Concurrency Control","description":"When you have more than one client using your API, you might want to think about concurrency control.","source":"@site/docs/web/api/rest-api-design/Concurrency-Control.md","sourceDirName":"web/api/rest-api-design","slug":"/web/api/rest-api-design/Concurrency-Control","permalink":"/docs/web/api/rest-api-design/Concurrency-Control","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/web/api/rest-api-design/Concurrency-Control.md","tags":[],"version":"current","frontMatter":{},"sidebar":"about","previous":{"title":"REST API Design","permalink":"/docs/web/api/rest-api-design/"},"next":{"title":"Data-Design","permalink":"/docs/web/api/rest-api-design/Data-Design"}}');var s=t(4848),r=t(8453);const o={},c="Concurrency Control",a={},h=[{value:"Optimistic Locking",id:"optimistic-locking",level:2},{value:"Optimistic Locking Example",id:"optimistic-locking-example",level:3},{value:"Step 1 - Client requests resource",id:"step-1---client-requests-resource",level:4},{value:"Step 2 - Client updates resource",id:"step-2---client-updates-resource",level:4}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"concurrency-control",children:"Concurrency Control"})}),"\n",(0,s.jsx)(n.p,{children:"When you have more than one client using your API, you might want to think about concurrency control."}),"\n",(0,s.jsx)(n.p,{children:"Consider any data a client can read and update on the server, let's call that a resource."}),"\n",(0,s.jsx)(n.p,{children:"Most clients retrieve a copy of the resource, update it locally and then send the update some time later. If you have more than one client, it's possible for a client to send an update that is now out of date with changes on the server. It will unintentionally overwrite changes that others have made."}),"\n",(0,s.jsx)(n.h2,{id:"optimistic-locking",children:"Optimistic Locking"}),"\n",(0,s.jsx)(n.p,{children:"Optimistic locking is one strategy for handling this issue in your API."}),"\n",(0,s.jsx)(n.p,{children:"In an optimistic locking scheme, you only allow a resource to be updated after you verify that the resource hasn't been modified since the client last checked."}),"\n",(0,s.jsxs)(n.p,{children:["You can do this with an ",(0,s.jsx)(n.em,{children:"eTag"}),". An eTag is an identifier for the version of the underlying resource."]}),"\n",(0,s.jsx)(n.p,{children:"When the client requests a resource, you return an eTag that identifies the version they received. When they wish to update that resource, the eTag they send must match the current version in the database."}),"\n",(0,s.jsxs)(n.p,{children:["Read more, with diagrams, about ",(0,s.jsx)(n.a,{href:"https://medium.com/swlh/api-concurrency-control-strategies-cd546c2cdc16",children:"Optimistic Locking here"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"optimistic-locking-example",children:"Optimistic Locking Example"}),"\n",(0,s.jsx)(n.h4,{id:"step-1---client-requests-resource",children:"Step 1 - Client requests resource"}),"\n",(0,s.jsx)(n.p,{children:"When the client requests information about a shipment, they get an etag for that version of the record."}),"\n",(0,s.jsx)(n.p,{children:"Request:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET /v1/shipments/99783f4d-ee83 HTTP/1.1\nHost: api.move.mil\nContent-Type: application/json\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Response, notice the ",(0,s.jsx)(n.code,{children:"eTag"})," value:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'HTTP/1.1 200 OK\nContent-Type: application/json\nBody:\n{\n  "eTag": "MjAyMC0xMi0wMVQxODo1NjoxMy4zNjkxNzRa",\n  "shipmentType": "UHAUL",\n  "deliveryDate": "2020-06-01"\n  "destinationAddress": {\n    "streetAddress1": "812 S 129th Street",\n    "city": "San Diego",\n    "state": "CA",\n    "postalCode": "92102"\n  },\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"This eTag was created by hashing the last updated date of the record."}),"\n",(0,s.jsx)(n.h4,{id:"step-2---client-updates-resource",children:"Step 2 - Client updates resource"}),"\n",(0,s.jsxs)(n.p,{children:["Then when the client wishes to update this resource, they send the eTag in the ",(0,s.jsx)(n.code,{children:"If-Match"})," header of the PUT or PATCH request."]}),"\n",(0,s.jsxs)(n.p,{children:["Request, notice the ",(0,s.jsx)(n.code,{children:"If-Match"})," in the header:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'PATCH /v1/shipments/01b9671e-b268 HTTP/1.1\nHost: api.move.mil\nContent-Type: application/json\nIf-Match: MjAyMC0xMi0wMVQxODo1NjoxMy4zNjkxNzRa\nBody:\n{\n    "shipmentType": "UPS",\n    "deliveryDate": "2020-06-08"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["If the eTag matches the resource in our database (which we can check by rehashing the lastUpdated date), we return a ",(0,s.jsx)(n.code,{children:"200 Success"})," Response."]}),"\n",(0,s.jsxs)(n.p,{children:["If the eTag does not match, we do not update the resource and we return the ",(0,s.jsx)(n.code,{children:"412 Precondition Failed"})," response."]}),"\n",(0,s.jsx)(n.p,{children:"This would only happen if another client had updated the data in the meanwhile. The client must then re-request the data to get the latest eTag."})]})}function l(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var i=t(6540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);