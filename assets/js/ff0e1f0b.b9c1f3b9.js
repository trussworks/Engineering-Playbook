"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[1841],{8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>r});var o=t(6540);const i={},s=o.createContext(i);function l(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),o.createElement(s.Provider,{value:n},e.children)}},8772:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"infrasec/ansible/molecule-primer","title":"Molecule Primer","description":"Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of","source":"@site/docs/infrasec/ansible/molecule-primer.md","sourceDirName":"infrasec/ansible","slug":"/infrasec/ansible/molecule-primer","permalink":"/docs/infrasec/ansible/molecule-primer","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/ansible/molecule-primer.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"Ansible Primer","permalink":"/docs/infrasec/ansible/ansible-primer"},"next":{"title":"AWS","permalink":"/docs/infrasec/aws/"}}');var i=t(4848),s=t(8453);const l={},r="Molecule Primer",a={},c=[{value:"Molecule documentation and articles",id:"molecule-documentation-and-articles",level:2},{value:"Setup",id:"setup",level:2},{value:"Creating a role or scenario",id:"creating-a-role-or-scenario",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Testing in EC2",id:"testing-in-ec2",level:3},{value:"Running Molecule Tests",id:"running-molecule-tests",level:2},{value:"Writing Tests in Molecule",id:"writing-tests-in-molecule",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"molecule-primer",children:"Molecule Primer"})}),"\n",(0,i.jsx)(n.p,{children:"Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of\nexperiences and resources you can use when adding testing to your own Ansible roles; take these with a grain of salt."}),"\n",(0,i.jsx)(n.h2,{id:"molecule-documentation-and-articles",children:"Molecule documentation and articles"}),"\n",(0,i.jsx)(n.p,{children:"These resources will likely come in handy when trying to get Molecule up and running for yourself:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Molecule Official Docs: ",(0,i.jsx)(n.a,{href:"https://molecule.readthedocs.io/en/latest/",children:"https://molecule.readthedocs.io/en/latest/"})]}),"\n",(0,i.jsxs)(n.li,{children:["Testing Your Ansible Roles with Molecule (Jeff Geerling):\n",(0,i.jsx)(n.a,{href:"https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule",children:"https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule"})]}),"\n",(0,i.jsxs)(n.li,{children:["Test-driven Infrastructure Development with Ansible and Molecule (Jonas Hecht):\n",(0,i.jsx)(n.a,{href:"https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/",children:"https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/"})]}),"\n",(0,i.jsxs)(n.li,{children:["Continuous Cloud Infrastructure With Ansible, Molecule, and TravisCI on AWS (Jonas Hecht):\n",(0,i.jsx)(n.a,{href:"https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/",children:"https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(n.p,{children:"You will want to use some sort of virtual environment for Molecule; hopefully you're already doing this with Ansible\nanyway. Using Python 3 as the Python binary is also highly recommended. In addition to what you need for ansible, you\nwill need these Python modules as well:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"molecule"}),"\n",(0,i.jsx)(n.li,{children:"molecule[docker] - For testing with docker containers (the default)"}),"\n",(0,i.jsx)(n.li,{children:"molecule[ec2] - For testing on ec2 instances"}),"\n",(0,i.jsx)(n.li,{children:"docker-py"}),"\n",(0,i.jsx)(n.li,{children:"boto"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"creating-a-role-or-scenario",children:"Creating a role or scenario"}),"\n",(0,i.jsx)(n.p,{children:"If you\u2019re just about to start making an Ansible role, you can use Molecule to do it and it will automatically build out\nthe Ansible role directory structure in the Galaxy-expected format in addition to creating the files needed for Molecule\ntesting. You can do this with:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"molecule init role -r your-role-name"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If you just want to add a Molecule scenario (a single test framework) to an already-existing role, go into the role\ndirectory and run this command:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"molecule init scenario -r your-role-name [ -s scenario-name ]"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["By default, these commands will both create a molecule/ directory, inside which you will find the scenarios for molecule\ntesting. The only one there by default is the default scenario, but you can add others (if you wanted one with docker,\nfor instance, and one with EC2). These commands both take a number of command line switches, but the most important one\nyou\u2019ll probably use is ",(0,i.jsx)(n.code,{children:"--driver-name"}),": This tells molecule which driver to use for the scenario it is creating; by\ndefault this is docker, but this is where you would put ec2 or vagrant or whatever else if you wanted to test it another\nway. See the Molecule docs here for more information:\n",(0,i.jsx)(n.a,{href:"https://molecule.readthedocs.io/en/latest/configuration.html#driver",children:"https://molecule.readthedocs.io/en/latest/configuration.html#driver"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The main configuration file for Molecule is ",(0,i.jsx)(n.code,{children:"molecule.yml"}),", which is in the scenario directory. This is where you can\nspecify the different components you want to use like driver, linter, verifier, etc. It\u2019s also where you\u2019ll set up the\n\u2018platform\u2019; for docker, the platform section describes things like what image to use, while for EC2, this is where you\nspecify the AMI, instance type, and subnet. The Molecule driver docs above have more details on what can be set here."]}),"\n",(0,i.jsxs)(n.p,{children:["Of special note is that for systemd-based docker images, you will need to use a few extra configuration options; the\nbottom of the docker driver docs (",(0,i.jsx)(n.a,{href:"https://molecule.readthedocs.io/en/latest/configuration.html#docker",children:"https://molecule.readthedocs.io/en/latest/configuration.html#docker"}),") has more details.\nSince most modern Linux distributions use systemd, you\u2019ll probably need to use this."]}),"\n",(0,i.jsxs)(n.p,{children:["If you have other Ansible roles your role is dependent on, be sure to specify this in the ",(0,i.jsx)(n.code,{children:"meta/main.yml"})," file in your\nAnsible role configuration, and add it to the ",(0,i.jsx)(n.code,{children:"requirements.yml"})," file in the Molecule scenario directory. Here\u2019s an\nexample of that file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"---\n- src: https://github.com/trussworks/ansible-role-aws-cloudwatch-logs-agent\n"})}),"\n",(0,i.jsx)(n.p,{children:"Once you have everything configured, you can make sure that Molecule is plumbed right by running this command:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"molecule --debug check"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If this works, you know that at least the Molecule parts are working right."}),"\n",(0,i.jsx)(n.h3,{id:"testing-in-ec2",children:"Testing in EC2"}),"\n",(0,i.jsxs)(n.p,{children:["With EC2, there a couple of other steps you\u2019ll need to take. First, you\u2019ll have to define an EC2_REGION environment\nvariable like so (this is due to the error described here: ",(0,i.jsx)(n.a,{href:"https://github.com/ansible/molecule/issues/1570",children:"https://github.com/ansible/molecule/issues/1570"}),"):"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"export EC2_REGION=\u201dus-west-2\u201d"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Molecule also assumes that the user you\u2019ll be using the log in to your EC2 instance is \u201cubuntu\u201d by default. With Amazon\nLinux 2 and a number of other distros, this will actually be \u201cec2-user\u201d. This means you\u2019ll have to fix this. You can\nfind this in ",(0,i.jsx)(n.code,{children:"molecule/scenario_name/create.yml"}),"; look for the \u201cssh_user\u201d variable and change that to what it needs to\nbe for your AMI."]}),"\n",(0,i.jsxs)(n.p,{children:["In addition, you\u2019ll also need to provide credentials. I used aws-vault, but I didn\u2019t want to preface ",(0,i.jsx)(n.em,{children:"all"})," Molecule\ncommands with aws-vault, so when I ran it, I just prefaced each of my Molecule commands with aws-vault like this\nexample:"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"aws-vault exec my_aws_profile -- molecule check"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"running-molecule-tests",children:"Running Molecule Tests"}),"\n",(0,i.jsx)(n.p,{children:"You can run Molecule tests all at once or in stages; these are all done with the various subcommands. The ones I ended\nup using the most were:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"create"}),": This creates the docker container, EC2 instance, or what have you, to allow for further testing."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"converge"}),": This attempts to converge the playbook against the created test environment."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"verify"}),": This runs the tests you\u2019ve written in, say, Test-infra (more on that a little later). Obviously, if you do\nthis without converging first, they will likely fail."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"destroy"}),": This tears down the created test environment; it\u2019s especially important to do in EC2 so you don\u2019t leave\nyour instances lying around."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"test"}),": This runs the entire test sequence. This includes everything above plus things like linting and an idempotence\ncheck (if you run a converge after a converge, is there anything to do?). It will destroy the test environment as its\nlast step, so if you want to iterate on an environment, you probably don\u2019t want to use this right away."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["By default, you don\u2019t get a ton of output about the state of your tests -- just a binary yes/no on success for the most\npart. If you want more information, you can run with ",(0,i.jsx)(n.code,{children:"--debug"}),", which will give you plenty of output. When running\nMolecule in EC2 I also used ",(0,i.jsx)(n.code,{children:"--debug"})," to find where Molecule was putting the ssh-key it was generating for its test\ninstances so I could poke around in them when something wasn\u2019t working."]}),"\n",(0,i.jsx)(n.h2,{id:"writing-tests-in-molecule",children:"Writing Tests in Molecule"}),"\n",(0,i.jsxs)(n.p,{children:["By default, Molecule is not testing anything other than the accuracy of your Ansible code -- is it written right and\ndoes it run without generating errors. This doesn\u2019t tell you if it\u2019s actually doing what you want it to, though. For\nthat, you\u2019ll need to write additional tests. By default, these use Test-Infra\n(",(0,i.jsx)(n.a,{href:"https://testinfra.readthedocs.io/en/latest/",children:"https://testinfra.readthedocs.io/en/latest/"}),"); you\u2019ll put these in the ",(0,i.jsx)(n.code,{children:"molecule/scenario_name/tests"})," directory. You\nshould see a ",(0,i.jsx)(n.code,{children:"test_default.py"})," file there already; this test is an example that just makes sure the ",(0,i.jsx)(n.code,{children:"/etc/hosts"})," file\nand root user exist, which is a bare minimum for things to actually work."]}),"\n",(0,i.jsx)(n.p,{children:"Writing tests for your role is going to depend a lot on what your role is supposed to do. Test-Infra is configured just\nby writing Python functions and making assertions; you\u2019ll need to read their docs in order to know how to test what you\nwant to."}),"\n",(0,i.jsx)(n.p,{children:"Molecule does support other verifiers such as Goss and Inspec; see the Molecule docs for more information if you\u2019d like\nto use these."})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);