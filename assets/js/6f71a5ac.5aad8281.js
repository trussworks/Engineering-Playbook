"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[1613],{3517:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"infrasec/terraform/terratest","title":"Terratest Guide","description":"Terratest is a Go framework that is used to test Terraform infrastructure code.","source":"@site/docs/infrasec/terraform/terratest.md","sourceDirName":"infrasec/terraform","slug":"/infrasec/terraform/terratest","permalink":"/docs/infrasec/terraform/terratest","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/terraform/terratest.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"terraform state mv in Delicate Circumstances","permalink":"/docs/infrasec/terraform/terraform-state-mv"},"next":{"title":"Tutorials","permalink":"/docs/infrasec/tutorials/"}}');var n=r(4848),o=r(8453);const i={},a="Terratest Guide",c={},l=[{value:"Basic Terratest example of a module",id:"basic-terratest-example-of-a-module",level:2},{value:"Other Examples",id:"other-examples",level:3},{value:"Run manually",id:"run-manually",level:2},{value:"Configure CircleCi to run the tests automatically",id:"configure-circleci-to-run-the-tests-automatically",level:2},{value:"Configure CircleCi Job",id:"configure-circleci-job",level:3},{value:"Update the Key rotator configuration",id:"update-the-key-rotator-configuration",level:3},{value:"Alternative: Configure AWS Keys for the CircleCI project",id:"alternative-configure-aws-keys-for-the-circleci-project",level:3},{value:"Access test metadata stored in CircleCI",id:"access-test-metadata-stored-in-circleci",level:3},{value:"Documentation links",id:"documentation-links",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"terratest-guide",children:"Terratest Guide"})}),"\n",(0,n.jsx)(t.p,{children:"Terratest is a Go framework that is used to test Terraform infrastructure code.\nIt executes the defined Terraform and then validates things you're asserting."}),"\n",(0,n.jsx)(t.h2,{id:"basic-terratest-example-of-a-module",children:"Basic Terratest example of a module"}),"\n",(0,n.jsxs)(t.p,{children:["The most basic Terratest test you can write brings up an example in your ",(0,n.jsx)(t.code,{children:"examples"})," directory, tears it down, and will only test that it runs.\nWe've got some basics in the ",(0,n.jsx)(t.a,{href:"https://github.com/trussworks/terraform-module-template",children:"terraform-template-module repo"})," so you can see it all in context."]}),"\n",(0,n.jsxs)(t.p,{children:["Write an example in the ",(0,n.jsx)(t.code,{children:"examples"})," directory that includes the module(s) and configuration that you're testing. In the ",(0,n.jsx)(t.code,{children:"tests"})," directory create a file named ",(0,n.jsx)(t.code,{children:"terraform_aws<NAME_OF_MODULE>_test.go"}),". Basic test is as follows:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-go",children:'package test\n\nimport (\n    "fmt"\n    "strings"\n    "testing"\n\n    "github.com/gruntwork-io/terratest/modules/random"\n    "github.com/gruntwork-io/terratest/modules/terraform"\n    test_structure "github.com/gruntwork-io/terratest/modules/test-structure"\n)\n\nfunc TestTerraformAwsEcrRepo(t *testing.T) {\n    t.Parallel()\n\n    tempTestFolder := test_structure.CopyTerraformFolderToTemp(t, "../", "examples/simple")\n\n    testName := fmt.Sprintf("terratest-%s", strings.ToLower(random.UniqueId()))\n    awsRegion := "us-west-2"\n\n    terraformOptions := &terraform.Options{\n        // The path to where our Terraform code is located\n        TerraformDir: tempTestFolder,\n\n        // Variables to pass to our Terraform code using -var options\n        Vars: map[string]interface{}{\n            "test_name": testName,\n        },\n\n        // Environment variables to set when running Terraform\n        EnvVars: map[string]string{\n            "AWS_DEFAULT_REGION": awsRegion,\n        },\n    }\n\n    defer terraform.Destroy(t, terraformOptions)\n    terraform.InitAndApply(t, terraformOptions)\n\n}\n\n'})}),"\n",(0,n.jsx)(t.h3,{id:"other-examples",children:"Other Examples"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/trussworks/terraform-aws-alb-web-containers",children:"terraform-aws-alb-web-containers"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/trussworks/terraform-aws-ecs-service",children:"terrraform-aws-ecs-service"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/trussworks/terraform-aws-logs/",children:"terraform-aws-logs"})}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"run-manually",children:"Run manually"}),"\n",(0,n.jsxs)(t.p,{children:["To run these tests manually against the ",(0,n.jsx)(t.code,{children:"trussworks-ci"})," AWS account you'll need AWS access in our AWS organization. You'll need help from someone in #infrasec and must follow the ",(0,n.jsx)(t.a,{href:"https://github.com/trussworks/legendary-waddle/blob/master/docs/how-to/setup-new-user.md#setup-new-iam-user",children:"setup instructions"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["You'll also need to install ",(0,n.jsx)(t.code,{children:"aws-vault"})," and ensure your ",(0,n.jsx)(t.code,{children:"./aws/config"})," file is setup correctly."]}),"\n",(0,n.jsxs)(t.p,{children:["In most of our modules, there is a ",(0,n.jsx)(t.code,{children:"makefile"})," that defines ",(0,n.jsx)(t.code,{children:"test"})," so you'll run the following from the root of the repo you're testing:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-sh",children:"AWS_VAULT_KEYCHAIN_NAME=login aws-vault exec trussworks-ci -- make test\n"})}),"\n",(0,n.jsx)(t.h2,{id:"configure-circleci-to-run-the-tests-automatically",children:"Configure CircleCi to run the tests automatically"}),"\n",(0,n.jsx)(t.h3,{id:"configure-circleci-job",children:"Configure CircleCi Job"}),"\n",(0,n.jsxs)(t.p,{children:["Add a job to the ",(0,n.jsx)(t.code,{children:".circleci/config"})," file in the repository:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:'terratest:\n    docker:\n    - auth:\n        password: $DOCKER_PASSWORD\n        username: $DOCKER_USERNAME\n      image: *circleci_docker\n      environment:\n        - TEST_RESULTS: /tmp/test-results\n    steps:\n    - checkout\n    - restore_cache:\n        keys:\n        - pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}\n        - go-mod-sources-v1-{{ checksum "go.sum" }}\n    - run:\n        command: |\n          temp_role=$(aws sts assume-role --role-arn arn:aws:iam::313564602749:role/circleci --role-session-name circleci)\n          export AWS_ACCESS_KEY_ID=$(echo $temp_role | jq .Credentials.AccessKeyId | xargs)\n          export AWS_SECRET_ACCESS_KEY=$(echo $temp_role | jq .Credentials.SecretAccessKey | xargs)\n          export AWS_SESSION_TOKEN=$(echo $temp_role | jq .Credentials.SessionToken | xargs)\n          make test\n        name: Assume role, run pre-commit and run terratest\n    - save_cache:\n        key: pre-commit-dot-cache-{{ checksum ".pre-commit-config.yaml" }}\n        paths:\n        - ~/.cache/pre-commit\n    - save_cache:\n        key: go-mod-sources-v1-{{ checksum "go.sum" }}\n        paths:\n        - ~/go/pkg/mod\n    - store_test_results:\n        path: /tmp/test-results/gotest\n'})}),"\n",(0,n.jsxs)(t.p,{children:["You'll either create a new workflow or add this job to an existing ",(0,n.jsx)(t.code,{children:"workflow"})," definition to be run on every commit/push etc."]}),"\n",(0,n.jsx)(t.h3,{id:"update-the-key-rotator-configuration",children:"Update the Key rotator configuration"}),"\n",(0,n.jsx)(t.p,{children:"We have automation in place that updates the AWS Access Keys used by CircleCI daily so you'll need to add this repo to rotator configuration if it is running Terratests against the trussworks-ci AWS account ."}),"\n",(0,n.jsxs)(t.p,{children:["Update the ",(0,n.jsx)(t.code,{children:"rotate.yaml"})," file in ",(0,n.jsx)(t.a,{href:"https://github.com/trussworks/legendary-waddle",children:"Legendary Waddle"})," to include a sink to your new repo. A sink stanza looks like this:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"      - kind: CircleCI\n        key_to_name:\n          accessKeyId: AWS_ACCESS_KEY_ID\n          secretAccessKey: AWS_SECRET_ACCESS_KEY\n        account: trussworks\n        repo: <REPO NAME>\n"})}),"\n",(0,n.jsxs)(t.p,{children:["You can run the rotator script manually in your local environment to populate the keys to your repository. To do so, you will need a personal API token set up in a ",(0,n.jsx)(t.code,{children:".envrc.local"})," file in your local environment. See the ",(0,n.jsx)(t.a,{href:"https://circleci.com/docs/2.0/managing-api-tokens/",children:"CircleCI Documentation"})," on creating a personal API token."]}),"\n",(0,n.jsx)(t.p,{children:"Rotate the keys via"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"aws-vault exec trussworks-id -- rotator rotate -f ./rotate.yaml -y\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Instructions to install rotator can be found ",(0,n.jsx)(t.a,{href:"https://github.com/chanzuckerberg/rotator",children:"here"}),"."]}),"\n",(0,n.jsx)(t.h3,{id:"alternative-configure-aws-keys-for-the-circleci-project",children:"Alternative: Configure AWS Keys for the CircleCI project"}),"\n",(0,n.jsxs)(t.p,{children:["These tests are running as the ",(0,n.jsx)(t.code,{children:"circleci"})," user account configured in the ",(0,n.jsx)(t.code,{children:"trussworks-id"})," account."]}),"\n",(0,n.jsxs)(t.p,{children:["To add the access keys go to the project settings page ",(0,n.jsx)(t.code,{children:"https://circleci.com/gh/trussworks/<PROJECT NAME>/edit#env-vars"}),".\nSet ",(0,n.jsx)(t.code,{children:"AWS_ACCESS_KEY_ID"})," and ",(0,n.jsx)(t.code,{children:"AWS_SECRET_ACCESS_KEY"})," to the current values.\nThese keys are rotated daily."]}),"\n",(0,n.jsx)(t.h3,{id:"access-test-metadata-stored-in-circleci",children:"Access test metadata stored in CircleCI"}),"\n",(0,n.jsxs)(t.p,{children:["In order to access the test metadata we stored in the ",(0,n.jsx)(t.a,{href:"https://circleci.com/docs/2.0/collect-test-data/",children:(0,n.jsx)(t.code,{children:"store_test_results"})})," key of our ",(0,n.jsx)(t.code,{children:".circleci/config"})," test environment, we'll need to make a few tweaks. This will allow us luxuries such as pinpointing flaky tests that cause intermittent failures."]}),"\n",(0,n.jsxs)(t.p,{children:["Since CircleCI only reads metadata in xml format, first we need to convert our ",(0,n.jsx)(t.code,{children:"go test output"})," into a file CircleCI can read. We'll use package ",(0,n.jsx)(t.a,{href:"https://github.com/jstemmer/go-junit-report",children:(0,n.jsx)(t.code,{children:"go-junit-report"})}),". Add a bash script like so, following the ",(0,n.jsx)(t.a,{href:"https://github.com/jstemmer/go-junit-report/blob/master/README.md",children:"usage directions"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'#!/usr/bin/env bash\n\nset -eu -o pipefail\n\ngo_test_output="/tmp/go-test.out"\n\ngo test -short -count 1 -v -timeout 90m github.com/trussworks/terraform-aws-logs/test/... | tee "${go_test_output}"\n\n# Check if we are running tests inside of CircleCI by checking for a $CIRCLECI\n# environment variable. The dash after $CIRCLECI substitutes a null value if\n# CIRCLECI is unset. This prevents unbound variable errors\nif [[ -n ${CIRCLECI-} ]]; then\n    mkdir -p "${TEST_RESULTS}"/gotest\n    go-junit-report < "${go_test_output}" \\\n                    > "${TEST_RESULTS}/gotest/go-test-report.xml"\nfi\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Save this script with a filename like ",(0,n.jsx)(t.code,{children:"make-test"})," and make it executable using ",(0,n.jsx)(t.code,{children:"chmod +x make-test"}),". Now we'll add a call to the executable in our Makefile like so:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:".PHONY: test\ntest: bin/make-test\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Finally we update our ",(0,n.jsx)(t.code,{children:".circleci/config"})," by adding two steps prior to running terratest - one to ",(0,n.jsx)(t.code,{children:"go get"})," the package and another to access our shiny new executable:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"    - run:\n        name: Adding go binaries to $PATH\n        command: |\n          echo 'export PATH=${PATH}:~/go/bin' >> $BASH_ENV\n          source $BASH_ENV\n    - run: go get github.com/jstemmer/go-junit-report\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now we should be able to see both the tests and artifacts tabs in our CircleCI pipeline:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"CircleCI Tabs",src:r(6333).A+"",title:"CircleCI Tabs",width:"491",height:"250"})}),"\n",(0,n.jsx)(t.h2,{id:"documentation-links",children:"Documentation links"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/gruntwork-io/terratest",children:"Terratest repo"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://terratest.gruntwork.io/docs/",children:"Official Terratest Documentation"})}),"\n"]})]})}function u(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},6333:(e,t,r)=>{r.d(t,{A:()=>s});const s=r.p+"assets/images/circleci_tabs-e8b1e17ad53388fc9af3b998764d2bfa.png"},8453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>a});var s=r(6540);const n={},o=s.createContext(n);function i(e){const t=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);