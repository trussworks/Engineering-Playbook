"use strict";(self.webpackChunkengineering_playbook=self.webpackChunkengineering_playbook||[]).push([[1016],{3905:(e,r,t)=>{t.d(r,{Zo:()=>p,kt:()=>c});var o=t(7294);function a(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function n(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?n(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):n(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function s(e,r){if(null==e)return{};var t,o,a=function(e,r){if(null==e)return{};var t,o,a={},n=Object.keys(e);for(o=0;o<n.length;o++)t=n[o],r.indexOf(t)>=0||(a[t]=e[t]);return a}(e,r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(o=0;o<n.length;o++)t=n[o],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=o.createContext({}),u=function(e){var r=o.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},p=function(e){var r=u(e.components);return o.createElement(l.Provider,{value:r},e.children)},m={inlineCode:"code",wrapper:function(e){var r=e.children;return o.createElement(o.Fragment,{},r)}},h=o.forwardRef((function(e,r){var t=e.components,a=e.mdxType,n=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=u(t),c=a,f=h["".concat(l,".").concat(c)]||h[c]||m[c]||n;return t?o.createElement(f,i(i({ref:r},p),{},{components:t})):o.createElement(f,i({ref:r},p))}));function c(e,r){var t=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var n=t.length,i=new Array(n);i[0]=h;var s={};for(var l in r)hasOwnProperty.call(r,l)&&(s[l]=r[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var u=2;u<n;u++)i[u]=t[u];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}h.displayName="MDXCreateElement"},8439:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>n,metadata:()=>s,toc:()=>u});var o=t(7462),a=(t(7294),t(3905));t(8209);const n={},i="Terraform",s={unversionedId:"infrasec/terraform/README",id:"infrasec/terraform/README",title:"Terraform",description:"Overview",source:"@site/docs/infrasec/terraform/README.md",sourceDirName:"infrasec/terraform",slug:"/infrasec/terraform/",permalink:"/docs/infrasec/terraform/",draft:!1,editUrl:"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/terraform/README.md",tags:[],version:"current",frontMatter:{},sidebar:"practices",previous:{title:"Project Teardown Guide",permalink:"/docs/infrasec/teardown"},next:{title:"Atlantis",permalink:"/docs/infrasec/terraform/atlantis"}},l={},u=[{value:"Overview",id:"overview",level:2},{value:"Semantic Versioning",id:"semantic-versioning",level:3},{value:"Starting a module experiment",id:"starting-a-module-experiment",level:3},{value:"Splitting a git repo",id:"splitting-a-git-repo",level:3},{value:"Going public",id:"going-public",level:3},{value:"Publishing a release",id:"publishing-a-release",level:3},{value:"Updating a module for a new version of Terraform",id:"updating-a-module-for-a-new-version-of-terraform",level:3},{value:"Version support policy",id:"version-support-policy",level:3},{value:"Version not appearing in the registry",id:"version-not-appearing-in-the-registry",level:3},{value:"Terraform state mv",id:"terraform-state-mv",level:3},{value:"Terraform import",id:"terraform-import",level:3},{value:"How to layout/structure a Terraform Project",id:"how-to-layoutstructure-a-terraform-project",level:3},{value:"How to test your Terraform code",id:"how-to-test-your-terraform-code",level:3}],p={toc:u};function m(e){let{components:r,...t}=e;return(0,a.kt)("wrapper",(0,o.Z)({},p,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"terraform"},"Terraform"),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Terraform is our tool of choice for automating our 'cloud infrastructure'. In particular, we expect all but the earliest of prototype ",(0,a.kt)("a",{parentName:"p",href:"/docs/infrasec/aws/"},"AWS")," resources to be created/deployed using terraform rather than by hand."),(0,a.kt)("p",null,"If you're new to Terraform, you can find a very useful resource for beginners\nfrom HashiCorp's Learning platform."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/terraform/tutorials/aws-get-started"},"\u27a1\ufe0f  Read ",(0,a.kt)("strong",{parentName:"a"},"Get Started - AWS")," HashiCorp Learning using Terraform.")),(0,a.kt)("h3",{id:"semantic-versioning"},"Semantic Versioning"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"When publishing a module for the first time, if you're uncertain what version to use, use ",(0,a.kt)("inlineCode",{parentName:"li"},"v1.0.0")),(0,a.kt)("li",{parentName:"ul"},"Any changes to a module that don't result in a resource being recreated, increment the ",(0,a.kt)("em",{parentName:"li"},"patch")," version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,a.kt)("li",{parentName:"ul"},"Any changes to a module that results in a resource being recreated, increment the ",(0,a.kt)("em",{parentName:"li"},"minor")," version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,a.kt)("li",{parentName:"ul"},"Any changes to support GovCloud that do not result in changes to resources, increment the ",(0,a.kt)("em",{parentName:"li"},"minor")," version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,a.kt)("li",{parentName:"ul"},"Any changes that results in a user having to update the module, increment the ",(0,a.kt)("em",{parentName:"li"},"major")," version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,a.kt)("li",{parentName:"ul"},"Upgrading a module from \\<0.12 to 0.12, increment the ",(0,a.kt)("em",{parentName:"li"},"major")," version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines.")),(0,a.kt)("h3",{id:"starting-a-module-experiment"},"Starting a module experiment"),(0,a.kt)("p",null,"..."),(0,a.kt)("h3",{id:"splitting-a-git-repo"},"Splitting a git repo"),(0,a.kt)("p",null,"We often start out with Terraform code embedded into the infrastructure for a specific project before we decide we want to publish a chunk of it as stand-alone module. When moving code from one git repository to another, it is useful to maintain the revision history. To split a git repository while preserving the history, see ",(0,a.kt)("a",{parentName:"p",href:"/docs/developing/vcs/git-repos"},"this page")," in the Engineering Playbook."),(0,a.kt)("p",null,"Once the Terraform code has been split into a separate repo, you can add the usual trimmings for a Terraform module: README, pre-commit/CircleCI configuration, terratest(s), etc."),(0,a.kt)("p",null,"Before going public, consider sourcing the module from github as described in the ",(0,a.kt)("a",{parentName:"p",href:"https://www.terraform.io/docs/modules/sources.html"},"sources")," documentation to confirm that no changes are planned after the migration."),(0,a.kt)("h3",{id:"going-public"},"Going public"),(0,a.kt)("p",null,"When you're ready to turn the prototype module into a published one, there are a few things you'll need to do if you haven't already:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"\ud83d\udd12 Add a subscription to your repo in our ",(0,a.kt)("a",{parentName:"li",href:"https://trussworks.slack.com/messages/C91SHMKFV/"},"#infra-feed")," channel:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/github subscribe trussworks/your-repo-here")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"/github unsubscribe trussworks/your-repo-here commits deployments releases")))),(0,a.kt)("li",{parentName:"ol"},"Wire the repo up to the ",(0,a.kt)("a",{parentName:"li",href:"https://registry.terraform.io"},"terraform module registry"),".",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"First read through the Terraform docs on ",(0,a.kt)("a",{parentName:"li",href:"https://www.terraform.io/docs/registry/modules/publish.html"},"Publishing Modules")," and make appropriate changes to your repository"),(0,a.kt)("li",{parentName:"ul"},"Ensure that the module you wish to publish has a SemVer tag attached to it. If not use ",(0,a.kt)("inlineCode",{parentName:"li"},"v1.0.0"),"."),(0,a.kt)("li",{parentName:"ul"},"Sign into the registry using the trussworks-infra Github credentials (available in 1Password)"),(0,a.kt)("li",{parentName:"ul"},'In the upper right corner select "Publish" or go directly to the ',(0,a.kt)("a",{parentName:"li",href:"https://registry.terraform.io/github/create"},"Publish URL")),(0,a.kt)("li",{parentName:"ul"},"Select the repository you wish to publish from the drop down list. If you don't see it hit the refresh icon."),(0,a.kt)("li",{parentName:"ul"},'Select the "Publish Module" button.'),(0,a.kt)("li",{parentName:"ul"},"Verify on the next screen that everything you expect to see is correct.")))),(0,a.kt)("h3",{id:"publishing-a-release"},"Publishing a release"),(0,a.kt)("p",null,"To publish a release from a terraform module that's already connected to the ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io"},"terraform module registry"),", all you need to do after your PR merges is:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},'From the releases tab, click the "Draft a release" button.'),(0,a.kt)("li",{parentName:"ol"},"Add a meaningful description."),(0,a.kt)("li",{parentName:"ol"},"Increment the package version per ",(0,a.kt)("a",{parentName:"li",href:"https://semver.org/"},"semantic versioning")," guidelines."),(0,a.kt)("li",{parentName:"ol"},'Click the "Publish release" button.')),(0,a.kt)("p",null,"You don't need to add any binary files. GitHub will do this automatically for you."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"images/draft-release.png",alt:"Screenshot of a release draft",title:"Screenshot of a release draft"})),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"images/publish-release.png",alt:"Screenshot of a published release",title:"Screenshot of a published release"})),(0,a.kt)("h3",{id:"updating-a-module-for-a-new-version-of-terraform"},"Updating a module for a new version of Terraform"),(0,a.kt)("p",null,"In order to preserve the ability to release updates for previous Terraform versions, when you update a module to support a new version, you should cut a separate branch we can use to publish updates for the old version. Follow this procedure:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Compose your PR for the module updating it to the new version of Terraform and get it approved."),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("em",{parentName:"li"},"Before you merge"),", create a branch off the ",(0,a.kt)("em",{parentName:"li"},"current")," default branch named after the previous Terraform version (for instance, if the old version is 0.11, create a ",(0,a.kt)("inlineCode",{parentName:"li"},"terraform011")," branch) and push it to origin."),(0,a.kt)("li",{parentName:"ol"},'Add a note to the README in your PR that describes which major version of the module supports which version of Terraform and which branch to submit a PR to for each (e.g., "For Terraform 0.12, pin the module version to ',(0,a.kt)("inlineCode",{parentName:"li"},"~> 2.0"),". Submit pull requests to the default branch. For Terraform 0.11, pin the module version to ",(0,a.kt)("inlineCode",{parentName:"li"},"~> 1.0"),". Submit pull requests to the ",(0,a.kt)("inlineCode",{parentName:"li"},"terraform011"),' branch.")'),(0,a.kt)("li",{parentName:"ol"},"Merge your changes in to the module's default branch."),(0,a.kt)("li",{parentName:"ol"},"Cut a new release as described above. Increment the ",(0,a.kt)("em",{parentName:"li"},"major")," version of the module as you described in the README.")),(0,a.kt)("h3",{id:"version-support-policy"},"Version support policy"),(0,a.kt)("p",null,'Truss policy is to support no more than 2 "current" versions of a\nTerraform module; this usually means a version to support the latest\nrelease of Terraform and the previous release, e.g. Terraform 1.0 and\nTerraform 0.15.'),(0,a.kt)("h3",{id:"version-not-appearing-in-the-registry"},"Version not appearing in the registry"),(0,a.kt)("p",null,"If a release published in GitHub does not appear properly in the Terraform registry, see ",(0,a.kt)("a",{parentName:"p",href:"https://www.terraform.io/docs/registry/modules/publish.html#releasing-new-versions"},"Releasing New Versions")," for instructions on how to address."),(0,a.kt)("p",null,"If the steps outlined in the above link do not work, try publishing a new patch release with the same commit id."),(0,a.kt)("h3",{id:"terraform-state-mv"},"Terraform state mv"),(0,a.kt)("p",null,"Refer to the Truss ",(0,a.kt)("a",{parentName:"p",href:"/docs/infrasec/terraform/terraform-state-mv"},(0,a.kt)("inlineCode",{parentName:"a"},"terraform state mv")," info sheet"),"."),(0,a.kt)("h3",{id:"terraform-import"},"Terraform import"),(0,a.kt)("p",null,"Refer to the Truss ",(0,a.kt)("a",{parentName:"p",href:"/docs/infrasec/terraform/terraform-import"},(0,a.kt)("inlineCode",{parentName:"a"},"terraform import")," info sheet"),"."),(0,a.kt)("h3",{id:"how-to-layoutstructure-a-terraform-project"},"How to layout/structure a Terraform Project"),(0,a.kt)("p",null,"Refer to the Truss ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/trussworks/terraform-layout-example"},"Terraform Layout Example"),"."),(0,a.kt)("h3",{id:"how-to-test-your-terraform-code"},"How to test your Terraform code"),(0,a.kt)("p",null,"Refer to the Truss ",(0,a.kt)("a",{parentName:"p",href:"/docs/infrasec/terraform/terratest"},"Terratest Guide"),"."))}m.isMDXComponent=!0},8209:(e,r,t)=>{t(7294)}}]);