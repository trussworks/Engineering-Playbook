"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[129],{5214:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>c,default:()=>m,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"infrasec/aws/govcloud/gov-acm","title":"ACM in GovCloud","description":"AWS Certificate Manager (ACM) is our preferred way to handle certificates","source":"@site/docs/infrasec/aws/govcloud/gov-acm.md","sourceDirName":"infrasec/aws/govcloud","slug":"/infrasec/aws/govcloud/gov-acm","permalink":"/docs/infrasec/aws/govcloud/gov-acm","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/aws/govcloud/gov-acm.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"Working in GovCloud","permalink":"/docs/infrasec/aws/govcloud/"},"next":{"title":"Setting Up a GovCloud Organization","permalink":"/docs/infrasec/aws/govcloud/gov-orgs"}}');var i=n(4848),o=n(8453);const r={},c="ACM in GovCloud",s={},l=[{value:"The problem: ACM DNS validation",id:"the-problem-acm-dns-validation",level:2},{value:"The solution: step-by-step creation",id:"the-solution-step-by-step-creation",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"acm-in-govcloud",children:"ACM in GovCloud"})}),"\n",(0,i.jsx)(t.p,{children:"AWS Certificate Manager (ACM) is our preferred way to handle certificates\nin AWS whenever possible. Unfortunately, due to the fact that Route53\ncannot create public DNS entries in GovCloud, the modules which create\nACM certificates and validate them with DNS will not work. This means the\nprocess of creating these certificates becomes slightly more complicated."}),"\n",(0,i.jsx)(t.h2,{id:"the-problem-acm-dns-validation",children:"The problem: ACM DNS validation"}),"\n",(0,i.jsxs)(t.p,{children:["In both the Truss and ",(0,i.jsx)(t.code,{children:"terraform-aws-modules"})," ACM module, the module\nattempts to create three resources:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"the ACM certificate"}),"\n",(0,i.jsx)(t.li,{children:"the Route53 DNS entry to validate the certificate"}),"\n",(0,i.jsxs)(t.li,{children:["the Terraform ",(0,i.jsx)(t.a,{href:"https://www.terraform.io/docs/providers/aws/r/acm_certificate_validation.html",children:(0,i.jsx)(t.code,{children:"aws_acm_certificate_validation"})})," resource"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["It's important to note that the ",(0,i.jsx)(t.code,{children:"aws_acm_certificate_validation"})," resource\ndoes not actually represent a real AWS resource -- it is an internal\nmechanism Terraform uses to correctly order the creation of resources\ndependent on a valid Terraform certificate. It is ",(0,i.jsx)(t.em,{children:"not required"})," to\nactually validate an ACM certificate."]}),"\n",(0,i.jsxs)(t.p,{children:["However, the problem that the ",(0,i.jsx)(t.code,{children:"aws_acm_certificate_validation"})," resource\nwas designed to solve -- preventing Terraform from trying to use an\ninvalid certificate on another resource, like an ALB -- still exists in\nGovCloud. The ACM certificate resource itself ",(0,i.jsx)(t.em,{children:"cannot be used"})," until it\nhas been validated. This means trying to create an ALB using an certificate\nthat has not yet been validated will fail, and in GovCloud, this creates\na timing issue, because we need to create the certificate to get the\nDNS validation information, but we have to create the DNS entry in the\ncommercial organization before we can use it elsewhere in GovCloud."]}),"\n",(0,i.jsx)(t.h2,{id:"the-solution-step-by-step-creation",children:"The solution: step-by-step creation"}),"\n",(0,i.jsxs)(t.p,{children:["We can solve this by using a step-by-step creation method for our systems\nwhich require ACM certificates. We recommend ",(0,i.jsx)(t.em,{children:"not"})," creating these\ncertificates inside modules for your application, but instead providing\nthe certificate as a parameter that resources in your module can use, as\nanything contingent on the successful creation of the certificate will fail\non your first apply of the module if you do include it."]}),"\n",(0,i.jsx)(t.p,{children:"To do this, here's some sample code for the creation of the ACM certificate\nin our GovCloud account:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-hcl",children:'resource "aws_acm_certificate" "acm_myapp" {\n  domain_name       = "myapp.example.com"\n  validation_method = "DNS"\n\n  tags = {\n    Name        = "myapp.example.com"\n    Automation  = "Terraform"\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\noutput "myapp_cert_validation" {\n  description = "Map of data for myapp cert validation"\n  value       = aws_acm_certificate.acm_myapp.domain_validation_options\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"The output is necessary because this is what will provide us the information\nwe need to create the validation DNS entry in our commercial AWS account. It\nwill look like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-terraform",children:'testing_cert_validation = [\n  {\n    "domain_name" = "myapp.example.com"\n    "resource_record_name" = "_42ef3fd691a332acfe219f37910eee14.myapp.example.com."\n    "resource_record_type" = "CNAME"\n    "resource_record_value" = "_31d89bcda5baf24c2518526a81f86617.tfmgdnztqk.acm-validations.aws."\n  },\n]\n'})}),"\n",(0,i.jsx)(t.p,{children:"We can then take that output and create a DNS entry in our commercial DNS\naccount with this code:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-hcl",children:'resource "aws_route53_record" "myapp_acm_validation" {\n  zone_id = aws_route53_zone.myzone.zone_id\n  name    = "_42ef3fd691a332acfe219f37910eee14.myapp.example.com."\n  type    = "CNAME"\n  records = ["_31d89bcda5baf24c2518526a81f86617.tfmgdnztqk.acm-validations.aws."]\n  ttl     = 60\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"Once this entry has been created, you should be able to use your certificate\non other resources within a minute or two. If you want to confirm that the\ncertificate has been validated, you can run these commands in the GovCloud\naccount:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-console",children:'$ aws acm list-certificates\n{\n    "CertificateSummaryList": [\n        {\n            "CertificateArn": "arn:aws:acm:us-west-2:000123456789:certificate/78dca028-1812-4fa5-9c84-b92fdeadbeef",\n            "DomainName": "myapp.example.com"\n        }\n    ]\n}\n\n$ aws acm describe-certificate --certificate-arn "arn:aws:acm:us-west-2:000123456789:certificate/78dca028-1812-4fa5-9c84-b92fdeadbeef"\n{\n    "Certificate": {\n        "CertificateArn": "arn:aws:acm:us-west-2:000123456789:certificate/78dca028-1812-4fa5-9c84-b92fdeadbeef",\n        "DomainName": "myapp.example.com",\n        "SubjectAlternativeNames": [\n            "myapp.example.com"\n        ],\n        "DomainValidationOptions": [\n            {\n                "DomainName": "myapp.example.com",\n                "ValidationDomain": "myapp.example.com",\n                "ValidationStatus": "SUCCESS",\n\n...\n'})}),"\n",(0,i.jsxs)(t.p,{children:["If your ",(0,i.jsx)(t.code,{children:"ValidationStatus"})," is ",(0,i.jsx)(t.code,{children:"SUCCESS"}),", your certificate should be ready to go."]})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>c});var a=n(6540);const i={},o=a.createContext(i);function r(e){const t=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);