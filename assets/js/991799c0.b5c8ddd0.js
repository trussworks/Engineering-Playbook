"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[5574],{2834:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"infrasec/tutorials/circle-ci-honeycomb-integrations","title":"CircleCi Honeycomb Integration","description":"Honeycomb provides CI integrations allowing better instrumentation of builds. One such integration is for CircleCi via an Orb. This document provides a guide for adding Honeycomb instrumentation to CircleCi builds.","source":"@site/docs/infrasec/tutorials/circle-ci-honeycomb-integrations.md","sourceDirName":"infrasec/tutorials","slug":"/infrasec/tutorials/circle-ci-honeycomb-integrations","permalink":"/docs/infrasec/tutorials/circle-ci-honeycomb-integrations","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/tutorials/circle-ci-honeycomb-integrations.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"Tutorials","permalink":"/docs/infrasec/tutorials/"},"next":{"title":"Fix CircleCI Integrations","permalink":"/docs/infrasec/tutorials/fix-circleci-integrations"}}');var o=i(4848),s=i(8453);const r={},c="CircleCi Honeycomb Integration",a={},l=[{value:"Setup",id:"setup",level:2},{value:"CircleCi Repo Changes",id:"circleci-repo-changes",level:2},{value:"Adding Orb",id:"adding-orb",level:3},{value:"Add Dependent Jobs",id:"add-dependent-jobs",level:3},{value:"Update Existing Jobs",id:"update-existing-jobs",level:2},{value:"Verification",id:"verification",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"circleci-honeycomb-integration",children:"CircleCi Honeycomb Integration"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://www.honeycomb.io/",children:"Honeycomb"})," provides CI integrations allowing better instrumentation of builds. One such integration is for CircleCi via an ",(0,o.jsx)(n.a,{href:"https://github.com/honeycombio/buildevents-orb",children:"Orb"}),". This document provides a guide for adding Honeycomb instrumentation to CircleCi builds."]}),"\n",(0,o.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,o.jsx)(n.p,{children:"A few items need to be setup before modifying the repo."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["CircleCI needs to have the following environment variables configured: ",(0,o.jsx)(n.code,{children:"BUILDEVENT_APIKEY"})," and ",(0,o.jsx)(n.code,{children:"BUILDEVENT_CIRCLE_API_TOKEN"}),". These have been populated for the Trussworks CircleCi Organization using the ",(0,o.jsx)(n.code,{children:"org-global"})," context."]}),"\n",(0,o.jsxs)(n.li,{children:["CircleCI also needs a per project environment variable ",(0,o.jsx)(n.code,{children:"BUILDEVENT_DATASET"})," to separate the Honeycomb datasets."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["More information on the environment variables used by the Honeycomb integration can be found ",(0,o.jsx)(n.a,{href:"https://github.com/honeycombio/buildevents#environment-variables",children:"here"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"circleci-repo-changes",children:"CircleCi Repo Changes"}),"\n",(0,o.jsx)(n.h3,{id:"adding-orb",children:"Adding Orb"}),"\n",(0,o.jsx)(n.p,{children:"Add the following to the circleci file"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"orbs:\n  buildevents: honeycombio/buildevents@0.2.7\n"})}),"\n",(0,o.jsx)(n.h3,{id:"add-dependent-jobs",children:"Add Dependent Jobs"}),"\n",(0,o.jsx)(n.p,{children:"The Orb requires two additional jobs."}),"\n",(0,o.jsx)(n.p,{children:"Setup: This job downloads the build events binary and helps setting up the workspace to be instrumented. It should be the first job and all workflow jobs should depend on it."}),"\n",(0,o.jsxs)(n.p,{children:["Watch: This job is a parallel job that polls the CircleCi API using the ",(0,o.jsx)(n.code,{children:"BUILDEVENT_CIRCLE_API_TOKEN"}),'. It is the main trace span and "watches" the build until completion providing top span metrics.']}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"  # Do not forget to add the executor to the below jobs\n  setup:\n    steps:\n      - buildevents/start_trace\n  watch:\n    steps:\n      - buildevents/watch_build_and_finish\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now we'll start to use the new jobs. Here we add in the ",(0,o.jsx)(n.code,{children:"setup"})," and ",(0,o.jsx)(n.code,{children:"watch"})," jobs to happen before the main ",(0,o.jsx)(n.code,{children:"terratest"})," job. Each of these jobs uses the ",(0,o.jsx)(n.code,{children:"org-global"})," context for access to the global environment variables."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"workflows:\n  validate:\n    jobs:\n    - setup:\n        context:\n        - org-global\n    -  watch:\n        context:\n        - org-global\n        requires:\n          - setup\n    - terratest:\n        requires:\n          - setup\n        context:\n        - org-global\n"})}),"\n",(0,o.jsx)(n.h2,{id:"update-existing-jobs",children:"Update Existing Jobs"}),"\n",(0,o.jsx)(n.p,{children:"To add the correct trace information existing jobs will need to be updated with a span. This tells Honeycomb that a particular job will need to be traced."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:" # Sample job before Honeycomb tracing\n terratest:\n    steps:\n    - checkout\n    - restore_cache:\n"})}),"\n",(0,o.jsxs)(n.p,{children:["We can add the span using the Orb's ",(0,o.jsx)(n.code,{children:"with_job_span"}),". It contains a ",(0,o.jsx)(n.code,{children:"step"})," directive for all the build steps."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"terratest:\n    steps:\n      # Here we add the tracing along with redefine the steps for the job\n      - buildevents/with_job_span:\n          steps:\n          - checkout\n          - restore_cache:\n"})}),"\n",(0,o.jsxs)(n.p,{children:["For more advanced tracing the ",(0,o.jsx)(n.a,{href:"https://circleci.com/developer/orbs/orb/honeycombio/buildevents#commands",children:"Orb"})," does provide additional directives for more detailed information such as running commands and pushing custom metrics such as assets sizes."]}),"\n",(0,o.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,o.jsx)(n.p,{children:"When working properly the CircleCI workflow should look like below."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"honeycomb-circleci-workflow",src:i(4102).A+"",width:"1216",height:"220"})}),"\n",(0,o.jsx)(n.p,{children:"In Honeycomb there is a trace id for each build that matches the build id in CircleCi. Viewing the trace for a particular build should display a trace as below."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Honeycomb Trace",src:i(8866).A+"",width:"1354",height:"282"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},4102:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/honeycomb-circleci-workflow-ad9b07c1c094157958a6ad0222e4060a.png"},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>c});var t=i(6540);const o={},s=t.createContext(o);function r(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(s.Provider,{value:n},e.children)}},8866:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/honeycomb-circleci-trace-7417d906858f7205573b24c0e8a7acdd.png"}}]);