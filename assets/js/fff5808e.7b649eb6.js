"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[4697],{2163:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>h,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"developing/nix/HOWTO","title":"NIX HOWTO","description":"This HOWTO assumes you already have nix installed.","source":"@site/docs/developing/nix/HOWTO.md","sourceDirName":"developing/nix","slug":"/developing/nix/HOWTO","permalink":"/docs/developing/nix/HOWTO","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/developing/nix/HOWTO.md","tags":[],"version":"current","frontMatter":{},"sidebar":"about","previous":{"title":"nix","permalink":"/docs/developing/nix/"},"next":{"title":"Open Source","permalink":"/docs/developing/open-source/"}}');var s=i(4848),o=i(8453);const a={},r="NIX HOWTO",h={},d=[{value:"Nix Channels",id:"nix-channels",level:2},{value:"Troubleshooting Git-related errors",id:"troubleshooting-git-related-errors",level:3},{value:"Setting up a new project",id:"setting-up-a-new-project",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"nix-howto",children:"NIX HOWTO"})}),"\n",(0,s.jsx)(n.p,{children:"This HOWTO assumes you already have nix installed."}),"\n",(0,s.jsx)(n.h2,{id:"nix-channels",children:"Nix Channels"}),"\n",(0,s.jsxs)(n.p,{children:["We currently recommend using the ",(0,s.jsx)(n.a,{href:"https://hydra.nixos.org/job/nixpkgs/trunk/unstable",children:"Nix Unstable channel"}),"\nby default as it contains the latest tested updates on a rolling basis. This\nmeans that the branch for the ",(0,s.jsx)(n.a,{href:"https://github.com/NixOS/nixpkgs",children:"NixOS/nixpkgs repository"})," that is\nused is the ",(0,s.jsx)(n.code,{children:"nixpkg-unstable"})," branch."]}),"\n",(0,s.jsx)(n.h3,{id:"troubleshooting-git-related-errors",children:"Troubleshooting Git-related errors"}),"\n",(0,s.jsxs)(n.p,{children:["In the step above, you may need to modify the ",(0,s.jsx)(n.code,{children:'ref="{BRANCH_NAME}";'})," line\nwith the ",(0,s.jsx)(n.code,{children:"master"})," branch for the ",(0,s.jsx)(n.a,{href:"https://github.com/NixOS/nixpkgs",children:"NixOS/nixpkgs repository"})," if you\nencounter any Git-related errors."]}),"\n",(0,s.jsxs)(n.p,{children:["Trussels using Nix for package management have run into issues related to\ncommits not being found on that specific ",(0,s.jsx)(n.code,{children:"nixpkgs-unstable"})," branch. The\n",(0,s.jsx)(n.a,{href:"https://ahobson.github.io/nix-package-search/#/",children:"nix-package-search"})," will report the ",(0,s.jsx)(n.code,{children:"ref"})," to be\n",(0,s.jsx)(n.code,{children:"nixpkgs-unstable"})," but the actual commit may not exist on that branch due to\nintegration errors within the ",(0,s.jsx)(n.a,{href:"https://github.com/NixOS/nixpkgs",children:"NixOS/nixpkgs repository"})," that\neventually may correct itself."]}),"\n",(0,s.jsxs)(n.p,{children:["To read up on Nix Channels, see ",(0,s.jsx)(n.a,{href:"https://nixos.wiki/wiki/Nix_channels",children:"their documentation"}),".\nWhile the branch ",(0,s.jsx)(n.code,{children:"nixpkgs-unstable"})," specifically lags behind ",(0,s.jsx)(n.code,{children:"master"})," to\nthoroughly test things, some of our Truss projects are required to be\nup-to-date. This means that we may need to update some ",(0,s.jsx)(n.code,{children:'ref="";'})," sections of\nthe Import statement to point to ",(0,s.jsx)(n.code,{children:"master"})," to upgrade or downgrade a single\npackage in order to maintain our obligations to keep our dependencies\nup-to-date."]}),"\n",(0,s.jsx)(n.h2,{id:"setting-up-a-new-project",children:"Setting up a new project"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:"nix"})," directory"]}),"\n",(0,s.jsxs)(n.p,{children:["mkdir -p ",(0,s.jsx)(n.code,{children:"./nix"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create ",(0,s.jsx)(n.code,{children:"nix/update.sh"})," with the content below and make the script\nexecutable"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'#!/usr/bin/env bash\n\nset -euo pipefail\n\nif [ -z "${NIX_PROFILE+x}" ]; then\n  echo "NIX_PROFILE not set, not installing globally"\n  echo "Try running \'direnv allow\'"\n  exit 1\nfi\n\n# Having NIX_SSL_CERT_FILE set means go won\'t use macOS keychain based certs\n# MOST projects can leave this alone, but if you unset it in `.envrc`\n# be sure to uncomment the following line\n# export NIX_SSL_CERT_FILE=$HOME/.nix-profile/etc/ssl/certs/ca-bundle.crt\n\nDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"\n# install packages\nnix-env -f "${DIR}" -i\n# Store a hash of this file to the hash of the nix profile\n# This way if the config changes, we can warn about it via direnv\n# See the nix config in .envrc\nconfig_hash=$(nix-hash "${DIR}")\nstore_hash=$(nix-store -q --hash "${NIX_PROFILE}")\necho "${config_hash}-${store_hash}" > "${DIR}/../.nix-hash"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:"nix/default.nix"})," that looks like the below, but replace\n",(0,s.jsx)(n.code,{children:"_YOUR_PROJECT_NAME_"})," with the name of your project"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'let\n  pkgs = import <nixpkgs> {};\n  inherit (pkgs) buildEnv;\nin buildEnv {\n  name = "_YOUR_PROJECT_NAME_-packages";\n  paths = [\n  ];\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create/add to your ",(0,s.jsx)(n.code,{children:".envrc"})," with the following, replacing ",(0,s.jsx)(n.code,{children:"_YOUR_PROJECT_NAME_"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# if nix is installed, use it\nif [ ! -r .nix-disable  ] && has nix-env; then\n  # set NIX_PROFILE so nix-env operations don\'t need to manually\n  # specify the profile path\n  export NIX_PROFILE="/nix/var/nix/profiles/per-user/${LOGNAME}/_YOUR_PROJECT_NAME_"\n\n  # Having NIX_SSL_CERT_FILE set means go won\'t use macOS keychain\n  # based certs\n  # MOST projects can leave this set, but if you are using go and\n  # custom certificates, you might need to futz with this\n  # export NIX_SSL_CERT_FILE_ORIG=$NIX_SSL_CERT_FILE\n  # unset NIX_SSL_CERT_FILE\n\n  nix_dir="nix"\n  # add the nix files so that if they change, direnv needs to be reloaded\n  watch_file "${nix_dir}"/*.nix\n  config_hash=$(nix-hash "${nix_dir}")\n  store_hash=$(nix-store -q --hash "${NIX_PROFILE}")\n\n  # The .nix-hash file is created by nix/update.sh\n  if [ ! -r .nix-hash ] || ! grep -q "${config_hash}-${store_hash}" .nix-hash; then\n    log_status "WARNING: nix packages out of date. Run ${nix_dir}/update.sh"\n  fi\n\n  # add the NIX_PROFILE bin path so that everything we just installed\n  # is available on the path\n  PATH_add ${NIX_PROFILE}/bin\n\n  # If you use go, add this\n  #\n  # nix is immutable, so we need to specify a path for local changes, e.g.\n  # binaries can be installed local to this project\n  export GOPATH=$PWD/.gopath\n  PATH_add ./.gopath/bin\n\n  # If you use node, add this\n  #\n  PATH_add ./node_modules/.bin\n  export NPM_CONFIG_PREFIX=$PWD/.npmglobal\n  PATH_add ./.npmglobal/bin\n\nfi\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.a,{href:"https://ahobson.github.io/nix-package-search/#/",children:"nix-package-search"})," to find your package\nversions and add them to your ",(0,s.jsx)(n.code,{children:"nix/default.nix"})," in the ",(0,s.jsx)(n.code,{children:"paths"})," section. Your\nnew ",(0,s.jsx)(n.code,{children:"default.nix"})," might look something like (with NAME replaced with your\nproject)"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'let\n  pkgs = import <nixpkgs> {};\n  inherit (pkgs) buildEnv;\nin buildEnv {\n  name = "_YOUR_PROJECT_NAME_-packages";\n  paths = [\n\n    (import (builtins.fetchGit {\n      # Descriptive name to make the store path easier to identify\n      name = "nodejs-14.17.0";\n      url = "https://github.com/NixOS/nixpkgs/";\n      ref = "refs/heads/nixpkgs-unstable";\n      rev = "b65a64086f8c136545955d447e1918b97dad02af";\n    }) {}).nodejs-14_x\n  ];\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"direnv allow"})," to set up the new environment variables"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Run ",(0,s.jsx)(n.code,{children:"./nix/update.sh"})," to install the packages. It might take a\nwhile the first time and there isn't a progress bar or anything to\nlet you know it's working"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"When the update script finishes, you are ready to go"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["You can then update ",(0,s.jsx)(n.code,{children:"nix/default.nix"})," when you need to add/update\npackages and then ",(0,s.jsx)(n.code,{children:"direnv"})," will let you know your packages are out\nof date and you need to run ",(0,s.jsx)(n.code,{children:"./nix/update.sh"})]}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var t=i(6540);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);