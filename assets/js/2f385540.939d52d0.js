"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[9820],{8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var s=i(6540);const l={},o=s.createContext(l);function r(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),s.createElement(o.Provider,{value:n},e.children)}},9089:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"developing/nix/README","title":"nix","description":"EXPERIMENT","source":"@site/docs/developing/nix/README.md","sourceDirName":"developing/nix","slug":"/developing/nix/","permalink":"/docs/developing/nix/","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/developing/nix/README.md","tags":[],"version":"current","frontMatter":{},"sidebar":"about","previous":{"title":"The Effective Engineer","permalink":"/docs/developing/learning/the_effective_engineer"},"next":{"title":"NIX HOWTO","permalink":"/docs/developing/nix/HOWTO"}}');var l=i(4848),o=i(8453);const r={},a="nix",t={},c=[{value:"EXPERIMENT",id:"experiment",level:2},{value:"Overview",id:"overview",level:2},{value:"Why Nix? Why not Docker?",id:"why-nix-why-not-docker",level:2},{value:"Advantages of Docker",id:"advantages-of-docker",level:3},{value:"Advantages of Nix",id:"advantages-of-nix",level:3},{value:"Differences with homebrew",id:"differences-with-homebrew",level:3},{value:"Installation",id:"installation",level:2},{value:"Getting started",id:"getting-started",level:2},{value:"Quick HOWTO",id:"quick-howto",level:3},{value:"Extra Setup (Only Fish Shell Users)",id:"extra-setup-only-fish-shell-users",level:3},{value:"Working With Packages",id:"working-with-packages",level:3},{value:"Installing New Packages",id:"installing-new-packages",level:4},{value:"Seeing Installed Packages",id:"seeing-installed-packages",level:4},{value:"Looking for Packages",id:"looking-for-packages",level:4},{value:"Uninstalling a Package",id:"uninstalling-a-package",level:4},{value:"Profiles",id:"profiles",level:3},{value:"Default",id:"default",level:4},{value:"Repo Profiles",id:"repo-profiles",level:4},{value:"Working with Existing Nix Expressions",id:"working-with-existing-nix-expressions",level:3},{value:"Learn More About Nix",id:"learn-more-about-nix",level:2},{value:"Advanced Usage",id:"advanced-usage",level:2},{value:"Profiles: Advanced",id:"profiles-advanced",level:3},{value:"Creating a Profile",id:"creating-a-profile",level:4},{value:"Switching Profiles",id:"switching-profiles",level:4},{value:"More Profile Info",id:"more-profile-info",level:4},{value:"Uninstalling",id:"uninstalling",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"nix",children:"nix"})}),"\n",(0,l.jsx)(n.h2,{id:"experiment",children:"EXPERIMENT"}),"\n",(0,l.jsx)(n.p,{children:"We are experimenting with using Nix for developer environments."}),"\n",(0,l.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.a,{href:"https://nixos.org/manual/nix/stable/",children:"nix package manager"}),' is a\n"purely functional package manager". From that manual:']}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"This means that it treats packages like values in purely functional\nprogramming languages such as Haskell \u2014 they are built by functions\nthat don\u2019t have side-effects, and they never change after they have\nbeen built.\n...\nYou can have multiple versions or variants of a package installed at\nthe same time. This is especially important when different\napplications have dependencies on different versions of the same\npackage\n...\nAn important consequence is that operations like upgrading or\nuninstalling an application cannot break other applications, since\nthese operations never \u201cdestructively\u201d update or delete files that\nare used by other packages."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Nix is used to manage the dependencies of a project to ensure that\neveryone is using the same version of all tools."}),"\n",(0,l.jsx)(n.h2,{id:"why-nix-why-not-docker",children:"Why Nix? Why not Docker?"}),"\n",(0,l.jsx)(n.p,{children:"Docker for local development provides many of the same advantages of\nnix: reproducible environments with strict versioning. However, docker\nfor development, while awesome in many ways, also has some downsides."}),"\n",(0,l.jsx)(n.h3,{id:"advantages-of-docker",children:"Advantages of Docker"}),"\n",(0,l.jsx)(n.p,{children:"The biggest downside of native development is that our deployments are\non Linux and it is possible for libraries and code paths to behave\ndifferently on macOS than on Linux. We currently use native\ndevelopment environments and haven't really hit something severe yet,\nso this is more of a theoretical concern for Truss projects right now."}),"\n",(0,l.jsx)(n.h3,{id:"advantages-of-nix",children:"Advantages of Nix"}),"\n",(0,l.jsx)(n.p,{children:"When doing local development using docker, you need to share your\nmac filesystem with the docker container. Docker for mac has to keep\nthe files in sync between your mac and the docker container. That\nsynchronization has historically had poor performance. This means that\noperations that access the filesystem inside docker are slow AND use\nsignificant CPU. Running the same code outside the container is\nsometimes 25-50% faster and that penalty is hard to swallow."}),"\n",(0,l.jsxs)(n.p,{children:["Using Docker for development also complicates committing code. When\nusing ",(0,l.jsx)(n.a,{href:"/docs/developing/vcs/tools",children:"pre-commit"})," you need access to the development\nenvironment when committing code. This means either running git inside\ndocker or trying to find a way to run your pre-commit hooks inside\ndocker."]}),"\n",(0,l.jsxs)(n.p,{children:["Running git inside docker has problems because it makes using a hardware\ndevice for code signing like a\n",(0,l.jsx)(n.a,{href:"/docs/infrasec/tutorials/yubikey-configuration",children:"yubikey"})," much more\ncomplicated and difficult."]}),"\n",(0,l.jsx)(n.p,{children:"Running pre-commit inside docker is not a supported configuration by\npre-commit which takes us even farther away from the well worn path."}),"\n",(0,l.jsx)(n.p,{children:"Finally, configuring local tooling like editors to use the docker\ndevelopment environment is generally much more complicated that\nconfiguring it to use a native development environment."}),"\n",(0,l.jsx)(n.p,{children:"For all of these reasons, a native development environment seems like\na less risky path forward."}),"\n",(0,l.jsx)(n.p,{children:"Using Nix seems like a way to get almost all of the advantages of\ndocker and a native development environment."}),"\n",(0,l.jsx)(n.h3,{id:"differences-with-homebrew",children:"Differences with homebrew"}),"\n",(0,l.jsxs)(n.p,{children:["Homebrew has more packages than ",(0,l.jsx)(n.code,{children:"nix"}),", and installs them globally. For\ncertain things, that might work great. However, that doesn't give\nprojects reproducible installs."]}),"\n",(0,l.jsxs)(n.p,{children:["One other difference is that versions of particular packages may be more\nup to date in one or the other. E.g. as of this writing, homebrew's\n",(0,l.jsx)(n.code,{children:"watchman"})," version is ",(0,l.jsx)(n.code,{children:"2021.06.07.00"})," but ",(0,l.jsx)(n.code,{children:"nix"})," is on ",(0,l.jsx)(n.code,{children:"4.9.0"}),", which is\nfrom sometime in 2017 or 2018."]}),"\n",(0,l.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,l.jsx)(n.p,{children:"MacOS requires that we add an argument to the installation command. We also want to\ndo the single user installation. So to install, run:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"sh <(curl -L https://nixos.org/nix/install)\n"})}),"\n",(0,l.jsxs)(n.p,{children:["See the ",(0,l.jsx)(n.a,{href:"https://nixos.org/manual/nix/stable/#sect-macos-installation",children:"macOS installation"}),"\ninstructions for more details."]}),"\n",(0,l.jsx)(n.h2,{id:"getting-started",children:"Getting started"}),"\n",(0,l.jsxs)(n.p,{children:["After installing ",(0,l.jsx)(n.code,{children:"nix"}),", you should have ",(0,l.jsx)(n.code,{children:"~/.nix-profile/bin"})," in your\nPATH."]}),"\n",(0,l.jsx)(n.h3,{id:"quick-howto",children:"Quick HOWTO"}),"\n",(0,l.jsxs)(n.p,{children:["For a template for how to set up a project see ",(0,l.jsx)(n.a,{href:"/docs/developing/nix/HOWTO",children:"./HOWTO.md"}),"."]}),"\n",(0,l.jsx)(n.h3,{id:"extra-setup-only-fish-shell-users",children:"Extra Setup (Only Fish Shell Users)"}),"\n",(0,l.jsxs)(n.p,{children:["If you're using the fish shell, check out\n",(0,l.jsx)(n.a,{href:"https://github.com/lilyball/nix-env.fish",children:"nix-env.fish"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["Add this to your ",(0,l.jsx)(n.code,{children:"~/.config/fish/config.sh"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'set -g fish_user_paths "/Users/[your_os_username]/.nix-profile/bin" $fish_user_paths\n'})}),"\n",(0,l.jsx)(n.h3,{id:"working-with-packages",children:"Working With Packages"}),"\n",(0,l.jsxs)(n.p,{children:["This is more of a quick overview, but more details can be found in the\n",(0,l.jsx)(n.a,{href:"https://nixos.org/manual/nix/stable/#ch-basic-package-mgmt",children:"nix basic package management docs"}),"."]}),"\n",(0,l.jsx)(n.h4,{id:"installing-new-packages",children:"Installing New Packages"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -i <package>\n"})}),"\n",(0,l.jsx)(n.p,{children:"E.g."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -i direnv\n"})}),"\n",(0,l.jsx)(n.h4,{id:"seeing-installed-packages",children:"Seeing Installed Packages"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -q\n"})}),"\n",(0,l.jsx)(n.h4,{id:"looking-for-packages",children:"Looking for Packages"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -qa <package name>\n"})}),"\n",(0,l.jsx)(n.p,{children:"E.g."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -qa python3\n"})}),"\n",(0,l.jsx)(n.h4,{id:"uninstalling-a-package",children:"Uninstalling a Package"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -e <package>\n"})}),"\n",(0,l.jsx)(n.p,{children:"E.g."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -e chamber\n"})}),"\n",(0,l.jsx)(n.h3,{id:"profiles",children:"Profiles"}),"\n",(0,l.jsx)(n.p,{children:"Profiles can be used at a global level and on a per-repo basis."}),"\n",(0,l.jsx)(n.h4,{id:"default",children:"Default"}),"\n",(0,l.jsxs)(n.p,{children:["When it's installed, ",(0,l.jsx)(n.code,{children:"nix"})," creates a profile which will store all the\npackages you install by default. It will initially only contain the\npackages needed for ",(0,l.jsx)(n.code,{children:"nix"})," itself to work properly."]}),"\n",(0,l.jsxs)(n.p,{children:["If you want, you could tell it to use a different profile. Either on a\none-off command or by switching the active profile. This is covered\nmore in the ",(0,l.jsx)(n.a,{href:"#profiles:-advanced",children:"Profiles: Advanced section"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["Default profile is in: ",(0,l.jsx)(n.code,{children:"/nix/var/nix/profiles/per-user/<username>/profile/"}),"\nE.g. ",(0,l.jsx)(n.code,{children:"/nix/var/nix/profiles/per-user/felipe/profile/"})]}),"\n",(0,l.jsx)(n.h4,{id:"repo-profiles",children:"Repo Profiles"}),"\n",(0,l.jsx)(n.p,{children:"Ideally you'll have a profile defined at a repo level that will house\nyour repo's dependencies."}),"\n",(0,l.jsxs)(n.p,{children:["You can use the ",(0,l.jsx)(n.code,{children:"NIX_PROFILE"})," environment variable when working with this\ntype of profile so that ",(0,l.jsx)(n.code,{children:"nix"})," commands know to use that profile, e.g.\nwhen installing repo dependencies. E.g."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"export NIX_PROFILE=/nix/var/nix/profiles/myproject\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Then you can pre-pend this repo profile to your ",(0,l.jsx)(n.code,{children:"PATH"})," when you're working\nwith the repo, while keeping your default profile in the ",(0,l.jsx)(n.code,{children:"PATH"})," behind the\nrepo profile to still have access to ",(0,l.jsx)(n.code,{children:"nix"})," commands."]}),"\n",(0,l.jsxs)(n.p,{children:["See\n",(0,l.jsx)(n.a,{href:"#working-with-existing-nix-expressions",children:"Working with Existing Nix Expressions"}),"\nfor more details on how to set this up."]}),"\n",(0,l.jsx)(n.h3,{id:"working-with-existing-nix-expressions",children:"Working with Existing Nix Expressions"}),"\n",(0,l.jsxs)(n.p,{children:["For more info see the\n",(0,l.jsx)(n.a,{href:"https://nixos.org/manual/nix/stable/#chap-writing-nix-expressions",children:"nix expressions docs"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["If you have a project or directory with a pre-defined ",(0,l.jsx)(n.code,{children:"default.nix"})," file,\nyou can install have ",(0,l.jsx)(n.code,{children:"nix"})," install the packages defined in it. Usually\nthis file lives in a ",(0,l.jsx)(n.code,{children:"nix"})," directory, and you can use it like this:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -p /nix/var/nix/profiles/<profile name> -f ./nix -i\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Create an ",(0,l.jsx)(n.code,{children:".envrc"})," file in a directory with some environment variables\nyour project needs:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"cat <<ENVRC > .envrc\nexport NIX_PROFILE=/nix/var/nix/profiles/myproject\n\nPATH_add ${NIX_PROFILE}/bin\nENVRC\n"})}),"\n",(0,l.jsxs)(n.p,{children:["On first run, you should get a message indicating that you will have to\nexplicitly authorize ",(0,l.jsx)(n.code,{children:"direnv"})," to load the file:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"direnv: error .envrc is blocked. Run `direnv allow` to approve its content.\n"})}),"\n",(0,l.jsx)(n.p,{children:"Running this should fix it:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"\n$ direnv allow\ndirenv: loading .envrc\ndirenv: export +DB_HOST +DB_NAME +DB_PASSWORD +DB_PORT +DB_USER -PS2\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Your local environment variables should be updated now. Any time the ",(0,l.jsx)(n.code,{children:".envrc"}),"\nfile has changes, you will need to re-approve the file, but it will load\nautomatically otherwise."]}),"\n",(0,l.jsxs)(n.p,{children:["Nix installations are immutable, so by default you cannot make changes\nlike installing additional global software via ",(0,l.jsx)(n.code,{children:"go get"})," or ",(0,l.jsx)(n.code,{children:"npm install -g"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["To use a local directory for installing go binaries, add to your\n",(0,l.jsx)(n.code,{children:".envrc"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"export GOPATH=$PWD/.gopath\nPATH_add ./.gopath/bin\n"})}),"\n",(0,l.jsx)(n.p,{children:"To use a local directory for installing npm binaries:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"export NPM_CONFIG_PREFIX=$PWD/.npmglobal\nPATH_add ./.npmglobal/bin\n"})}),"\n",(0,l.jsx)(n.h2,{id:"learn-more-about-nix",children:"Learn More About Nix"}),"\n",(0,l.jsxs)(n.p,{children:["There are several ",(0,l.jsx)(n.a,{href:"https://nixos.org/learn.html",children:"nix guides"}),"\nthat you may find helpful in learning more about how ",(0,l.jsx)(n.code,{children:"nix"})," works\nif you are curious."]}),"\n",(0,l.jsx)(n.h2,{id:"advanced-usage",children:"Advanced Usage"}),"\n",(0,l.jsx)(n.h3,{id:"profiles-advanced",children:"Profiles: Advanced"}),"\n",(0,l.jsx)(n.p,{children:"In the main profiles section we mention having profiles at a global and\nrepo level. You can also have profiles on a per-project basis."}),"\n",(0,l.jsxs)(n.p,{children:["E.g. for MilMove, you might want a profile that contains things like\n",(0,l.jsx)(n.code,{children:"aws-vault"}),", ",(0,l.jsx)(n.code,{children:"chamber"}),", etc. which spans more than just the ",(0,l.jsx)(n.code,{children:"mymove"}),"\nrepo. On the other hand, you may not want to use a global profile\n(like the default one mentioned in the next section) because you may\nneed different versions of ",(0,l.jsx)(n.code,{children:"aws-vault"})," for different projects."]}),"\n",(0,l.jsx)(n.h4,{id:"creating-a-profile",children:"Creating a Profile"}),"\n",(0,l.jsxs)(n.p,{children:["You can create a new profile wherever you want, though convention seems\nto be to do so in\n",(0,l.jsx)(n.code,{children:"/nix/var/nix/profiles/"}),"\nor\n",(0,l.jsx)(n.code,{children:"/nix/var/nix/profiles/per-user/<username>/"})]}),"\n",(0,l.jsx)(n.p,{children:"To create a new profile, you can run the command below. Note that this\nwon't actually set this new profile as the active one, that's in the\nnext section."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -p /nix/var/nix/profiles/<profile name> -i nix nss-cacert\n"})}),"\n",(0,l.jsx)(n.p,{children:"E.g."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -p /nix/var/nix/profiles/milmove -i nix nss-cacert\n"})}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.code,{children:"-p"})," is telling it the path to the profile you want to use for\nthis ",(0,l.jsx)(n.code,{children:"nix"})," command. This can be used to work with profiles that aren't\nthe active profile. It can also be used with profiles that don't yet\nexist (like here) or with exising profiles."]}),"\n",(0,l.jsxs)(n.p,{children:["You may remember the ",(0,l.jsx)(n.code,{children:"-i"})," is used for installing, so we're installing\n",(0,l.jsx)(n.code,{children:"nix"})," and ",(0,l.jsx)(n.code,{children:"nss-cacert"})," into our new profile."]}),"\n",(0,l.jsxs)(n.p,{children:["This is needed because of an issue if you just switch to a new profile.\nIf you don't install ",(0,l.jsx)(n.code,{children:"nix"})," itself, you lose access to ",(0,l.jsx)(n.code,{children:"nix"})," commands.\nAnd without ",(0,l.jsx)(n.code,{children:"nss-cacert"}),", you can't install packages because ",(0,l.jsx)(n.code,{children:"nix"})," will\nget SSL cert errors."]}),"\n",(0,l.jsxs)(n.p,{children:["For more info see the\n",(0,l.jsx)(n.a,{href:"https://github.com/NixOS/nix/issues/1396",children:"nix github issue"})]}),"\n",(0,l.jsx)(n.h4,{id:"switching-profiles",children:"Switching Profiles"}),"\n",(0,l.jsx)(n.p,{children:"To switch profiles, run"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -S <path to profile>\n"})}),"\n",(0,l.jsx)(n.p,{children:"E.g."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"nix-env -S /nix/var/nix/profiles/milmove\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Note that it is possible to switch to a profile that doesn't exist yet\nand break ",(0,l.jsx)(n.code,{children:"nix"})," commands. See creating profiles section for more info."]}),"\n",(0,l.jsx)(n.h4,{id:"more-profile-info",children:"More Profile Info"}),"\n",(0,l.jsxs)(n.p,{children:["See the ",(0,l.jsx)(n.a,{href:"https://nixos.org/manual/nix/stable/#sec-profiles",children:"nix profiles docs"}),"\nfor more info."]}),"\n",(0,l.jsx)(n.h2,{id:"uninstalling",children:"Uninstalling"}),"\n",(0,l.jsxs)(n.p,{children:["Uninstalling ",(0,l.jsx)(n.code,{children:"nix"})," takes a few steps:"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["Remove the ",(0,l.jsx)(n.code,{children:"nix"})," entry from ",(0,l.jsx)(n.code,{children:"fstab"})," using ",(0,l.jsx)(n.code,{children:"sudo vifs"})]}),"\n",(0,l.jsxs)(n.li,{children:["Destroy the data volume using ",(0,l.jsx)(n.code,{children:"diskutil apfs deleteVolume 'Nix Store'"})]}),"\n",(0,l.jsxs)(n.li,{children:["Remove the ",(0,l.jsx)(n.code,{children:"nix"})," line from ",(0,l.jsx)(n.code,{children:"/etc/synthetic.conf"})," (w/",(0,l.jsx)(n.code,{children:"sudo"}),")"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}}}]);