"use strict";(globalThis.webpackChunkengineering_playbook=globalThis.webpackChunkengineering_playbook||[]).push([[3831],{4572:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"infrasec/aws/vpcs","title":"VPC Configuration","description":"VPC basics","source":"@site/docs/infrasec/aws/vpcs.md","sourceDirName":"infrasec/aws","slug":"/infrasec/aws/vpcs","permalink":"/docs/infrasec/aws/vpcs","draft":false,"unlisted":false,"editUrl":"https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/aws/vpcs.md","tags":[],"version":"current","frontMatter":{},"sidebar":"practices","previous":{"title":"SNS Topics","permalink":"/docs/infrasec/aws/sns-topics"},"next":{"title":"Book Club","permalink":"/docs/infrasec/book-club/"}}');var o=t(4848),i=t(8453);const a={},r="VPC Configuration",c={},l=[{value:"VPC basics",id:"vpc-basics",level:2},{value:"Subnets",id:"subnets",level:3},{value:"Route tables",id:"route-tables",level:3},{value:"Network ACLs",id:"network-acls",level:3},{value:"Security Groups",id:"security-groups",level:3},{value:"Gateways",id:"gateways",level:3},{value:"VPC endpoints",id:"vpc-endpoints",level:3},{value:"Flow logs",id:"flow-logs",level:3},{value:"Default VPC configuration",id:"default-vpc-configuration",level:2},{value:"Reference links",id:"reference-links",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"vpc-configuration",children:"VPC Configuration"})}),"\n",(0,o.jsx)(n.h2,{id:"vpc-basics",children:"VPC basics"}),"\n",(0,o.jsxs)(n.p,{children:['A VPC is a "Virtual Private Cloud".\nThis is a virtual network defined in AWS.\nEach VPC is defined in a specified ',(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions",children:"region"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["The VPC needs a defined CIDR block.\nThese are private network blocks and need to have enough ip addresses for whatever you plan to deploy.\nWhen in doubt, use a ",(0,o.jsx)(n.code,{children:"/16"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Note that each region has multiple ",(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-availability-zones",children:"Availability Zones"})," and the ip space will be subdivided into subnets across these availabilty zones."]}),"\n",(0,o.jsxs)(n.p,{children:["Depending on what you're doing you might just want to use the ",(0,o.jsx)(n.a,{href:"https://github.com/terraform-aws-modules/terraform-aws-vpc",children:"terraform-aws-vpc module"})," with the right toggles."]}),"\n",(0,o.jsx)(n.p,{children:"The following are objects associated with VPCs that can be configured."}),"\n",(0,o.jsx)(n.h3,{id:"subnets",children:"Subnets"}),"\n",(0,o.jsxs)(n.p,{children:["A subnet is a logical subdivision of an IP network.\nGenerally, you will create a pair of public and private subnets in each availability zone for the region.\nA good default CIDR range for each subnet is either a ",(0,o.jsx)(n.code,{children:"/22"})," or ",(0,o.jsx)(n.code,{children:"/24"}),".\nYou will not want to repeat CIDR ranges across your whole network otherwise your routing might get messy."]}),"\n",(0,o.jsx)(n.p,{children:"Creating additional subnets will create additional complexity in route tables.\nIf your project requires you to isolate resources from one another, use Security groups."}),"\n",(0,o.jsx)(n.h3,{id:"route-tables",children:"Route tables"}),"\n",(0,o.jsx)(n.p,{children:"Route tables define the network routing in the VPC.\nYou can route specific ip address spaces to separate subnets or to gateways."}),"\n",(0,o.jsx)(n.h3,{id:"network-acls",children:"Network ACLs"}),"\n",(0,o.jsx)(n.p,{children:"Network ACLs are like firewall rules applied to specific subnets in a VPC.\nYou can define inbound and outbound network traffic across ports for specific IP addresses.\nWe prefer to use Security Groups over Network ACLs as they can be applied to specific resources in a VPC."}),"\n",(0,o.jsx)(n.h3,{id:"security-groups",children:"Security Groups"}),"\n",(0,o.jsx)(n.p,{children:"In a traditional corporate network these would be equivalent to firewall rules.\nSecurity Groups allow you to define inbound and outbound network traffic across ports that than be specific to IP addresses OR other security groups.\nBecause you can define security group access using security group names, we find it easier to configure intended access to resources than Network ACLs."}),"\n",(0,o.jsx)(n.h3,{id:"gateways",children:"Gateways"}),"\n",(0,o.jsx)(n.p,{children:"Use an Internet Gateway for public subnets.\nThese allow traffic in and out of the VPC to the public internet.\nFor all public subnets in a VPC, use a single internet gateway for default routes."}),"\n",(0,o.jsx)(n.p,{children:"Use a NAT Gateway for private subnets.\nThese only allow traffic out of the VPC to the public internet.\nFor each private subnet, create a NAT gateway.\nBased on Terraform documentation, a NAT gateway will be provisioned with an EIP.\nNote, you do not need a NAT instance."}),"\n",(0,o.jsx)(n.h3,{id:"vpc-endpoints",children:"VPC endpoints"}),"\n",(0,o.jsx)(n.p,{children:"VPC endpoints are AWS provided and defined endpoints for AWS services.\nYou may want to use this to close up your network so you have no public traffic."}),"\n",(0,o.jsx)(n.p,{children:"There are two types of VPC endpoints, Gateway endpoints and Interface endpoints."}),"\n",(0,o.jsx)(n.p,{children:"Interface endpoints are a deployed elastic network interface with a private IP address connected to your VPC.\nNote: In our internal test configuration we weren't sure it was worth the cost to just spin up one of everything."}),"\n",(0,o.jsxs)(n.p,{children:["Example of S3 endpoint (heavily modified and commented) from ",(0,o.jsx)(n.a,{href:"https://github.com/terraform-aws-modules/terraform-aws-vpc/blob/master/vpc-endpoints.tf",children:"terraform-aws-vpc module endpoints file"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-terraform",children:'locals {\n    vpc_id = "id of vpc"\n    vpce_tags = { some map of tags... }\n}\n\n# Does a data lookup on the s3 service to determine the name of the service for aws_vpc_endpoint\ndata "aws_vpc_endpoint_service" "s3" {\n  service = "s3"\n}\n\n# Creates the VPC endpoint\nresource "aws_vpc_endpoint" "s3" {\n  vpc_id       = local.vpc_id\n  service_name = data.aws_vpc_endpoint_service.s3[0].service_name\n  tags         = local.vpce_tags\n}\n\n# Create the route table association in the private rout tables\nresource "aws_vpc_endpoint_route_table_association" "private_s3" {\n  vpc_endpoint_id = aws_vpc_endpoint.s3[0].id\n  route_table_id  = element(aws_route_table.private.*.id, count.index)\n}\n\n# Create the route table association if you have intra subnets\nresource "aws_vpc_endpoint_route_table_association" "intra_s3" {\n  vpc_endpoint_id = aws_vpc_endpoint.s3[0].id\n  route_table_id  = element(aws_route_table.intra.*.id, 0)\n}\n\n# Create the route table for the public subnets if you have them\nresource "aws_vpc_endpoint_route_table_association" "public_s3" {\n\n  vpc_endpoint_id = aws_vpc_endpoint.s3[0].id\n  route_table_id  = aws_route_table.public[0].id\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Gateway endpoints are existing endpoints that require configuration in the route tables.\nAvailable Gateway endpoints are: AWS S3 and AWS DynamoDB endpoints in your VPC and you should just deploy those."}),"\n",(0,o.jsxs)(n.p,{children:["The full list of supported endpoints is ",(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html",children:"here"}),".\nYou can see some examples of how to set them up ",(0,o.jsx)(n.a,{href:"https://github.com/terraform-aws-modules/terraform-aws-vpc/blob/master/vpc-endpoints.tf",children:"here"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"flow-logs",children:"Flow logs"}),"\n",(0,o.jsx)(n.p,{children:"VPC Flow logs allow you to monitor all network traffic in your VPC."}),"\n",(0,o.jsx)(n.p,{children:"If you plan to use AWS GuardDuty you must turn these on.\nOtherwise, unless you have a plan to ingest, manage, view, and monitor network flow logs we do not recommend you turn these on."}),"\n",(0,o.jsx)(n.h2,{id:"default-vpc-configuration",children:"Default VPC configuration"}),"\n",(0,o.jsx)(n.p,{children:"Every AWS account comes with a default VPC.\nIn general, you will not want to use that VPC."}),"\n",(0,o.jsxs)(n.p,{children:["Use our ",(0,o.jsx)(n.a,{href:"https://github.com/trussworks/terraform-aws-destroy-default-vpc",children:"Destroy default VPC Terraform Module"})," to effectively destroy the VPC.\nWARNING: undoing this module is hard so if you have inherited the infrastructure you are managing and MIGHT have old resources in the default VPC we don't suggest using it."]}),"\n",(0,o.jsx)(n.h2,{id:"reference-links",children:"Reference links"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html",children:"AWS VPC documentation"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html",children:"AWS VPC Endpoint documentation"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.google.com/document/d/1LeEfqBqVw8gyvSU-TD5IUvDYEwM-0wq5IhYE58fNB8c/edit",children:"Truss Internal guidance doc"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(6540);const o={},i=s.createContext(o);function a(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);