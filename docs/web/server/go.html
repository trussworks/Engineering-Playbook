<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-web/server/go">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Web Applications in Go | Truss Engineering Playbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/web/server/go"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Web Applications in Go | Truss Engineering Playbook"><meta data-rh="true" name="description" content="This section is meant to contain some of the lessons"><meta data-rh="true" property="og:description" content="This section is meant to contain some of the lessons"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/web/server/go"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/web/server/go" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/web/server/go" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.07a89bfb.css">
<link rel="preload" href="/assets/js/runtime~main.53c9bf7c.js" as="script">
<link rel="preload" href="/assets/js/main.25b800c7.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering Playbook</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">Engineering Playbook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/compliance">Federal Compliance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/developing">Tools and Practice</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tools and Practice&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/documentation">Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/incident-response">Incident Response</a><button aria-label="Toggle the collapsible sidebar category &#x27;Incident Response&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/infrasec">InfraSec</a><button aria-label="Toggle the collapsible sidebar category &#x27;InfraSec&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/leadership">Leadership</a><button aria-label="Toggle the collapsible sidebar category &#x27;Leadership&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/practices">Engineering Practices</a><button aria-label="Toggle the collapsible sidebar category &#x27;Engineering Practices&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/templates">Templates</a><button aria-label="Toggle the collapsible sidebar category &#x27;Templates&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/web">Web Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web Development&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/web/api">API Guide</a><button aria-label="Toggle the collapsible sidebar category &#x27;API Guide&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/web/browsersupport">Browser Support</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/web/frontend">Front End</a><button aria-label="Toggle the collapsible sidebar category &#x27;Front End&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/web/server">Server</a><button aria-label="Toggle the collapsible sidebar category &#x27;Server&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/web/server/go">Web Applications in Go</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/web/testing">Testing Frameworks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing Frameworks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/web"><span itemprop="name">Web Development</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/web/server"><span itemprop="name">Server</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Web Applications in Go</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Web Applications in Go</h1><p>This section is meant to contain some of the lessons
Truss has had with building web applications in Go.
It borrows from the format of <a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener noreferrer">Effective Go</a>
along with some lightweight &quot;starter templates&quot;,
to provide some basic standards and patterns we follow.
Code samples are not meant to be &quot;copy and paste&quot; ready,
but provide fundamental principles
that can be incorporated into various applications, frameworks, and packages.</p><p>We attempt to use plain Go code when possible,
but package code may be incorporated or pseudocoded
to mimic production use cases.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="application-layers">Application Layers<a class="hash-link" href="#application-layers" title="Direct link to heading">‚Äã</a></h2><p>Defining application layers is crucial
to a maintainable API or web service.
Picking responsibilities and contracts across layers
can define how an application grows
and how long code iterations in a mature codebase will take.
In Go,
these layers will likely take the form of packages.
There is no one-size-fits-all approach to defining the contract of these packages,
but we&#x27;ll attempt to define some common patterns and inform future approaches.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="handlers">Handlers<a class="hash-link" href="#handlers" title="Direct link to heading">‚Äã</a></h3><p>The term &quot;handler&quot; is used to describe the layer that accepts HTTP requests
and returns a response.
While it may vary in implementation between different libraries,
the term comes from the Go standard library <a href="https://golang.org/pkg/net/http/#Handler" target="_blank" rel="noopener noreferrer">HTTP Package</a>.</p><p>The responsibility of a handler is to accept an HTTP request,
delegate the work to complete the request,
and respond based on error or success scenarios.
Business logic, database code, etc. should not be in a handler.</p><p>It should look rather declarative
with error and success cases drawing two vertical lines via indentation.
Here&#x27;s a trimmed down example of a basic GET handler:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> handlers</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> getDogHandler </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// service implementation, we&#x27;ll get back to this later</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    fetchDog FetchDog</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">//logger implementation may vary, we&#x27;ll psuedocode for this example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    logger Logger</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">h </span><span class="token operator" style="color:#063289">*</span><span class="token plain">getDogHandler</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token function" style="color:#b29762">handleGetDog</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> r </span><span class="token operator" style="color:#063289">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// the only work here is getting params</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// the marshalling likely would be delegated to a middleware in production</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    p </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">dogGetParams</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// offload querying to a service `fetchDog`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    dog</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> h</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">fetchDog</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">DogID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// the error parallel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Error</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">w</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">&quot;Could not fetch dog!&quot;</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">StatusInternalServerError</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// the success parallel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// marshalling here is also likely to be handled by some middleware</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    w</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Write</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token function" style="color:#b29762">dogPayload</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dog</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="testing-handlers">Testing Handlers<a class="hash-link" href="#testing-handlers" title="Direct link to heading">‚Äã</a></h4><p>Handlers will likely become the entry point for integration testing main workflows.
They can be spun up with full service layer implementations
and tested for high priority requests flows (ex. success paths).
Be careful to limit integration tests here,
as they can quickly slow down the application.
If the integration tests become complex,
it&#x27;s a good indicator that the application logic for that handler
is due for a refactor.</p><p>Unit testing handlers often involves mocking
<a href="#services">service layers</a>.
From there,
they will answer the question of:
&quot;given a set of service layer responses,
what response does the handler return?&quot;
This verifies the response/request responsibilities of the handler,
and can be used to test edge cases with little test performance impact.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="composing-handlers">Composing Handlers<a class="hash-link" href="#composing-handlers" title="Direct link to heading">‚Äã</a></h4><p>Handlers, and middlewares more generally, can greatly benefit from being written as <a href="https://medium.com/@matryer/the-http-handler-wrapper-technique-in-golang-updated-bc7fbcffa702" target="_blank" rel="noopener noreferrer">&quot;adapters&quot;</a>. You can then compose very complex flows out of many smaller parts, which is really just another expression of the <a href="https://en.wikipedia.org/wiki/Unix_philosophy" target="_blank" rel="noopener noreferrer">Unix philosophy</a>.</p><p>When building adapters, please ensure the signature of the returned type is <code>http.Handler</code>, even if the underlying implementation is an <code>http.HandlerFunc</code>... All <code>http.HandlerFunc</code>s are <code>http.Handler</code>s, but not all <code>http.Handler</code>s are <code>http.HandlerFunc</code>s.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="models">Models<a class="hash-link" href="#models" title="Direct link to heading">‚Äã</a></h3><p>Put simply, models describe data.
They are agnostic to the data source
(JSON over HTTP, in-memory data structures, DB tables, etc.),
however in many cases the term will be used synonymously
with data queried from a DB.</p><p>The model code should provide the structure of the data
along with methods dictating how outside sources interact with it.</p><p>For example,
here&#x27;s a pretty simple example of a model struct for a dog.</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> Dog </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    ID      uuid</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">UUID </span><span class="token string" style="color:#728fcb">`json:&quot;id&quot; db:&quot;id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Name    </span><span class="token builtin">string</span><span class="token plain">    </span><span class="token string" style="color:#728fcb">`json:&quot;name&quot; db:&quot;name&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Owner     Owner</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>It has a a unique ID, name, and <code>Owner</code>.
The latter being a <code>struct</code> that encompasses an association.</p><p>The field tags follow the syntax patterns for the
<a href="https://golang.org/pkg/encoding/json/" target="_blank" rel="noopener noreferrer">json</a>
and <a href="https://godoc.org/github.com/jmoiron/sqlx" target="_blank" rel="noopener noreferrer">sqlx</a> packages.
This is not to prescribe specific packages,
but to provide a more decorative example that may be encountered in a Truss codebase.</p><p>Interacting with this model is likely going to happen in two ways:</p><ol><li>marshalling from an outside data source</li><li>modifying/viewing the data in Go
(ex. executing business logic).</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="marshalling-models">Marshalling Models<a class="hash-link" href="#marshalling-models" title="Direct link to heading">‚Äã</a></h4><p>In the most basic cases of accepting an HTTP request
or writing/reading from a SQL DB,
marshalling is unlikely to happen manually.
Many web app frameworks or DB connectors/ORMs
are going to handle that hidden by their public APIs
and provide convenience query methods
or, in the case of JSON HTTP requests,
parameter wrappers for handlers.
Within a handler or service,
the model is likely to be accessed only in its Go struct form.
If you&#x27;re curious what that marshalling code might look like,
you can look at this <a href="https://blog.golang.org/json-and-go" target="_blank" rel="noopener noreferrer">json blog post</a>
or take a look at some of the
<a href="https://github.com/jmoiron/sqlx/blob/master/sqlx.go#L23" target="_blank" rel="noopener noreferrer">sqlx column mapping code</a>
that works in tandem with the sql standard library.
We&#x27;ll get more into the interaction between those packages
and our application code in the next section about <a href="#services">services</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="working-with-models-in-go">Working with Models in Go<a class="hash-link" href="#working-with-models-in-go" title="Direct link to heading">‚Äã</a></h4><p>In the second case,
we need to utilize our models to store results of our application logic.
After all, model structs and databases don&#x27;t deliver client value on their own.
Let&#x27;s take a look back at our dog model
and perform some operations.</p><p>First, let&#x27;s try to add a dog.</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> Dog </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    ID      uuid</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">UUID </span><span class="token string" style="color:#728fcb">`json:&quot;id&quot; db:&quot;id&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Name    </span><span class="token builtin">string</span><span class="token plain">    </span><span class="token string" style="color:#728fcb">`json:&quot;name&quot; db:&quot;name&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Owner     Owner</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Elsewhere in the code,
we create a new dog and save it.</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> services</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token function" style="color:#b29762">MyDogFunc</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> owner Owner</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">Dog</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    dog </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> Dog</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    dog</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Name </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    dog</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Owner </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> Owner</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// Save is an external method to interface with DB passed as dependency</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    db</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Save</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token operator" style="color:#063289">&amp;</span><span class="token plain">dog</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> dog</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Notice how our data source is queried entirely outside of the model.
This allows us to separate the model structure
and the dependencies such as external packages for DB connectors
or the type of database itself.
Using this separation helps to isolate data source specific code,
allowing mutability of underlying infrastructure
and enforcing code reuse.</p><p>Let&#x27;s say our Owner can leave the application,
and in this case the owner&#x27;s dogs should also be marked as inactive.
We want our Dog model code to maintain this constraint.</p><p>Here&#x27;s a method to demonstrate that relationship:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> models</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> Dog </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Status Status</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> Owner </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Dogs </span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token plain">Dog</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Status Status</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">o </span><span class="token operator" style="color:#063289">*</span><span class="token plain">Owner</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token function" style="color:#b29762">Deactivate</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    o</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Status </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> Inactive</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    dogs </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Dogs</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">for</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">_</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> dog </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">range</span><span class="token plain"> o</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Dogs </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        dog</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Status </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> Inactive</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        dogs </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">append</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dogs</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> dog</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    o</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Dogs </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> dogs</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>The purpose here is to set up the public model API
to only allow valid modifications throughout the codebase.
We&#x27;ve explicitly linked the dog and owner
to enforce any data constraints.
Similar methodology may follow for reactivating the owner,
changing a dog&#x27;s owner, etc.
Note that in many cases when writing Go code,
we&#x27;d set parameters like these as unexported
to avoid invalid state changes,
however this isn&#x27;t possible due to required exposure
by DB/JSON packages that will use the model&#x27;s public fields.</p><p>We&#x27;ve continued to separate any DB concerns
to outside the model.
For example,
it&#x27;s likely we&#x27;d want to wrap these changes in a transaction:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> services</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token function" style="color:#b29762">DeactiveOwner</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">owner Owner</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    transaction </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Begin</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    owner</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Deactivate</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    err </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Save</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">!=</span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Rollback</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    err </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Save</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Dogs</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">!=</span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Rollback</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    err </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Save</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    transaction</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Commit</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Separating the database concerns from the model
allows us to interact with them separate of the data structure concerns.
Since models have to be passed via <code>struct</code> to marshall their fields
and are commonly used across codebase layers,
adding too many methods and dependencies
can cause excessive package imports across the codebase.
For example,
if we wanted to use a locking feature specific to Postgres
or our database connector library,
we can make those changes independent of the model,
allowing the model to be reused elsewhere
without pulling in possibly irrelevant packages or patterns.
It also allows for isolating experiments and changes
to a small portion of the codebase,
rather than propagated them throughout all model usages.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="wherewhen-to-write-query-code">Where/When to Write Query Code<a class="hash-link" href="#wherewhen-to-write-query-code" title="Direct link to heading">‚Äã</a></h4><p>The above examples make use of an abstracted dependency for a DB connector.
In reality,
any ORM or query interface is likely to be much more complex than <code>Fetch</code>/<code>Save</code>.
As data requirements become more complex,
it becomes much harder to maintain models as purely structural.
It&#x27;s hard to make an exact recommendation for Go code structure
as data requirements may vary considerably.
Backends could vary from REST APIs,
highly normalized SQL tables,
serialized document stores,
sparsely column oriented data,
and so on.</p><p>Some general considerations when organizing query code are:</p><ul><li>If query patterns vary greatly for individual models,
consider tying them closer to the business logic they mirror
(such as a service layer).</li><li>If individual query patterns satisfy multiple models,
consider a separate query layer that can abstract/share code.
When designing something like this,
be wary of over-abstracting and reinventing a query language/ORM.</li><li>If models are single use (ie. they are queried and fetched in one way),
adding query code to the model may make sense.
Note though, models are often shared across multiple code layers,
and due to struct field marshalling,
cannot utilize interface abstractions.
Keeping models as simple as possible (ie. without save/fetch methods),
keeps code changes from propagating across the codebase
and becoming unmaintainable.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="testing-models">Testing Models<a class="hash-link" href="#testing-models" title="Direct link to heading">‚Äã</a></h4><p>Theoretically models should have little responsibility
other than struct definition.
Any exported methods should be unit tested,
such as data validations
or state change methods, like above.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="model-references">Model References<a class="hash-link" href="#model-references" title="Direct link to heading">‚Äã</a></h4><ul><li><a href="https://golang.org/pkg/database/sql/" target="_blank" rel="noopener noreferrer">SQL Standard Library</a>
and some <a href="https://golang.org/src/database/sql/example_test.go" target="_blank" rel="noopener noreferrer">helpful examples</a></li><li><a href="https://jmoiron.github.io/sqlx/" target="_blank" rel="noopener noreferrer">Illustrated Guide to SQLX</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="services">Services<a class="hash-link" href="#services" title="Direct link to heading">‚Äã</a></h3><p>So, we have handlers,
which delegate a request/reponse flow
and models that describe data.
Where does the application logic go?
Into the service layer!
The service layer is where work gets delegated from a handler.
The pattern is borrowed from other languages
<a href="https://medium.com/selleo/essential-rubyonrails-patterns-part-1-service-objects-1af9f9573ca1" target="_blank" rel="noopener noreferrer">like Ruby</a>,
where controllers and models
get encumbered with multiple responsibilities.
The service layer becomes a space
for single use, reusable objects (service objects)
to be built out.
This layer will often be referred to as &quot;business logic&quot;
or &quot;application logic&quot;,
but it&#x27;s more or less
what makes your application/API useful to a client.
It&#x27;s also where the various package dependencies
of the application
are likely to meet,
answering the question of
&quot;how do I accomplish the client need with the given dependencies?&quot;</p><p>Let&#x27;s take a look at an example!
In our dog application,
it&#x27;s unlikely all we want to do
is create dogs in a database.
Let&#x27;s say the purpose of the application
is to show the user how cute a dog is
given various attributes.</p><p>Our handler may look something like this:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> handlers</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> CalculateCutenessScore </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">func</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dogID uuid</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">UUID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">type</span><span class="token plain"> getCutenessScoreHandler </span><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    calculateCutenessScore CalculateCutenessScore</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">//logger implementation may vary, we&#x27;ll psuedocode for this example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    logger Logger</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">h </span><span class="token operator" style="color:#063289">*</span><span class="token plain">getCutenessScoreHandler</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token function" style="color:#b29762">handleGetCutenessScore</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> r </span><span class="token operator" style="color:#063289">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// like above we&#x27;ve deferred marshalling for this example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    p </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">dogGetParams</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// offload calculation to service function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    score</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> h</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">calculateCutenessScore</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">DogID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">==</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">CatchableError </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        h</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">logger</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Error</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Sprintf</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token string" style="color:#728fcb">&quot;Could not calculate cuteness for dog %v&quot;</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">DogID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        w</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Write</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token function" style="color:#b29762">cutnessPayload</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">DEFAULT_CUTENESS_SCORE</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">else</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Error</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">w</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">&quot;Could not calculate dog&#x27;s cuteness!&quot;</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> http</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">StatusInternalServerError</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    w</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Write</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token function" style="color:#b29762">cutenessPayload</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">score</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>The handler here is not too much different than our <code>GetDog</code> example above.
We&#x27;ve changed from <code>GetDog</code> to <code>GetCutenessScore</code>
and likewise updated the service definition.
We&#x27;ve also updated the error catching to be a little more robust.
In this case,
we&#x27;ve defined a &quot;catchable error&quot; to demonstrate
when we should return a default case to the client
and log an error.
Then we default to 500 when unknown errors appear.</p><p>The service definition is passed into the handler as a dependency,
but unlike in the original handler definition,
we&#x27;ve also defined the service contract.
This is important to understanding services,
so let&#x27;s dive in a little deeper.</p><p>First let&#x27;s look at a possible service definition for the cuteness score.</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="background-color:#faf8f5;color:#728fcb"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">package</span><span class="token plain"> services</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token comment" style="color:#b6ad9a">// NewCalculateCutenessScore return an implementation for calculating dog cuteness</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">func</span><span class="token plain"> </span><span class="token function" style="color:#b29762">NewCalculateCutenessScore</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">db Database</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">func</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dogID uuid</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">UUID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">func</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dogID uuid</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">UUID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        dog </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> models</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Dog</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        err </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Fetch</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token operator" style="color:#063289">&amp;</span><span class="token plain">dog</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> dogID</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> err </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">            </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        nameAsInt </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> strconv</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">Atoi</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">dog</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token comment" style="color:#b6ad9a">// they&#x27;re all good dogs brent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        cutenessScore </span><span class="token operator" style="color:#063289">:=</span><span class="token plain"> nameAsInt</span><span class="token operator" style="color:#063289">%</span><span class="token number" style="color:#063289">10</span><span class="token plain"> </span><span class="token operator" style="color:#063289">+</span><span class="token plain"> BRONT_ADDER</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> cutenessScore</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token boolean" style="color:#728fcb">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>So, we&#x27;ve added a new implementation for cuteness score
to the <code>services</code> package.
It returns a function that can calculate cuteness for a given dog ID.
The dependencies, like the <code>Database</code> connector,
are passed into the function generator and hidden from the return value.
This return function, along with its dependencies,
is created when the server is configured.
The constructor will be called once,
whereas the returned function will be called per request.</p><p>Notice how this definition is independent of the definition in the handler
(in a different package).
The handler only needs to know what is required to return a score,
it does <em>not</em> need to know how.
Developing the implementation independently
allows us to easily swap out function implementations
if the user, client, or dependency requirements ever change.
For example,
what if the cuteness score changes to be out of 100 instead of 10?
Instead of dealing with that in a handler,
which we&#x27;ve defined as being responsible for request/response satisfaction,
it&#x27;s segmented to the service function/package.
Likewise, if we want to use a new DB connector,
the dependency for the service will change,
but the handler will be agnostic to that difference.
If we reuse the calculator elsewhere,
changes will not have to be updated sparsely across the handlers codebase.</p><p>Be careful when defining pointers or values in the service functions.
Pointers in a closure can create concurrency concerns between handlers
or any multi-threaded code within them.
On the flip side,
using values could create excessive memory usage
if a service function is called repetitively.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="testing-services">Testing Services<a class="hash-link" href="#testing-services" title="Direct link to heading">‚Äã</a></h4><p>The focus on testing services
should be unit testing business logic.
These tests will likely follow feature workflows.
An example from above would be:
given a dog with X characters in its name,
what is its dog score?
This layer is ripe for testing with
<a href="https://github.com/golang/go/wiki/TableDrivenTests" target="_blank" rel="noopener noreferrer">table driven tests</a>
(ex. given this array of dog names,
what are their scores).</p><p>Avoid over-testing dependencies,
and attempt to mock them when possible
(such as DB calls),
especially expensive or unknown resources such as third party APIs.
These are likely to create long
and flaky tests.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="service-resources">Service Resources<a class="hash-link" href="#service-resources" title="Direct link to heading">‚Äã</a></h4><p>There  are three patterns worth understanding are:</p><ol><li><a href="https://www.calhoun.io/using-the-service-object-pattern-in-go/" target="_blank" rel="noopener noreferrer">Service Objects in Go</a>.
This demonstrates the origin of the pattern,
where single function structs/interfaces
are used to encapsulate work.</li><li><a href="https://blog.chewxy.com/2018/03/18/golang-interfaces/" target="_blank" rel="noopener noreferrer">How to Use Go Interface</a>.
This guide will provide a &quot;Go&quot; styling to interfaces.
Rather than use global objects (like in Ruby)
or tightly coupled interfaces/classes (Java),
we&#x27;ll keep interfaces close to usage (the handler in this case),
and implementations will implicitly satisfy those contracts.</li><li><a href="https://www.calhoun.io/what-is-a-closure/" target="_blank" rel="noopener noreferrer">What is a Closure</a>.
Taking the &quot;one function interface&quot; pattern a step further,
we can utilize Go&#x27;s first class functions and closures
to simply pass the function rather than struct,
removing a layer of indirection.</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="general-patterns">General Patterns<a class="hash-link" href="#general-patterns" title="Direct link to heading">‚Äã</a></h3><p>This section is for patterns that don&#x27;t fit into the specific layers defined above
or should be used throughout all of them.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">‚Äã</a></h3><ul><li><a href="https://www.youtube.com/watch?v=rWBSMsLG8po&amp;feature=youtu.be" target="_blank" rel="noopener noreferrer">GopherCon 2019: Mat Ryer - How I Write HTTP Web Services after Eight Years</a></li><li><a href="https://peter.bourgon.org/go-best-practices-2016/#top-tip-10" target="_blank" rel="noopener noreferrer">Loggers are dependencies</a></li><li><a href="https://blog.golang.org/context" target="_blank" rel="noopener noreferrer">Context as first argument</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/web/server/go.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/web/server"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Server</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/web/testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Testing Frameworks</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#application-layers" class="table-of-contents__link toc-highlight">Application Layers</a><ul><li><a href="#handlers" class="table-of-contents__link toc-highlight">Handlers</a></li><li><a href="#models" class="table-of-contents__link toc-highlight">Models</a></li><li><a href="#services" class="table-of-contents__link toc-highlight">Services</a></li><li><a href="#general-patterns" class="table-of-contents__link toc-highlight">General Patterns</a></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2022 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.53c9bf7c.js"></script>
<script src="/assets/js/main.25b800c7.js"></script>
</body>
</html>