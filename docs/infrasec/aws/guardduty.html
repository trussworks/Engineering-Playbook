<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-infrasec/aws/guardduty">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">[AWS](README.md) / GuardDuty for Organizations | Truss Engineering Playbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/aws/guardduty"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="[AWS](README.md) / GuardDuty for Organizations | Truss Engineering Playbook"><meta data-rh="true" name="description" content="GuardDuty is an anomaly detection"><meta data-rh="true" property="og:description" content="GuardDuty is an anomaly detection"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/aws/guardduty"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/aws/guardduty" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/aws/guardduty" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.07a89bfb.css">
<link rel="preload" href="/assets/js/runtime~main.51571d27.js" as="script">
<link rel="preload" href="/assets/js/main.62abf46a.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering Playbook</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">Engineering Playbook</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/compliance">Federal Compliance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Federal Compliance&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/developing">[Engineering Playbook](../README.md) / Tools and Practice</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Tools and Practice&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/documentation">[Engineering Playbook](../README.md) / Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/incident-response">[Engineering Playbook](../README.md) / Incident Response</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Incident Response&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/infrasec">[Engineering Playbook](../README.md) / InfraSec</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / InfraSec&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers">[InfraSec](README.md) / Alert Providers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/ansible">[InfraSec](../README.md) / Ansible</a><button aria-label="Toggle the collapsible sidebar category &#x27;[InfraSec](../README.md) / Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/infrasec/aws">[InfraSec](../README.md) / AWS</a><button aria-label="Toggle the collapsible sidebar category &#x27;[InfraSec](../README.md) / AWS&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/aws-organizations">[AWS](README.md) / AWS Organizations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/aws/govcloud">[AWS](../README.md) / Working in GovCloud</a><button aria-label="Toggle the collapsible sidebar category &#x27;[AWS](../README.md) / Working in GovCloud&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/aws/guardduty">[AWS](README.md) / GuardDuty for Organizations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/naming">[AWS](README.md) / Naming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/org-bootstrap">[AWS](README.md) / Bootstrapping an AWS Organization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/sns-guardduty-alert-integrations">[AWS](README.md) / Using SNS, GuardDuty, and External Integrations with AWS Organizations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/sns-topics">[AWS](README.md) / SNS Topics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/vpcs">[AWS](README.md) / VPC Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club">[InfraSec](README.md) / book-club</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap">[InfraSec](README.md) / Project Bootstrap Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs">[InfraSec](README.md) / SSL Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter">[InfraSec](README.md) / InfraSec Practice Charter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra">[InfraSec](README.md) / Good Infrastructure - A Philosophy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev">[InfraSec](README.md) / Professional Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown">[InfraSec](README.md) / Project Teardown Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/terraform">[InfraSec](../README.md) / Terraform</a><button aria-label="Toggle the collapsible sidebar category &#x27;[InfraSec](../README.md) / Terraform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/infrasec/tutorials/circle-ci-honeycomb-integrations">tutorials</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/leadership">[Engineering Playbook](../README.md) / Leadership</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Leadership&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/practices">Engineering Practices</a><button aria-label="Toggle the collapsible sidebar category &#x27;Engineering Practices&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/templates">[Engineering Playbook](../README.md) / Templates</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Templates&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/web">[Engineering Playbook](../README.md) / Web Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;[Engineering Playbook](../README.md) / Web Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec"><span itemprop="name">[Engineering Playbook](../README.md) / InfraSec</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec/aws"><span itemprop="name">[InfraSec](../README.md) / AWS</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">[AWS](README.md) / GuardDuty for Organizations</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1><a href="/docs/infrasec/aws">AWS</a> / GuardDuty for Organizations</h1><p><a href="https://aws.amazon.com/guardduty/" target="_blank" rel="noopener noreferrer">GuardDuty</a> is an anomaly detection
system that can alert you via SNS when it detects unusual activity within
your AWS accounts, such as someone using it from an unusual IP.</p><p>Setting up GuardDuty through an organization can be done with a relatively
small amount of Terraform, but there are some issues you may run into as
you do so. This document is intended to help you get GuardDuty set up in
your organization and work around these pitfalls.</p><ul><li><a href="#initial-configuration">Initial configuration</a></li><li><a href="#adding-guardduty-to-existing-accounts">Adding GuardDuty to existing accounts</a></li><li><a href="#adding-more-regions">Adding more regions</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="initial-configuration">Initial configuration<a class="hash-link" href="#initial-configuration" title="Direct link to heading">‚Äã</a></h2><p>To get GuardDuty set up within your organization, the first task will be
to make some changes in your <code>org-root</code> account to get it started. First,
you will need to make sure that GuardDuty is set up as a service principal
for your AWS organization like so:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_organizations_organization&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled_policy_types = [&quot;SERVICE_CONTROL_POLICY&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  feature_set          = &quot;ALL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  aws_service_access_principals = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;config.amazonaws.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cloudtrail.amazonaws.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;guardduty.amazonaws.com&quot; # Make sure this is present</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Using GuardDuty via organizations means that you can consolidate all your
findings in one account, known as the &quot;GuardDuty admin account&quot;. AWS best
practice is to <em>not</em> have this in your <code>org-root</code> account (because we want
to use that account for as little as possible). As a result, you will want
to set your admin account to be another account, usually the <code>infra</code>
account. The code below will make the <code>spacecats-infra</code> account the
GuardDuty admin account for our organization:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_organization_admin_account&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [aws_organizations_organization.main]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  admin_account_id = aws_organizations_account.spacecats_infra.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Once we&#x27;ve done that, we can then go over to the <code>spacecats-infra</code>
account and configure GuardDuty there. There are two components you&#x27;ll
need to set it up: a GuardDuty detector (which is the basic component
for GuardDuty that generates your findings), and a GuardDuty organization
configuration. The code for these looks like this:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_detector&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_organization_configuration&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auto_enable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  detector_id = aws_guardduty_detector.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Once you&#x27;ve created this, GuardDuty is set up and ready to go for the
organization. New accounts added the the organization after this point
will automatically have a detector created that is connected to the
detector in the GuardDuty admin account. Accounts that already exist
will not have GuardDuty set up in them yet, however.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="adding-guardduty-to-existing-accounts">Adding GuardDuty to existing accounts<a class="hash-link" href="#adding-guardduty-to-existing-accounts" title="Direct link to heading">‚Äã</a></h2><p>To add an account to an organization&#x27;s GuardDuty configuration, in the
GuardDuty admin account, you&#x27;ll need to add an <code>aws_guardduty_member</code>
resource for the account. The code for that looks like this:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spacecats_sandbox_id    = &quot;123456789000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spacecats_sandbox_email = &quot;aws+spacecats-sandbox@example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_member&quot; &quot;spacecats_sandbox&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_id                 = local.spacecats_sandbox_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  detector_id                = aws_guardduty_detector.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email                      = local.spacecats_sandbox_email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  invite                     = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_email_notification = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Unfortunately, due to a <a href="https://github.com/terraform-providers/terraform-provider-aws/issues/13906" target="_blank" rel="noopener noreferrer">bug</a>,
once you apply this to fix it, subsequent runs will try to destroy and
recreate this resource. However, if we comment out this resource and
apply, despite Terraform claiming the resource was destroyed, the
membership will still be there. You can confirm this using these
commands:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ aws guardduty list-detectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;DetectorIds&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;1234567890abcdef0000000000000000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ aws guardduty list-members --detector-id 1234567890abcdef0000000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Members&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;AccountId&quot;: &quot;123456789000&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;DetectorId&quot;: &quot;deadbeef627C78CEBDeE47FAC9CdA7Cd&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;MasterId&quot;: &quot;000987654321&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;RelationshipStatus&quot;: &quot;Enabled&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;UpdatedAt&quot;: &quot;2020-06-23T14:31:35.220Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>You will still see the detector for the account you added in this list of
members, even though Terraform will claim to have destroyed it.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="adding-more-regions">Adding more regions<a class="hash-link" href="#adding-more-regions" title="Direct link to heading">‚Äã</a></h2><p>GuardDuty is a regional service -- creating the detectors and members as
above will only enable GuardDuty in a single region. Our best practice
uses SCPs to prevent AWS actions in regions we&#x27;re not using, so you don&#x27;t
need to turn on GuardDuty in say, <code>eu-central-1</code> probably, but at the very
least, most commercial organizations will be using <code>us-west-2</code> and
<code>us-east-1</code>, simply because some resources (like Route53) can only work in
<code>us-east-1</code>. So at the very least, you&#x27;ll want to have GuardDuty set up in
both of those.</p><p>If we assume we&#x27;ve set up our original infrastructure in <code>us-west-2</code>, we
want to set up GuardDuty for <code>us-east-1</code> as well. To do this, we need to
add duplicate resources to the GuardDuty admin account.</p><p>To start off, we&#x27;ll need to define a second provider for the other region
in our <code>providers.tf</code> file (this may already be done if the account already
has resources in the <code>us-east-1</code> region:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version = &quot;~&gt; 2.67&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alias   = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = &quot;us-east-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Then we will need to define a new GuardDuty detector and organization
GuardDuty configuration for the new region like so:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_detector&quot; &quot;main_useast1&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = aws.us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_organization_configuration&quot; &quot;main_useast1&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider    = aws.us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auto_enable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  detector_id = aws_guardduty_detector.main_useast1.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>As with the originals, this should take care of any new accounts;
any accounts that already exist that need to be connected to this
detector, however, will need to be created according to the same method
described in the previous section, with the addition of the <code>provider</code>
argument and pointing to the new detector, like so:</p><div class="codeBlockContainer_I0IT language-hcl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-hcl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_guardduty_member&quot; &quot;spacecats_sandbox_useast1&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider                   = aws.us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_id                 = local.spacecats_sandbox_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  detector_id                = aws_guardduty_detector.main_useast1.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email                      = local.spacecats_sandbox_email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  invite                     = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_email_notification = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/aws/guardduty.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/infrasec/aws/govcloud/gov-orgs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">[GovCloud](README.md) / Setting Up a GovCloud Organization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/infrasec/aws/naming"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[AWS](README.md) / Naming</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#initial-configuration" class="table-of-contents__link toc-highlight">Initial configuration</a></li><li><a href="#adding-guardduty-to-existing-accounts" class="table-of-contents__link toc-highlight">Adding GuardDuty to existing accounts</a></li><li><a href="#adding-more-regions" class="table-of-contents__link toc-highlight">Adding more regions</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2022 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.51571d27.js"></script>
<script src="/assets/js/main.62abf46a.js"></script>
</body>
</html>