<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-infrasec/aws/org-bootstrap">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Bootstrapping an AWS Organization | Truss Engineering Playbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/aws/org-bootstrap"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Bootstrapping an AWS Organization | Truss Engineering Playbook"><meta data-rh="true" name="description" content="The purpose of this document is to take you step by step through the"><meta data-rh="true" property="og:description" content="The purpose of this document is to take you step by step through the"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/aws/org-bootstrap"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/aws/org-bootstrap" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/aws/org-bootstrap" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4015f6c5.css">
<link rel="preload" href="/assets/js/runtime~main.fbc35165.js" as="script">
<link rel="preload" href="/assets/js/main.78d70aa0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering Playbook</b></a><a class="navbar__item navbar__link" href="/docs">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/practices">Practices</a><a class="navbar__item navbar__link" href="/docs/incident-response">Incident Response</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/practices">Engineering Practices</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/appeng">AppEng</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/infrasec">InfraSec</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec">InfraSec Practice</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/adrs">ADRs</a><button aria-label="Toggle the collapsible sidebar category &#x27;ADRs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers">Alert Providers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/ansible">Ansible</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/infrasec/aws">AWS</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/aws-organizations">AWS Organizations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/aws/govcloud">Working in GovCloud</a><button aria-label="Toggle the collapsible sidebar category &#x27;Working in GovCloud&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/guardduty">GuardDuty for Organizations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/naming">Naming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/aws/org-bootstrap">Bootstrapping an AWS Organization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/sns-guardduty-alert-integrations">Using SNS, GuardDuty, and External Integrations with AWS Organizations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/sns-topics">SNS Topics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/aws/vpcs">VPC Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club">Book Club</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap">Project Bootstrap Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs">SSL Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter">InfraSec Practice Charter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ci_cd">CI/CD according to Truss</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra">Good Infrastructure - A Philosophy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev">Professional Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown">Project Teardown Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/terraform">Terraform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Terraform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">InfraSec</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec/aws"><span itemprop="name">AWS</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Bootstrapping an AWS Organization</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Bootstrapping an AWS Organization</h1><p>The purpose of this document is to take you step by step through the
process of bootstrapping an <a href="/docs/infrasec/aws/aws-organizations">AWS Organization</a>.
This is only intended for cases where we are setting up the AWS account
structure from scratch.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="naming-conventions">Naming Conventions<a href="#naming-conventions" class="hash-link" aria-label="Direct link to Naming Conventions" title="Direct link to Naming Conventions">​</a></h2><p>Before starting this process, decide on a naming convention for your
organization. For instance, if you are setting up a new organization
for &quot;spacecats&quot;, you will be creating AWS account aliases like
<code>spacecats-org-root</code>, <code>spacecats-id</code>, <code>spacecats-sandbox</code>, etc.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-organization-root-account">Create Organization Root Account<a href="#create-organization-root-account" class="hash-link" aria-label="Direct link to Create Organization Root Account" title="Direct link to Create Organization Root Account">​</a></h2><p>First, you will use the AWS console to create an &quot;organization root&quot;
account. The purpose of this account is to handle root-level service
control policies <a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scp.html" target="_blank" rel="noopener noreferrer">(SCPs)</a>
and encompass the the organizational units (OUs) underneath. If you
need to know how to create an AWS account, please see
<a href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/</a>.
You should set the alias for this account to your project&#x27;s name and
the <code>org-root</code> suffix, like <code>spacecats-org-root</code>.</p><p>If this is an organization Truss will be paying for, use your Truss
credit card to pay for this account (this may be changed later). For
the address, use the Market Street mailing address from our homepage.
For a phone number, have a Dialpad administrator create you a Dialpad
number for this project and use that for the verification phone number.
For the moment, you can choose the free level of support; we can always
upgrade this later.</p><p>Save the login and password to the 1Password vault you set up for this
project previously, and then be sure to add MFA to the root account using
the same 1Password entry. <em>This is imperative for security purposes.</em></p><p>In order for the billing group users (created in the id account) to be
able to access billing information in this account, see <a href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/control-access-billing.html#ControllingAccessWebsite-Activate" target="_blank" rel="noopener noreferrer">Activating
access to the Billing and Cost Management
console</a>.
This needs to be done as the root user, so now is a good time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bootstrap-terraform-for-org-root-account">Bootstrap Terraform for org-root Account<a href="#bootstrap-terraform-for-org-root-account" class="hash-link" aria-label="Direct link to Bootstrap Terraform for org-root Account" title="Direct link to Bootstrap Terraform for org-root Account">​</a></h2><p>Following the pattern in <a href="https://github.com/trussworks/terraform-layout-example" target="_blank" rel="noopener noreferrer">https://github.com/trussworks/terraform-layout-example</a>,
set up your infra Git repo that we created earlier. Name the directory for this
account after the account alias as usual. Then, <code>cd</code> into this directory and
checkout the bootstrap repo like so:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token function" style="color:#b29762">git</span><span class="token plain"> clone git@github.com:trussworks/terraform-aws-bootstrap.git bootstrap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Follow the instructions in the bootstrap README and do the following:</p><ul><li>set up /bin directory with aws-vault-wrapper and symlinks</li><li>set up .envrc in the top level and run <code>direnv allow</code></li><li>set up .envrc in the account directory and run <code>direnv allow</code>; note
that this .envrc should set the <code>AWS_PROFILE</code> environment variable
to match the name of this account.</li></ul><p>Now create a temporary IAM user in the <code>org-root</code> account and give it
administrative privileges. Name this user something obvious, like
&quot;myuser-setup&quot; so you can clean it up easily later. Generate an AWS key
pair and add an MFA for the user. Add the access keys to aws-vault by
running <code>aws-vault add $AWS_PROFILE</code> from within the account directory.
Once you&#x27;ve done that, you should be able to run the bootstrap script as
described in the README.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraforming-the-org-root-account">Terraforming the org-root Account<a href="#terraforming-the-org-root-account" class="hash-link" aria-label="Direct link to Terraforming the org-root Account" title="Direct link to Terraforming the org-root Account">​</a></h2><p>Once Terraform is bootstrapped in the <code>org-root</code> account, you will need to
create an <code>admin-global</code> directory in the account directory of the infra
repo. Your first step should be setting up the <code>providers.tf</code> and
<code>terraform.tf</code> files; see the examples in the <code>terraform-layout-example</code>
repo linked above.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-org-root-admin-users">Create org-root Admin Users<a href="#create-org-root-admin-users" class="hash-link" aria-label="Direct link to Create org-root Admin Users" title="Direct link to Create org-root Admin Users">​</a></h3><p>Once those are set up, you can begin the rest of the work. Your first
action should be to create administrative IAM users that will <em>only</em> be
used to manage the org-root account and bootstrap the subordinate accounts.
These should not be used for anything else. Suffix the user name with
<code>.org-root</code> to make it clear what these are for. They will be the only
accounts that can manage the org-root account.</p><p>Example Terraform code (suggest using a <code>users.tf</code> file):</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  admin_users = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;myuser.org-root&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_user&quot; &quot;admins&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  for_each      = toset(local.admin_users)</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name          = each.value</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  force_destroy = true</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Automation = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;admins_group&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;trussworks/iam-user-group/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;1.0.2&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  user_list     = local.admin_users</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  group_name    = &quot;admins&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  allowed_roles = [&quot;admin&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This is a generic role assumption policy that enforces MFA.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;role_assume_role_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actions = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    # only allow folks in this account</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      type        = &quot;AWS&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      identifiers = [data.aws_caller_identity.current.account_id]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    # require MFA</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    condition {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      test     = &quot;Bool&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      variable = &quot;aws:MultiFactorAuthPresent&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      values   = [&quot;true&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;admin&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name               = &quot;admin&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description        = &quot;Role for organization administrators&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  assume_role_policy = data.aws_iam_policy_document.role_assume_role_policy.json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Automation = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;admin_administrator_access&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  group      = aws_iam_role.admin.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AdministratorAccess&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once you have applied the Terraform and have the users created, issue
security keys for this user and add them to aws-vault; change your
profile for this account to use these new credentials and delete the
temporary user from your aws-vault and the <code>org-root</code> account. You
should not use the root account anymore unless there is some kind of
emergency.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-aws-organization">Create AWS Organization<a href="#create-aws-organization" class="hash-link" aria-label="Direct link to Create AWS Organization" title="Direct link to Create AWS Organization">​</a></h3><p>Now we can begin creating the AWS Organization itself. There are a
number of standard components that we&#x27;ll want to create using Terraform:</p><ul><li>the AWS organization itself</li><li>the initial OU which contains everything except the <code>suspended</code> OU</li><li>a <code>suspended</code> OU which will contain accounts quarantined due to
security concerns</li><li>a policy which denies use of all AWS resources we can tie to the
<code>suspended</code> OU (which will override the default FullAWSAccess policy);
this is a part of the Truss
<a href="https://registry.terraform.io/modules/trussworks/org-scp/aws" target="_blank" rel="noopener noreferrer">org-scp</a>
module</li><li>an <code>id</code> account (<code>spacecats-id</code> in our example) which will contain
all of the IAM users we&#x27;ll be using to interact with this organization</li><li>an <code>infra</code> account where we can put specific infra-only resources; if
you are running Atlantis, this is where you can put the Terraform for
that deployment, or you might put the root DNS records for your
project&#x27;s Route53 domain, etc.</li></ul><p>You can do all of this from the <code>org-root</code> account via Terraform:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain"># Create the AWS Organization</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_organizations_organization&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  aws_service_access_principals = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;cloudtrail.amazonaws.com&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;config.amazonaws.com&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  enabled_policy_types = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;SERVICE_CONTROL_POLICY&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  feature_set = &quot;ALL&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Organizational Units</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># The main OU, where all the resources we actually use will live.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_organizations_organizational_unit&quot; &quot;spacecats&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name      = &quot;spacecats&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  parent_id = aws_organizations_organization.main.roots.0.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># A suspended OU, where we can quarantine accounts.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_organizations_organizational_unit&quot; &quot;suspended&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name      = &quot;suspended&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  parent_id = aws_organizations_organization.main.roots.0.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Add the Truss SCPs module and turn on the &quot;deny all access&quot; SCP for the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># suspended account. Note that this module has many other useful SCPs --</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># see the docs for more info.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;org-scps&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;trussworks/org-scp/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;~&gt; 1.4.0&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  deny_all_access_target_ids = [aws_organizations_organizational_unit.suspended.id]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Organization Accounts</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_organizations_account&quot; &quot;spacecats_id&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name                       = &quot;spacecats-id&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  email                      = &quot;spacecats-infra+aws-org-id@example.com&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  parent_id                  = aws_organizations_organizational_unit.spacecats.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Allow IAM user access to billing for this account so that we can let</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # project/delivery managers access billing info without a root account.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  iam_user_access_to_billing = &quot;ALLOW&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Automation = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_organizations_account&quot; &quot;spacecats_infra&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name                       = &quot;spacecats-infra&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  email                      = &quot;spacecats-infra+aws-org-infra@example.com&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  parent_id                  = aws_organizations_organizational_unit.spacecats.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  iam_user_access_to_billing = &quot;DENY&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Automation = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Outputs for Accounts -- so you get the account numbers for later use</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># You can put these in a separate outputs.tf file if you prefer</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">output &quot;aws_organizations_account_spacecats_id_id&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description = &quot;ID for the Spacecats id account&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  value       = aws_organizations_account.spacecats_id.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">output &quot;aws_organizations_account_spacecats_infra_id&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description = &quot;ID for the Spacecats infra account&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  value       = aws_organizations_account.spacecats_infra.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-note-on-terraforming-accounts">A Note on Terraforming Accounts<a href="#a-note-on-terraforming-accounts" class="hash-link" aria-label="Direct link to A Note on Terraforming Accounts" title="Direct link to A Note on Terraforming Accounts">​</a></h4><p>Creating accounts in this way keeps you from having to add billing info,
verifying a phone number, or any of the other hoops you have to jump
through when creating a new AWS account. However, it also means the root
user has no password set, making it impossible to log in as root without
going through the password recovery process.</p><p>Instead, you can use the <a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_accounts_access.html#orgs_manage_accounts_access-cross-account-role" target="_blank" rel="noopener noreferrer"><code>OrganizationAccountAccessRole</code></a>
to access these accounts from the <code>org-root</code> account. Set up a new profile
in your <code>.aws/config</code> for the new account that looks like this:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">[profile spacecats-id]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">source_profile=spacecats-org-root</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">role_arn=arn:aws:iam::&lt;spacecats-id account number&gt;:role/OrganizationAccountAccessRole</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">region=us-west-2</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">output=json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># If you have MFA turned on, you will also need to add the mfa_serial</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># line from the source_profile.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can then use this role to get access into these accounts to
bootstrap them for Terraform. Once you have Terraform set up, you can
create the resources necessary to either create an IAM user you can use
or an IAM role you can assume to work with this account, at which point
you can use the profile pattern described in the next section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-id-account-users-and-role-assumption">Setting Up the id Account Users and Role Assumption<a href="#setting-up-the-id-account-users-and-role-assumption" class="hash-link" aria-label="Direct link to Setting Up the id Account Users and Role Assumption" title="Direct link to Setting Up the id Account Users and Role Assumption">​</a></h2><p>Follow the same steps you took to bootstrap the <code>org-root</code> account to
bootstrap your <code>id</code> account. Once you&#x27;ve done that, you can set up the
users and groups that team members will use to access all other AWS
resources. Truss uses <a href="https://registry.terraform.io/modules/trussworks/iam-user-group/aws/1.0.2" target="_blank" rel="noopener noreferrer"><code>iam-user-group</code></a> and <a href="https://registry.terraform.io/modules/trussworks/iam-cross-acct-dest/aws" target="_blank" rel="noopener noreferrer"><code>iam-cross-acct-dest</code></a> modules to do this; see <a href="https://github.com/trussworks/terraform-layout-example" target="_blank" rel="noopener noreferrer"><code>terraform-layout-example</code></a> for how we use them.</p><p>In order to do this, in your <code>id</code> account, define your users and then
use the module like so:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_caller_identity&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  spacecats_infra_account_id = &lt;spacecats-infra account number&gt;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  infra_users = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;myuser&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_user&quot; &quot;infra_users&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  for_each      = toset(local.infra_users)</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name          = each.value</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  force_destroy = true</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Automation = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;infra_group_role&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;trussworks/iam-cross-acct-src/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  destination_account_ids = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    data.aws_caller_identity.current.account_id,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    local.spacecats_infra_account_id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  destination_group_role  = &quot;infra&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;infra_group&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;trussworks/iam-user-group/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;1.0.2&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  user_list     = local.infra_users</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  allowed_roles = [module.infra_group_role.arn]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  group_name    = &quot;infra&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;infra_local_policy_attachment&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  role       = module.infra_group_role.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/PowerUserAccess&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using that code, we get an IAM user <code>myuser</code> in the group <code>infra</code>, which
has permission to assume the <code>infra</code> role in the current account and the
<code>spacecats-infra</code> account. We also attach a policy to the <code>infra</code> role we
created that grants power user access.</p><p>All user creation and grouping should be done in the <code>id</code> account. In the
the other accounts, we grant these groups permission to assume roles that
grant whatever permissions they need. So in the <code>spacecats-infra</code> account,
if we want to allow the <code>infra</code> group to have similar permissions, we can
use this code in that account&#x27;s namespace:</p><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  spacecats_id_acct_id = &lt;spacecats-id account number&gt;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;infra_role&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;trussworks/iam-cross-acct-dest/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;1.0.0&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  iam_role_name             = &quot;infra&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source_account_id         = local.spacecats_id_account_id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;infra_local_policy_attachment&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  role       = module.infra_role.iam_role_name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/PowerUserAccess&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code creates a new <code>infra</code> role in the <code>spacecats-infra</code> account and
allows users in the <code>spacecats-id</code> account to assume that role in this
account as well. Note that we&#x27;re not gating this based on the role in the
<code>id</code> account; instead, we assume the <code>id</code> account will do that gating for
us. Then we grant the <code>infra</code> role the same level of permissions those
users had in the <code>id</code> account. Note that we <em>could</em> give them a different
level of access if we wanted to -- general engineers will not have
permission to do much of anything in the <code>id</code> account most of the time,
but we could grant them power user access in a sandbox account, and
perhaps only access to look at Cloudwatch logs in the staging or prod
accounts. Using this method allows you to do all your user management in
one place, and then give role-based access everywhere else.</p><p>In order for these users to access other accounts, you&#x27;ll need to set up
their profiles for these other accounts like so:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">[profile spacecats-infra]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">source_profile = spacecats-id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">role_arn = arn:aws:iam::&lt;spacecats-infra account number&gt;:role/infra</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">region = us-west-2</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">output = json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># If you have MFA turned on, you will also need to add the mfa_serial</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># line from the source_profile.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h2><p>Once you have the <code>org-root</code>, <code>id</code>, and <code>infra</code> accounts created, you
can move on to setting up the other parts of your infrastructure. If you
want to create more accounts, follow the example with the <code>infra</code> account
above; you should refrain from creating any IAM users in non-<code>id</code> accounts
if possible (though sometimes this is necessary for CI/CD or other
automation).</p><p>You should also set up some basic AWS services for the organization. Both
Cloudtrail and GuardDuty can be set up at the organization level in the
<code>org-root</code> account, and Config should be set up in each account.</p><p>Finally, you should review the <a href="https://github.com/trussworks/terraform-aws-org-scp" target="_blank" rel="noopener noreferrer">Truss <code>org-scp</code> module
README</a> and consider
implementing some of the standard SCPs to parts of your organization,
such as denying root account access and preventing accounts from removing
themselves from the organization.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="shared-resources">Shared Resources<a href="#shared-resources" class="hash-link" aria-label="Direct link to Shared Resources" title="Direct link to Shared Resources">​</a></h3><p>In general, with an organization, there should be a bias towards making
each individual account as self-sufficient as possible and avoid using
too many shared resources. One of the driving reasons for using an AWS
Organization is the ability to compartmentalize resources; engineers can
have wide permissions in a sandbox account, for instance, because they
are not going to be able to touch anything in the main release pipeline.
If you use a shared resource, like an S3 bucket, you end up having to
do more detailed permission management to keep accounts from stepping on
each other -- this essentially eliminates the advantage of the
organization in the first place.</p><p>For most things, creating a separate resource for each account is likely
the better play -- for things like S3 buckets, having two S3 buckets with
half as much stuff as a single larger S3 bucket ends up essentially being
the same cost. Even for things where the added cost is marginal, like VPCs
or ECS services, the added peace of mind of splitting these services is
usually worth it. In addition, separating resources like this makes it
easy to spin up a complete new environment by simply stamping a new
self-contained copy of all the necessary resources.</p><p>If you must have some shared resources, these should be served from an
account that is separate from the others -- the <code>infra</code> account is a
likely place to put many of these, and that&#x27;s why it is part of the
pattern, but it may not be appropriate for everything. In addition, you
will need to implement strong controls around access to these resources.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/aws/org-bootstrap.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/infrasec/aws/naming"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Naming</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/infrasec/aws/sns-guardduty-alert-integrations"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using SNS, GuardDuty, and External Integrations with AWS Organizations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#naming-conventions" class="table-of-contents__link toc-highlight">Naming Conventions</a></li><li><a href="#create-organization-root-account" class="table-of-contents__link toc-highlight">Create Organization Root Account</a></li><li><a href="#bootstrap-terraform-for-org-root-account" class="table-of-contents__link toc-highlight">Bootstrap Terraform for org-root Account</a></li><li><a href="#terraforming-the-org-root-account" class="table-of-contents__link toc-highlight">Terraforming the org-root Account</a><ul><li><a href="#create-org-root-admin-users" class="table-of-contents__link toc-highlight">Create org-root Admin Users</a></li><li><a href="#create-aws-organization" class="table-of-contents__link toc-highlight">Create AWS Organization</a></li></ul></li><li><a href="#setting-up-the-id-account-users-and-role-assumption" class="table-of-contents__link toc-highlight">Setting Up the id Account Users and Role Assumption</a></li><li><a href="#next-steps" class="table-of-contents__link toc-highlight">Next Steps</a><ul><li><a href="#shared-resources" class="table-of-contents__link toc-highlight">Shared Resources</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2023 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fbc35165.js"></script>
<script src="/assets/js/main.78d70aa0.js"></script>
</body>
</html>