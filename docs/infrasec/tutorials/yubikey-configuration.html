<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-infrasec/tutorials/yubikey-configuration">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">YubiKey Configuration Guide | Truss Engineering Playbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/tutorials/yubikey-configuration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="YubiKey Configuration Guide | Truss Engineering Playbook"><meta data-rh="true" name="description" content="- Introduction"><meta data-rh="true" property="og:description" content="- Introduction"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/tutorials/yubikey-configuration"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/tutorials/yubikey-configuration" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/tutorials/yubikey-configuration" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.07a89bfb.css">
<link rel="preload" href="/assets/js/runtime~main.5d2e427c.js" as="script">
<link rel="preload" href="/assets/js/main.0ef5cc31.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering Playbook</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">Engineering Playbook</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/compliance">Federal Compliance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Federal Compliance&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/developing">Tools and Practice</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tools and Practice&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/documentation">Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/incident-response">Incident Response</a><button aria-label="Toggle the collapsible sidebar category &#x27;Incident Response&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/infrasec">InfraSec</a><button aria-label="Toggle the collapsible sidebar category &#x27;InfraSec&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers">Alert Providers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/ansible">Ansible</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/aws">AWS</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club">Book Club</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap">Project Bootstrap Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs">SSL Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter">InfraSec Practice Charter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra">Good Infrastructure - A Philosophy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev">Professional Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown">Project Teardown Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/terraform">Terraform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Terraform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/infrasec/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/tutorials/circle-ci-honeycomb-integrations">CircleCi Honeycomb Integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/tutorials/fix-circleci-integrations">Fix CircleCI Integrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/tutorials/one-time-passwords">One-Time Passwords</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/tutorials/your_first_lambda_function">Deploying your first AWS Lambda Function with Go and Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/tutorials/yubikey-configuration">YubiKey Configuration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/tutorials/yubikey-sso">Single Sign-On</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/leadership">Leadership</a><button aria-label="Toggle the collapsible sidebar category &#x27;Leadership&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/practices">Engineering Practices</a><button aria-label="Toggle the collapsible sidebar category &#x27;Engineering Practices&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/templates">Templates</a><button aria-label="Toggle the collapsible sidebar category &#x27;Templates&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/web">Web Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec"><span itemprop="name">InfraSec</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec/tutorials"><span itemprop="name">Tutorials</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">YubiKey Configuration Guide</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>YubiKey Configuration Guide</h1><ul><li><a href="#introduction">Introduction</a></li><li><a href="#purchasing-and-distribution">Purchasing and Distribution</a></li><li><a href="#prerequisites">Prerequisites</a><ul><li><a href="#hardware-requirements">Hardware Requirements</a></li><li><a href="#software-requirements">Software Requirements</a></li></ul></li><li><a href="#configuring-your-environment">Configuring Your Environment</a><ul><li><a href="#using-pinentry-optional">Using pinentry (optional)</a></li></ul></li><li><a href="#verifying-your-yubikey">Verifying Your YubiKey</a></li><li><a href="#setting-the-yubikey-user-and-admin-pin-codes">Setting the YubiKey User and Admin PIN codes</a></li><li><a href="#key-generation">Key Generation</a><ul><li><a href="#generating-a-gpg-private-key">Generating a GPG Private Key</a></li><li><a href="#add-a-s-signing-subkey">Add a (S) signing subkey</a></li><li><a href="#add-an-a-authentication-subkey">Add an (A) authentication subkey</a></li></ul></li><li><a href="#check-your-keys">Check Your Keys</a></li><li><a href="#deleting-a-secret-key">Deleting a secret key</a></li><li><a href="#creating-backups">Creating Backups</a><ul><li><a href="#create-a-backup-of-your-secret-keys-optional">Create a backup of your secret keys (optional)</a></li><li><a href="#create-a-backup-of-your-public-key-optional">Create a backup of your public key (optional)</a></li><li><a href="#create-a-revocation-certificate-optional">Create a revocation certificate (optional)</a></li></ul></li><li><a href="#configuring-the-yubikey">Configuring the YubiKey</a><ul><li><a href="#importing-the-keys-to-your-yubikey">Importing the keys to your YubiKey</a></li></ul></li><li><a href="#adding-additional-email-addresses">Adding Additional Email Addresses</a><ul><li><a href="#uids-and-the-primary-key">UIDs and the primary key</a></li></ul></li><li><a href="#configuring-ssh">Configuring SSH</a></li><li><a href="#configuring-git-commit-signing">Configuring git commit Signing</a></li><li><a href="#configuring-github">Configuring Github</a><ul><li><a href="#using-github-desktop">Using Github Desktop</a></li></ul></li><li><a href="#verifying-your-configuration">Verifying your configuration</a><ul><li><a href="#deleting-local-secret-key-material">Deleting local secret key material</a></li><li><a href="#subkey-stubs">Subkey stubs</a></li></ul></li><li><a href="#using-the-yubikey">Using The YubiKey</a><ul><li><a href="#signing-git-commits">Signing git commits</a></li><li><a href="#enabling-touch-only-mode-optional">Enabling touch-only mode (optional)</a></li><li><a href="#disabling-otp-one-time-password">Disabling OTP (One Time Password)</a></li></ul></li><li><a href="#github-apps">GitHub Apps</a></li><li><a href="#troubleshooting">Troubleshooting</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h2><p>The YubiKey is a hardware authentication device manufactured by Yubico that supports one-time passwords, public-key encryption and authentication, and the Universal 2nd Factor (U2F) and FIDO2 protocols developed by the FIDO Alliance. It allows users to securely log into their accounts by emitting one-time passwords or using a FIDO-based public/private key pair generated by the device. YubiKey also allows for storing static passwords for use at sites that do not support one-time passwords. Some password managers, including 1Password, support YubiKey.</p><p>The YubiKey will allow us to sign our GitHub commits, which may be required by some contracts.</p><p>If you have problems or questions during the configuration process, check in with #infrasec-chat on the Truss Slack.</p><p>PIN codes and passphrases may be cached for a short duration at any point during the configuration process. You may not always be prompted to enter these.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="purchasing-and-distribution">Purchasing and Distribution<a class="hash-link" href="#purchasing-and-distribution" title="Direct link to heading">‚Äã</a></h2><p>It is currently recommended that distributed Trussels purchase their YubiKey directly from either Amazon or <a href="https://www.yubico.com/store/" target="_blank" rel="noopener noreferrer">Yubico</a>. The SF office may opt to purchase some YubiKeys in bulk for local Trussels, but this has not been decided yet. Bulk purchasing of YubiKeys yields a savings of $2.40 per $60 YubiKey.</p><p>If ordering a YubiKey for a project, check with your project on how to categorize the expense in Expensify. Otherwise, use the <code>Computer Equipment</code> category.</p><p>You should purchase a YubiKey 5 Series (<a href="https://www.amazon.com/Yubico-YubiKey-Factor-Authentication-Security/dp/B07HBCTYP1/" target="_blank" rel="noopener noreferrer">5C</a>, <a href="https://www.amazon.com/Yubico-YubiKey-Factor-Authentication-Security/dp/B07HBTBJ5S/" target="_blank" rel="noopener noreferrer">5C Nano</a>, <a href="https://www.amazon.com/Yubico-YubiKey-5Ci-Authentication-Connectors/dp/B07WGJ1DNJ/" target="_blank" rel="noopener noreferrer">5ci</a>)</p><ul><li><strong>5Ci</strong> supports both USB C and Lighting ports, which is good if you have an iPhone.</li><li><strong>5C</strong> and <strong>5C Nano</strong> only support USB C and come in different form factors.</li></ul><p>If you have a YubiKey Series 4 or a YubiKey 5 NEO, you <em>should</em> upgrade to a 5 Series, unless you have a specific need for the older model. The YubiKey 5 series will provide stronger security and can support larger encryption keys.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="hardware-requirements">Hardware Requirements<a class="hash-link" href="#hardware-requirements" title="Direct link to heading">‚Äã</a></h3><ul><li>YubiKey 5 Series (<a href="https://www.amazon.com/Yubico-YubiKey-Factor-Authentication-Security/dp/B07HBCTYP1/" target="_blank" rel="noopener noreferrer">5C</a>, <a href="https://www.amazon.com/Yubico-YubiKey-Factor-Authentication-Security/dp/B07HBTBJ5S/" target="_blank" rel="noopener noreferrer">5C Nano</a>, <a href="https://www.amazon.com/Yubico-YubiKey-5Ci-Authentication-Connectors/dp/B07WGJ1DNJ/" target="_blank" rel="noopener noreferrer">5ci</a>)</li><li>YubiKey 4 Series and 5 NEO are acceptable, but not preferred. Keys are limited to 2048 bits</li></ul><p><em>FIPS based YubiKeys ship with security vulnerabilities. Do not purchase a FIPS based YubiKey for work performed at Truss. FIPS YubiKey models are specifically called YubiKey FIPS and not part of the 5 series listed above.</em></p><p><a href="https://www.yubico.com/support/security-advisories/ysa-2019-02/" target="_blank" rel="noopener noreferrer">Yubico Security Advisory</a> about FIPS keys</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="software-requirements">Software Requirements<a class="hash-link" href="#software-requirements" title="Direct link to heading">‚Äã</a></h3><ul><li>brew<ul><li>ykman</li><li>ykpers</li></ul></li><li>brew cask<ul><li>gpg-suite-no-mail</li></ul></li></ul><p>Configure your environment with:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">brew install ykman ykpers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew cask install gpg-suite-no-mail</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If xcode is not up to date, you will be prompted to install it with: <code>xcode-select --install</code></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-your-environment">Configuring Your Environment<a class="hash-link" href="#configuring-your-environment" title="Direct link to heading">‚Äã</a></h2><p>Enable SSH support by default when launching gpg-agent:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> enable-ssh-support </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> ~/.gnupg/gpg-agent.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Add the following to your shell profile <code>.bashrc</code>, <code>.zshrc</code>, etc.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Expose the SSH agent to the GPG agent.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable environment constant" style="color:#36acaa">SSH_AUTH_SOCK</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable environment constant" style="color:#36acaa">HOME</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">/.gnupg/S.gpg-agent.ssh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">SSH_AUTH_SOCK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Define a function to manually reset the GPG and SSH agent.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">yubikey-init</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pgrep gpg-agent </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">killall</span><span class="token plain"> gpg-agent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pgrep ssh-agent </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">killall</span><span class="token plain"> ssh-agent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gpg --card-status all </span><span class="token operator" style="color:#393A34">&amp;&gt;</span><span class="token plain"> /dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Run <code>yubikey-init</code> to manually reset the GPG agent whenever you need to, such as after re-inserting
your YubiKey into your computer.</p><p>To configure the GPG agent to use your YubiKey upon logging into the system, create a new file at
<code>~/Library/LaunchAgents/gpg-agent.plist</code> with the following contents (<em>Note: this assumes you are
using GPG Suite, which can be installed using <code>brew cask install gpg-suite-no-mail</code></em>):</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token prolog" style="color:#999988;font-style:italic">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">plist</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">PUBLIC</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype string" style="color:#e3116c;font-style:italic">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype string" style="color:#e3116c;font-style:italic">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">plist</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">version</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">1.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dict</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Label</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">gpg-agent</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ProgramArguments</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">array</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">/bin/bash</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">-c</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if pgrep gpg-agent &gt; /dev/null; then killall gpg-agent; fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if pgrep ssh-agent &gt; /dev/null; then killall ssh-agent; fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gpg --card-status all &amp;&gt; /dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">array</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">RunAtLoad</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">true</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dict</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">plist</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Regarding the use of <code>gpg --card-status all &amp;&gt; /dev/null</code>, this seems to be the only reliable
approach we have found to get gpg-agent to use YubiKey when running Big Sur. This command starts
gpg-agent as a daemon if it is not currently running, so it is an implicit way of starting
gpg-agent. Otherwise, using something like <code>gpg-agent --daemon</code> would work equally as well.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="using-pinentry-optional">Using pinentry (optional)<a class="hash-link" href="#using-pinentry-optional" title="Direct link to heading">‚Äã</a></h3><p>Instead of prompting you in a terminal, you can have gpg-agent use an
external program.  This might be useful if you want to use your editor
for commits.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">brew install pinentry-mac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;pinentry-program /usr/local/bin/pinentry-mac&#x27; &gt;&gt; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~/.gnupg/gpg-agent.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpgconf --kill gpg-agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --card-status all &amp;&gt; /dev/null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If you use this, you do not need to set <code>GPG_TTY</code>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="verifying-your-yubikey">Verifying Your YubiKey<a class="hash-link" href="#verifying-your-yubikey" title="Direct link to heading">‚Äã</a></h2><p>To verify a YubiKey is genuine, open a <a href="https://support.yubico.com/support/solutions/articles/15000009591-how-to-confirm-your-yubico-device-is-genuine-with-u2f" target="_blank" rel="noopener noreferrer">browser with U2F support</a> to <a href="https://www.yubico.com/genuine/" target="_blank" rel="noopener noreferrer">https://www.yubico.com/genuine/</a>. (Chrome, FireFox and Safari work). Insert a Yubico device, and select Verify Device to begin the process. Touch the YubiKey when prompted, and if asked, allow it to see the make and model of the device. If you see Verification complete, the device is authentic.</p><p>This website verifies the YubiKey&#x27;s device attestation certificates signed by a set of Yubico CAs, and helps mitigate <a href="https://media.defcon.org/DEF%20CON%2025/DEF%20CON%2025%20presentations/DEF%20CON%2025%20-%20r00killah-and-securelyfitz-Secure-Tokin-and-Doobiekeys.pdf" target="_blank" rel="noopener noreferrer">supply chain attacks</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="setting-the-yubikey-user-and-admin-pin-codes">Setting the YubiKey User and Admin PIN codes<a class="hash-link" href="#setting-the-yubikey-user-and-admin-pin-codes" title="Direct link to heading">‚Äã</a></h2><p>The YubiKey ships with a default User PIN of <code>123456</code> and a default Admin PIN of <code>12345678</code>. For security purposes, these PIN codes must be changed before use.</p><p>The User PIN is the PIN that will be used on a daily basis when signing commits or authenticating. The Admin PIN is used to make changes to the YubiKey itself, such as when enabling or disabling touch-mode.</p><ol><li>Insert your YubiKey into the USB port.</li><li>Enter the command: <code>gpg --card-edit</code></li><li>Enter the command: <code>admin</code></li><li>Enter the command: <code>passwd</code></li><li>To change the Admin PIN enter: <code>3</code></li><li>Enter the default PIN of <code>12345678</code></li><li>Enter your new 8 digit Admin PIN, add it to 1Password, and confirm it.</li><li>To change the User PIN enter: <code>1</code></li><li>Enter the default PIN of <code>123456</code></li><li>Enter your new 6 digit User PIN, add it to 1Password, and confirm it.</li><li>Enter the command: <code>q</code></li><li>Enter the command: <code>name</code></li><li>Enter your surname and given name (these should match the name provided when you generate your certificate)</li><li>Enter the command <code>q</code> to exit the admin menu</li></ol><p>If at any point you make a mistake and need to reset your YubiKey PIN(s), you can do so with the command: <code>ykman openpgp reset</code></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="key-generation">Key Generation<a class="hash-link" href="#key-generation" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="generating-a-gpg-private-key">Generating a GPG Private Key<a class="hash-link" href="#generating-a-gpg-private-key" title="Direct link to heading">‚Äã</a></h3><p>This will generate the secret key.</p><ol><li>Enter the GPG command: <code>gpg --expert --full-gen-key</code></li><li>When prompted to specify the key type, enter 1 (for &quot;RSA and RSA (Default)&quot;) and press Enter</li><li>Specify the size of key you want to generate. This key size will also apply to subkey size. Do one of the following:<ul><li>For a YubiKey 4 series, enter 2048 and press Enter</li><li>For a YubiKey 5 series, enter 4096 and press Enter</li></ul></li><li>Specify an indefinite expiration date of the key by pressing press Enter. Verify the expiration date when prompted</li><li>Now you will enter your user information. Enter your Real Name and press Enter. Be sure to enter both your first and last name</li><li>Enter your <code>@truss.works</code> Email Address and press Enter. If you do not perform commits with your @truss.works email address, we‚Äôll add your GitHub email address to the key in a later step.</li><li>If desired, enter a Comment about this key (e.g., ‚Äúwork‚Äù), and press Enter. (To leave the comment blank, just press Enter)</li><li>Review the information you entered, make any changes if necessary. If all information is correct, enter O (for Okay) and press Enter</li><li>A dialog box is displayed so you can enter the passphrase for your key. While the key is being generated, move your mouse around or type on the keyboard to gain enough entropy. When the key has been generated, you will see several messages displayed. Make a note of the key ID, that is displayed in the message such as <code>gpg: key 1234ABC marked as ultimately trusted</code>. The key ID in this case is 1234ABC and you will need this key ID to perform other operations.</li></ol><p>If at any point you forget the key ID, enter <code>gpg --list-signatures</code> to display it.</p><p>It‚Äôs time to add the subkeys. Some of these may already be created. You can check what‚Äôs been created by checking your keys.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-a-s-signing-subkey">Add a (S) signing subkey<a class="hash-link" href="#add-a-s-signing-subkey" title="Direct link to heading">‚Äã</a></h3><p>This will be used for git commit and tag signing.</p><ol><li>Enter the GPG command: <code>gpg --expert --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</li><li>Enter the command: <code>addkey</code></li><li>You are prompted to specify the type of key. Enter 4 for RSA (sign only)</li><li>Specify the size of the key that you want to generate. Do one of the following:<ul><li>For a YubiKey 4 series, enter 2048 and press Enter</li><li>For a YubiKey 5 series, enter 4096 and press Enter</li></ul></li><li>Specify the expiration of the authentication key (this should be the same expiration as the key). Unless you have a specific need, this should be set to indefinite</li><li>When prompted to save your changes, enter y (yes)<ul><li>If prompted to replace the existing key, select no.</li></ul></li><li>Enter the passphrase for the key. Note that this is the passphrase, and not the User PIN or Admin PIN</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-an-a-authentication-subkey">Add an (A) authentication subkey<a class="hash-link" href="#add-an-a-authentication-subkey" title="Direct link to heading">‚Äã</a></h3><p>This subkey will be used to pull private git repos via SSH and may be used to authenticate to any SSH host.</p><ol><li><p>Enter the GPG command: <code>gpg --expert --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</p></li><li><p>Enter the command: <code>addkey</code></p></li><li><p>You are prompted to specify the type of key. Enter 8 for RSA</p></li><li><p>To add an authentication key, toggle all options until Authenticate is the only selection, and then Q if you are finished.</p><p>This is interface has a unique design where you need to toggle things on and off to get the desired result.
The default state shows <strong>Sign Encrypt</strong> active.</p><img loading="lazy" src="images/yubikey-sign-encrypt.png" alt="default state" width="400" class="img_E7b_"><p>Enter <code>A</code> to enable <strong>Authenticate</strong>. Enter <code>E</code> and <code>S</code> (separately) to disable <strong>Sign</strong> and <strong>Encrypt</strong>.</p><img loading="lazy" src="images/yubikey-select-authenticate.png" alt="authenticate" width="400" class="img_E7b_"></li><li><p>Hit <code>Q</code> to finish.</p></li><li><p>Specify the size of the key that you want to generate. Do one of the following:</p><ul><li>For a YubiKey 4 series, enter 2048 and press Enter</li><li>For a YubiKey 5 series, enter 4096 and press Enter</li></ul></li><li><p>Specify the expiration of the authentication key (this should be the same expiration as the key). Unless you have a specific need, this should be set to indefinite</p></li><li><p>When prompted to save your changes, enter y (yes)</p><ul><li>If prompted to replace the existing key, select no.</li></ul></li><li><p>Enter the passphrase for the key. Note that this is the passphrase, and not the User PIN or Admin PIN</p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="check-your-keys">Check Your Keys<a class="hash-link" href="#check-your-keys" title="Direct link to heading">‚Äã</a></h2><p>After adding the subkeys, enter the GPG command: <code>gpg --expert --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</p><p>The optimal output should look similar to this, showing an individual subkey for <strong>E (Encrypt)</strong>, <strong>A (Authenticate)</strong>, and <strong>S (Sign)</strong> in the YubiKey keychain.</p><img loading="lazy" src="images/yubikey-check-keys.png" alt="keycheck" width="500" class="img_E7b_"><h2 class="anchor anchorWithStickyNavbar_mojV" id="deleting-a-secret-key">Deleting a secret key<a class="hash-link" href="#deleting-a-secret-key" title="Direct link to heading">‚Äã</a></h2><p>If you add one too many keys, you can delete them.</p><ol><li>Enter the GPG command: <code>gpg --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</li><li>Enter <code>key 1</code> (This will select the first key but you can select any key)</li><li>After pressing enter an <em>asterisk</em> will appear next to that key</li><li>Enter the command: <code>delkey</code></li><li>It will then ask if you want to delete the key. Select yes</li><li>Enter your passphrase</li><li>Verify the key is deleted</li><li>Repeat if multiple keys need to be deleted</li></ol><p><em>Note that if you have not imported the keys to your YubiKey yet then your output will not include those card-no details.</em></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="creating-backups">Creating Backups<a class="hash-link" href="#creating-backups" title="Direct link to heading">‚Äã</a></h2><p>These steps are optional and will help to configure a new YubiKey should yours become lost or damaged. While you could start from scratch, and should in some cases, this will provide the quickest path to recovery.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-a-backup-of-your-secret-keys-optional">Create a backup of your secret keys (optional)<a class="hash-link" href="#create-a-backup-of-your-secret-keys-optional" title="Direct link to heading">‚Äã</a></h3><p>This will create a backup of the secret key and subkeys.</p><ol><li>Insert the YubiKey into the USB port</li><li>Enter the GPG command: <code>gpg --export-secret-key --armor 1234ABC &gt;&gt; /path/to/secret.key</code> (where 1234ABC is the key ID of your key)</li><li>Enter the GPG command: <code>gpg --export-secret-subkeys &gt;&gt; /path/to/secret.sub.key --armor 1234ABC</code> (where 1234ABC is the key ID of your key)</li><li>Store these files in 1Password and delete them from your system.</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-a-backup-of-your-public-key-optional">Create a backup of your public key (optional)<a class="hash-link" href="#create-a-backup-of-your-public-key-optional" title="Direct link to heading">‚Äã</a></h3><p>Save the public key in 1Password for reference. This is not secret material, but it can be helpful to have it saved alongside the secret key material. You can export it using the following command:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --export --armor 1234ABC &gt; public.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="create-a-revocation-certificate-optional">Create a revocation certificate (optional)<a class="hash-link" href="#create-a-revocation-certificate-optional" title="Direct link to heading">‚Äã</a></h3><p>This will allow you to revoke the key should your secret key becomes lost or compromised. This step is not required in our current use case because we‚Äôre not uploading our certificates to a public keyserver. This may be required for future use at some point, so we‚Äôll leave this in place for the time being.</p><ol><li>Enter the command: <code>gpg --gen-revoke 1234ABC &gt; 1234ABC-revoke-cert.asc</code> (where 1234ABC is the key ID of your key)</li><li>Enter the command: <code>Y</code></li><li>Select a reason for revocation. The reason really doesn‚Äôt matter for our use case. I usually select 3 = Key is no longer used</li><li>Enter an optional description, or hit enter to continue. This field is not important.</li><li>Enter the command: <code>Y</code></li><li>Store this file in 1Password and delete it from your system.</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-the-yubikey">Configuring the YubiKey<a class="hash-link" href="#configuring-the-yubikey" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="importing-the-keys-to-your-yubikey">Importing the keys to your YubiKey<a class="hash-link" href="#importing-the-keys-to-your-yubikey" title="Direct link to heading">‚Äã</a></h3><p>This will <em>destructively</em> move the secret key as well as the three subkeys to the YubiKey from the local keystore, via the <code>keytocard</code> command. In this case, <em>destructively</em> is a good thing because it will require the YubiKey to be inserted to perform any of these functions.</p><ol><li><p>Insert the YubiKey into the USB port</p></li><li><p>Enter the GPG command: <code>gpg --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</p></li><li><p>Enter the command: <code>toggle</code> to switch to the public key listing (there will be no visible output)</p></li><li><p>Enter the command: <code>key 1</code> (to select subkey 1)</p><p><em>The interface is not intuitive here. Typing <code>key 1</code> will select the first subkey (ssb). An * next to the key will indicate that it has been selected:</em></p><img loading="lazy" src="images/yubikey-key-import.png" alt="check import" width="500" class="img_E7b_"></li><li><p>Enter the command: <code>keytocard</code></p></li><li><p>When prompted where to store the key, select <code>2</code>. This will move the <em>encryption</em> subkey to the YubiKey</p></li><li><p>Enter the command: <code>key 1</code> (to deselect subkey 1)</p></li><li><p>Enter the command: <code>key 2</code> (to select subkey 2)</p></li><li><p>Enter the command: <code>keytocard</code></p></li><li><p>When prompted where to store the key, select 1. This will move the <em>signing</em> subkey to the YubiKey</p></li><li><p>Enter the command: <code>key 2</code> (to deselect subkey 2)</p></li><li><p>Enter the command: <code>key 3</code> (to select subkey 3)</p></li><li><p>Enter the command: <code>keytocard</code></p></li><li><p>When prompted where to store the key, select 3. This will move the <em>authentication</em> subkey to the YubiKey</p></li><li><p>Enter the command: <code>save</code> to save the configuration and exit to the CLI.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="adding-additional-email-addresses">Adding Additional Email Addresses<a class="hash-link" href="#adding-additional-email-addresses" title="Direct link to heading">‚Äã</a></h2><ol><li>Insert the YubiKey into the USB port</li><li>Enter the GPG command: <code>gpg --expert --edit-key 1234ABC</code> (where 1234ABC is the key ID of your key)</li><li>Enter the command: <code>adduid</code></li><li>Enter your Name</li><li>Enter the Additional Email Address</li><li>Enter a comment if desired</li><li>Enter (<code>O</code>)kay</li><li>Enter your PIN if prompted</li><li>Enter the command: <code>quit</code></li><li>When prompted to save your changes, enter y (yes). You have now saved the additional email address to your YubiKey</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="uids-and-the-primary-key">UIDs and the primary key<a class="hash-link" href="#uids-and-the-primary-key" title="Direct link to heading">‚Äã</a></h3><p>User IDs are attached to the primary key (aka: master key). Subkeys do not contain any user ID
information. Therefore, if you want to change the user ID information, you only need to:</p><ol><li>Modify the primary key (after importing from the key saved in 1Password) to include whatever
user ID(s) you choose.</li><li>Re-generate GPG ASCII armor.</li><li>Upload the new GPG ASCII armor to GitHub.</li><li>Re-import the new public key into your local keychain.</li></ol><p>This process does not require modification of anything on the YubiKey. You can verify the results
of your changes by running <code>gpg --card-status</code> while you do and do not have the public key imported
into your local keychain. For example:</p><p>Without importing public key into your local GPG keychain:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --card-status | grep key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">URL of public key : [not set]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Signature key ....: AAAA BBBB CCCC DDDD EEEE  FFFF 0000 1111 2345 6CDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encryption key....: BBBB CCCC DDDD EEEE FFFF  0000 1111 2222 3234 5BCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authentication key: CCCC DDDD EEEE FFFF 0000  1111 2222 3333 4456 7DEF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">General key info..: [none]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>With importing public key into your local GPG keychain (note the &quot;General key info&quot; now shows User
ID information):</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --card-status | grep key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">URL of public key : [not set]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Signature key ....: AAAA BBBB CCCC DDDD EEEE  FFFF 0000 1111 2345 6CDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encryption key....: BBBB CCCC DDDD EEEE FFFF  0000 1111 2222 3234 5BCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authentication key: CCCC DDDD EEEE FFFF 0000  1111 2222 3333 4456 7DEF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">General key info..: sub  rsa4096/3456CDE 2020-10-14 Human Person &lt;noreply@truss.works&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-ssh">Configuring SSH<a class="hash-link" href="#configuring-ssh" title="Direct link to heading">‚Äã</a></h2><ol><li>Insert the YubiKey into the USB port</li><li>Configure your environment</li><li>Enter the GPG command: <code>gpg --export-ssh-key 1234ABC</code> (where 1234ABC is the key ID of your key)</li><li>This will return a string that begins with: ssh-rsa and ends with openpgp:0x1234ABC</li><li>To use this key to push to GitHub, copy this key into your <a href="https://github.com/settings/keys" target="_blank" rel="noopener noreferrer">GitHub account</a>. If you need to use it to SSH directly into a host, you will need to add it to an authorized-keys file.</li><li>Verify the SSH key with the command: ssh-add -L</li><li>This should verify that the SSH key is available on your yubikey. If the string ends in <code>cardno:000YXXXXXXXX</code>, then it is on the YubiKey.</li><li>Restart the SSH services if necessary with the following commands: source ~/.bash_profile or  source ~/.bashrc</li><li>When connecting via SSH, you should be prompted for your YubiKey User PIN<ul><li>On first use, it may also prompt for the YubiKey passphrase.</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-git-commit-signing">Configuring git commit Signing<a class="hash-link" href="#configuring-git-commit-signing" title="Direct link to heading">‚Äã</a></h2><ol><li><p>Insert the YubiKey into the USB port</p></li><li><p>Enter the GPG command: <code>gpg --export --armor 1234ABC</code> (where 1234ABC is the key ID of your secret key)</p></li><li><p>This will export your public key, which is derived from the secret key. Copy this entire key including the lines:</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-----BEGIN PGP PUBLIC KEY BLOCK-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----END PGP PUBLIC KEY BLOCK-----</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>Add this key into GitHub</p></li><li><p>Add the key into your git config with the following command: <code>git config --global user.signingkey 1234ABC</code> (where 1234ABC is the key ID of your key)</p></li><li><p>Add your name to your git config with the following command: <code>git config --global user.name ‚Äúyour name‚Äù</code> (this should match the name provided when you generate your certificate)</p></li><li><p>Add your email to your git config with the following command: <code>git config --global user.email youremail@truss.works</code> (this should match the email that you push commits with)</p></li><li><p>Configure Git client to always sign commits: <code>git config --global commit.gpgsign true</code></p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-github">Configuring Github<a class="hash-link" href="#configuring-github" title="Direct link to heading">‚Äã</a></h2><p><em>This step is not sequential and is linked in previous steps. If you‚Äôve reached this point in the document, you should have already completed this.</em></p><ol><li>Sign into the GitHub web interface</li><li>Click on the user icon in the upper right hand corner and select settings</li><li>Select SSH and PGP Keys</li><li>Add an SSH Key and enter the value generated in Configuring SSH</li><li>Add a new GPG Key and enter the value generated in Configuring git signing</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="using-github-desktop">Using Github Desktop<a class="hash-link" href="#using-github-desktop" title="Direct link to heading">‚Äã</a></h3><ol><li>echo no-tty &gt;&gt; ~/.gnupg/gpg.conf</li><li>Specify GPG path for clients: <code>git config --global gpg.program /usr/local/bin/gpg</code></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="verifying-your-configuration">Verifying your configuration<a class="hash-link" href="#verifying-your-configuration" title="Direct link to heading">‚Äã</a></h2><p>To verify that you have both GPG and SSH properly configured, perform the following steps.</p><ol><li><p>Close out of all terminals. This is to ensure that any terminal/shell configuration you made is
saved to disk rather than only configured for a shell session. Re-open your terminal of choice.</p></li><li><p>Remove your YubiKey.</p></li><li><p>Verify that the only data from your key in your GPG keyring is public key information. If you
see <code>sec</code> (secret) next to your primary key and/or <code>ssb</code> (secret subkey), then you still have
secret key material in your keyring and/or on your system. Follow the instructions in the
<a href="#deleting-local-secret-key-material">deleting local secret key material</a> section if this is the
case.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --list-keys 1234ABC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub   rsa4096 2020-10-13 [SC]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      REALLYEXTRALONGSTRINGTHATENDSWITH1234ABC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid           [ultimate] Human Person &lt;noreply@truss.works&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub   rsa4096 2020-10-13 [E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub   rsa4096 2020-10-14 [S]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sub   rsa4096 2020-10-14 [A]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>You can also run these commands to see if you have any secret key material in your keyring.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --export-secret-key --armor 1234ABC | gpg --list-packets --verbose | grep skey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg --export-secret-subkeys --armor 1234ABC | gpg --list-packets --verbose | grep skey</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>2 things will tell you that the secret key material is not present:</p><ol><li>GPG will not ask for your passphrase. If secret key material was present, it would have asked
for a passphrase so that it could decrypt the secret key material.</li><li>You have no output. If you had output, it would look something like <code>skey[2]: [v4 protected]</code>. If you do have <code>skey</code> in your output, then you have secret key material on your
local system. If no secret key material is on your local system, then you should only have
<code>pkey</code> values (if you remove the <code>grep</code> command).<ul><li>skey: secret key</li><li>pkey: public key</li></ul></li></ol></li><li><p>Re-insert your YubiKey.</p></li><li><p>Initialize your YubiKey in whatever way you configured it. If you made a separate script, run
that. If you need to open a new terminal, do that. Whatever approach you take, it should be the
thing that does a <code>killall</code> on gpg-agent and ssh-agent, followed by <code>gpg --card-status all &amp;&gt; /dev/null</code>.</p></li><li><p>Verify that the secret key data is now available to GPG. This is what it looks like when the key
material only exists on the YubiKey (not loaded from secret material stored on your system):</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --card-status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;snip&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sec#  rsa4096/1234ABC  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/2345BCD  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/3456CDE  created: 2020-10-14  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/4567DEF  created: 2020-10-14  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If you do not see <code>sec#</code> next to the primary key and do not see <code>ssb&gt;</code> next to the subkeys, then
the secret key material may exist on the YubiKey, but GPG is falling back to locally
stored/loaded secret key material. If this is the case (incorrect configuration), it will look
like this. Note there is no <code>#</code> after <code>sec</code> and no <code>&gt;</code> after <code>ssb</code>:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --card-status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;snip&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sec   rsa4096/1234ABC  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb   rsa4096/2345BCD  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb   rsa4096/3456CDE  created: 2020-10-14  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb   rsa4096/4567DEF  created: 2020-10-14  expires: never</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If you do not see the <code>#</code> and <code>&gt;</code> characters after <code>sec</code> and <code>ssb</code>, then the secret key material
needs to be removed from your local system. See the <a href="#deleting-local-secret-key-material">deleting local secret key
material</a> section if this is the case.</p></li><li><p>Verify that the SSH agent can use the subkey used for authentication. If you do not see an entry
with <code>cardno</code> near the end, then the SSH agent is not correctly configured to use the
authentication subkey on your YubiKey.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-add -L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-rsa AAAAB3&lt;snip&gt;2yyu4Q== cardno:000YXXXXXXXX</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>Verify that the GPG agent can use the subkey used for signing. You should see a PGP signature
that is generated by running this test. If not, then the GPG agent is not correctly configured
to use the signing subkey on your YubiKey.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo &quot;test&quot; | gpg --clearsign</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg: using &quot;REALLYEXTRALONGSTRINGTHATENDSWITH1234ABC&quot; as default secret key for signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----BEGIN PGP SIGNED MESSAGE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hash: SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----BEGIN PGP SIGNATURE-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iQIzBAEBCAAdFiEE9zVLjb+li/0UKVrGlXbmxIOHrVoFAl+HbEgACgkQlXbmxIOH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rVqu7g//RtdsYwTS5+k2pF+IEUyZk0LXnjdnRZhEjRT9M34d/Sh6jhgYZPLx7NLp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+YSKRLnMpxx1JbS/ffkmq9zibeODyeilO30zh6xC5TsIZak489i0jl1wTo4J7DGf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4VqoTqNwc3RE8FTUYFGX6trgbjeu7q7yoo6yEGWaxLhR0/TRTU0/eREgAsdwxR+6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7TkmhxIXV7zO6pe4wLddvJzOM/KZyaumv1dJ0nX3U4q50IqXf+He3WGuetZUci80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mIsUfv7TH2Bo3kIqm/cTtcpjiXrIXrfpFxC5o9mGII5tw3YzXw0chGm7X5q2yyTl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7DNpJE/s6kXei45UER/NtyKH6N63GRN9c3aBs4ARGIU/hAlH5SrKOlRCTYENh0HC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dGJZ68LBvpUNujtU/8TZaPPz0cfhb1hhOa8Ruoo9DwujpScjgpKgpuVxCM+YZB2l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8/mGGhAzXDIhE8JDjEKk2bHaTy2gulwqTDjuv572qwwJvYkQT3wmx8dp0jswL0fj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NdjVPs47PGNsLkrVnudzx4VkrS/l8+1g2jn2jCsEbwzjSqWsDYEDAbgopNC4wUQC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LvXG4r7r2JS6rlmE9rOMlsx3IW16eIGmRCunbP6oOzPJkFn7rBEpl8U37CVdU46F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hrWMtDgZrBwtz9oklxMfnQMWq+4lCEVuxT6nMJ8FeqxxAnmhVUc=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=7pFx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----END PGP SIGNATURE-----</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>Verify that the GPG agent can use the subkey used for encryption. This command will create
content (&quot;hello world&quot;), encrypt it from standard input to standard output, and then decrypt it
from standard input to standard output. The final line should be the input string (&quot;hello
world&quot;).</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ echo &quot;hello world&quot; | gpg --recipient 1234ABC -o- --encrypt - | gpg --decrypt -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg: encrypted with 4096-bit RSA key, ID 2345BCD, created 2020-10-13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Human Person &lt;noreply@truss.works&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello world</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>You may get an error such as the following. This is transient. As long as the output ends with
the string that you echoed out, then everything is working properly.</p><div class="codeBlockContainer_I0IT language-plaintext theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-plaintext codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gpg: error opening lockfile &#x27;/Users/human/.gnupg/pubring.kbx.lock&#x27;: No such file or directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gpg: lockfile disappeared</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="deleting-local-secret-key-material">Deleting local secret key material<a class="hash-link" href="#deleting-local-secret-key-material" title="Direct link to heading">‚Äã</a></h3><p>During this process, you may find that you have secret key material on your system even though you
thought you removed it. For instance, this may happen when using <code>keytocard</code>. While it is supposed
to be destructive and remove secret key material from your system (leaving it only on your
YubiKey), this is not always the case despite what the documentation indicates. Therefore, you may
have to manually remove the secret keys from your system. To do that, follow this procedure:</p><ol><li><p>Remove the YubiKey from the computer.</p></li><li><p>Delete the <strong>secret</strong> key material from your system. <em>Do not remove your <strong>public</strong> key material
or else your GPG agent will not be able to identify the correct secret keys to use on your
YubiKey.</em></p><p>To delete your primary secret key material, run the following command:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --delete-secret-key 1234ABC</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If for some reason that command does not fully delete the subkey secret key material, you can
delete that data with this procedure. First identify the keygrips for each subkey. Then delete
them.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg --with-keygrip --list-secret-keys &quot;1234ABC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sec#  rsa4096 2020-10-13 [SC]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      REALLYEXTRALONGSTRINGTHATENDSWITH1234ABC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Keygrip = REALLYEXTRALONGSTRINGTHATENDSWITH5677EFA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid           [ultimate] Human Person &lt;noreply@truss.works&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096 2020-10-13 [E]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Keygrip = REALLYEXTRALONGSTRINGTHATENDSWITH2345BCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096 2020-10-14 [S]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Keygrip = REALLYEXTRALONGSTRINGTHATENDSWITH3456CDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096 2020-10-14 [A]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Keygrip = REALLYEXTRALONGSTRINGTHATENDSWITH4567DEF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Once you have the subkey keygrips, delete the secret subkey material:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg-connect-agent &quot;delete_key REALLYEXTRALONGSTRINGTHATENDSWITH2345BCD&quot; /bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg-connect-agent &quot;delete_key REALLYEXTRALONGSTRINGTHATENDSWITH3456CDE&quot; /bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ gpg-connect-agent &quot;delete_key REALLYEXTRALONGSTRINGTHATENDSWITH4567DEF&quot; /bye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OK</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>Insert YubiKey back into the computer.</p></li><li><p>Ensure that the signature key, encryption key, and authentication key are set. Ensure that each
of these keys have a <code>card-no</code> entry next to them.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gpg --card-status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;snip&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Signature key ....: AAAA BBBB CCCC DDDD EEEE  FFFF 0000 1111 2345 6CDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      created ....: 2020-10-14 00:06:51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encryption key....: BBBB CCCC DDDD EEEE FFFF  0000 1111 2222 3234 5BCD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      created ....: 2020-10-13 23:59:43</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authentication key: CCCC DDDD EEEE FFFF 0000  1111 2222 3333 4456 7DEF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      created ....: 2020-10-14 00:07:50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">General key info..: sub  rsa4096/3456CDE 2020-10-14 Human Person &lt;noreply@truss.works&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sec#  rsa4096/1234ABC  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/2345BCD  created: 2020-10-13  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/3456CDE  created: 2020-10-14  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssb&gt;  rsa4096/4567DEF  created: 2020-10-14  expires: never</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       card-no: 000Y XXXXXXXX</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li></ol><p>Note: if you delete the public keys from your local system, then <code>gpg</code> operations will fail when
using your YubiKey.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="subkey-stubs">Subkey stubs<a class="hash-link" href="#subkey-stubs" title="Direct link to heading">‚Äã</a></h3><p><code>~/.gnupg/private-keys-v1.d</code> will contain the key stubs for each of the subkeys. These do not
contain secret key material, but instead tell GPG that the secret key material is on your YubiKey.
To verify this, you can look at the strings in that file and search for a match for
<code>shadowed-private-key</code>. The output will look similar to the following:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ strings filename.key| grep shadowed-private-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(20:shadowed-private-key(3:rsa(1:n513:</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If you see something like the output above, then the file is a stub key, which does not contain the
secret key material. Instead, it indicates that the secret key material is on your YubiKey.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-the-yubikey">Using The YubiKey<a class="hash-link" href="#using-the-yubikey" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="signing-git-commits">Signing git commits<a class="hash-link" href="#signing-git-commits" title="Direct link to heading">‚Äã</a></h3><ol><li><p>Insert the YubiKey into the USB port</p></li><li><p>To manually sign a git commit (commits should already be signed automatically if you&#x27;ve enabled it in your git config):</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ git commit -a -S -m &#x27;Fixed a small undocumented procedure that made foo crash&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>To manually sign a git tag:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ git tag foo-1.0 -s -m &#x27;Release 1.0 of foo&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></li><li><p>When signing, you should be prompted to enter your YubiKey User PIN</p></li><li><p>If you‚Äôve enabled touch mode, touch the YubiKey to complete the operation</p></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="enabling-touch-only-mode-optional">Enabling touch-only mode (optional)<a class="hash-link" href="#enabling-touch-only-mode-optional" title="Direct link to heading">‚Äã</a></h3><p>It is possible that your YubiKey could be activated by malware on your machine, which could conceivably use a keylogger to capture your PIN and use that information to automatically sign commits and tags when you&#x27;re not aware.</p><p>If enabling touch-only mode, it is recommended to perform this step after you‚Äôve confirmed that everything else is working.</p><ol><li>Enter the command: <code>ykman openpgp set-touch aut on</code></li><li>Enter: <code>yes</code></li><li>Enter the 8 digit Admin PIN to confirm the setting change</li></ol><p>NOTE: When touch mode is enabled, operations will appear to stall. This is the only prompt that you will receive to touch your YubiKey. Failure to touch the YubiKey for authentication will result in failure of the operation. You can also disable touch-only mode with the following command: <code>ykman openpgp set-touch aut off</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="disabling-otp-one-time-password">Disabling OTP (One Time Password)<a class="hash-link" href="#disabling-otp-one-time-password" title="Direct link to heading">‚Äã</a></h3><p>Disabling the OTP is possible using the YubiKey Manager, and does not affect any other functionality of the YubiKey.</p><p>A side effect of the YubiKey is the Yubisneeze. The YubiKey will generate and paste a password to your screen nearly every time that you touch it.</p><ol><li>Insert the YubiKey into the USB port</li><li>Enter the command: <code>ykman config usb --disable otp</code></li><li>Enter the command: <code>Y</code> to confirm</li></ol><p>To re-enable otp, use the command: <code>ykman config usb --enable otp</code></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="github-apps">GitHub Apps<a class="hash-link" href="#github-apps" title="Direct link to heading">‚Äã</a></h2><p>GitHub Desktop does not support commit signing. In fact, it appears that GitHub wants to keep it this way. That said, if GitHub is configured with your keys correctly, GitHub Desktop may respect your settings and sign commits. We‚Äôre still testing this.</p><p>Gitkraken directly <a href="https://support.gitkraken.com/git-workflows-and-extensions/commit-signing-with-gpg/" target="_blank" rel="noopener noreferrer">supports</a> commit signing.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="troubleshooting">Troubleshooting<a class="hash-link" href="#troubleshooting" title="Direct link to heading">‚Äã</a></h2><p><em>The YubiKey is not detected when signing a commit or pulling a private repo via SSH.</em></p><ol><li>Ensure that the environment has been configured correctly</li><li>Run <code>source ~/.bashrc</code> or <code>source ~./zshrc</code></li></ol><p><em>The YubiKey appears to hang when performing operations and then the operations time out.</em></p><p>Touch-only has been enabled. There is no prompt that the YubiKey is waiting to be touched. Run the operation again and touch the YubiKey when the operation hangs. You may see something similar to this:</p><img loading="lazy" src="images/yubikey-otp-error.png" alt="otp error" width="450" class="img_E7b_"></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/tutorials/yubikey-configuration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/infrasec/tutorials/your_first_lambda_function"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deploying your first AWS Lambda Function with Go and Terraform</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/infrasec/tutorials/yubikey-sso"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Single Sign-On</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#purchasing-and-distribution" class="table-of-contents__link toc-highlight">Purchasing and Distribution</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a><ul><li><a href="#hardware-requirements" class="table-of-contents__link toc-highlight">Hardware Requirements</a></li><li><a href="#software-requirements" class="table-of-contents__link toc-highlight">Software Requirements</a></li></ul></li><li><a href="#configuring-your-environment" class="table-of-contents__link toc-highlight">Configuring Your Environment</a><ul><li><a href="#using-pinentry-optional" class="table-of-contents__link toc-highlight">Using pinentry (optional)</a></li></ul></li><li><a href="#verifying-your-yubikey" class="table-of-contents__link toc-highlight">Verifying Your YubiKey</a></li><li><a href="#setting-the-yubikey-user-and-admin-pin-codes" class="table-of-contents__link toc-highlight">Setting the YubiKey User and Admin PIN codes</a></li><li><a href="#key-generation" class="table-of-contents__link toc-highlight">Key Generation</a><ul><li><a href="#generating-a-gpg-private-key" class="table-of-contents__link toc-highlight">Generating a GPG Private Key</a></li><li><a href="#add-a-s-signing-subkey" class="table-of-contents__link toc-highlight">Add a (S) signing subkey</a></li><li><a href="#add-an-a-authentication-subkey" class="table-of-contents__link toc-highlight">Add an (A) authentication subkey</a></li></ul></li><li><a href="#check-your-keys" class="table-of-contents__link toc-highlight">Check Your Keys</a></li><li><a href="#deleting-a-secret-key" class="table-of-contents__link toc-highlight">Deleting a secret key</a></li><li><a href="#creating-backups" class="table-of-contents__link toc-highlight">Creating Backups</a><ul><li><a href="#create-a-backup-of-your-secret-keys-optional" class="table-of-contents__link toc-highlight">Create a backup of your secret keys (optional)</a></li><li><a href="#create-a-backup-of-your-public-key-optional" class="table-of-contents__link toc-highlight">Create a backup of your public key (optional)</a></li><li><a href="#create-a-revocation-certificate-optional" class="table-of-contents__link toc-highlight">Create a revocation certificate (optional)</a></li></ul></li><li><a href="#configuring-the-yubikey" class="table-of-contents__link toc-highlight">Configuring the YubiKey</a><ul><li><a href="#importing-the-keys-to-your-yubikey" class="table-of-contents__link toc-highlight">Importing the keys to your YubiKey</a></li></ul></li><li><a href="#adding-additional-email-addresses" class="table-of-contents__link toc-highlight">Adding Additional Email Addresses</a><ul><li><a href="#uids-and-the-primary-key" class="table-of-contents__link toc-highlight">UIDs and the primary key</a></li></ul></li><li><a href="#configuring-ssh" class="table-of-contents__link toc-highlight">Configuring SSH</a></li><li><a href="#configuring-git-commit-signing" class="table-of-contents__link toc-highlight">Configuring git commit Signing</a></li><li><a href="#configuring-github" class="table-of-contents__link toc-highlight">Configuring Github</a><ul><li><a href="#using-github-desktop" class="table-of-contents__link toc-highlight">Using Github Desktop</a></li></ul></li><li><a href="#verifying-your-configuration" class="table-of-contents__link toc-highlight">Verifying your configuration</a><ul><li><a href="#deleting-local-secret-key-material" class="table-of-contents__link toc-highlight">Deleting local secret key material</a></li><li><a href="#subkey-stubs" class="table-of-contents__link toc-highlight">Subkey stubs</a></li></ul></li><li><a href="#using-the-yubikey" class="table-of-contents__link toc-highlight">Using The YubiKey</a><ul><li><a href="#signing-git-commits" class="table-of-contents__link toc-highlight">Signing git commits</a></li><li><a href="#enabling-touch-only-mode-optional" class="table-of-contents__link toc-highlight">Enabling touch-only mode (optional)</a></li><li><a href="#disabling-otp-one-time-password" class="table-of-contents__link toc-highlight">Disabling OTP (One Time Password)</a></li></ul></li><li><a href="#github-apps" class="table-of-contents__link toc-highlight">GitHub Apps</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2022 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5d2e427c.js"></script>
<script src="/assets/js/main.0ef5cc31.js"></script>
</body>
</html>