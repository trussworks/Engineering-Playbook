<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-infrasec/ansible/molecule-primer">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Molecule Primer | Truss Engineering Playbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Molecule Primer | Truss Engineering Playbook"><meta data-rh="true" name="description" content="Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of"><meta data-rh="true" property="og:description" content="Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2dd15489.css">
<link rel="preload" href="/assets/js/runtime~main.3959b18f.js" as="script">
<link rel="preload" href="/assets/js/main.896611c5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering Playbook</b></a><a class="navbar__item navbar__link" href="/docs">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/practices">Practices</a><a class="navbar__item navbar__link" href="/docs/incident-response">Incident Response</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/practices">Engineering Practices</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/appeng">AppEng</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/infrasec">InfraSec</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec">InfraSec Practice</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/adrs">ADRs</a><button aria-label="Toggle the collapsible sidebar category &#x27;ADRs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers">Alert Providers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/infrasec/ansible">Ansible</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ansible/ansible-primer">Ansible Primer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/ansible/molecule-primer">Molecule Primer</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/aws">AWS</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club">Book Club</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap">Project Bootstrap Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs">SSL Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter">InfraSec Practice Charter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ci_cd">CI/CD according to Truss</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra">Good Infrastructure - A Philosophy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev">Professional Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown">Project Teardown Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/terraform">Terraform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Terraform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">InfraSec</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec/ansible"><span itemprop="name">Ansible</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Molecule Primer</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Molecule Primer</h1><p>Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of
experiences and resources you can use when adding testing to your own Ansible roles; take these with a grain of salt.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="molecule-documentation-and-articles">Molecule documentation and articles<a class="hash-link" href="#molecule-documentation-and-articles" title="Direct link to heading">​</a></h2><p>These resources will likely come in handy when trying to get Molecule up and running for yourself:</p><ul><li>Molecule Official Docs: <a href="https://molecule.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://molecule.readthedocs.io/en/latest/</a></li><li>Testing Your Ansible Roles with Molecule (Jeff Geerling):
<a href="https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule" target="_blank" rel="noopener noreferrer">https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule</a></li><li>Test-driven Infrastructure Development with Ansible and Molecule (Jonas Hecht):
<a href="https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/" target="_blank" rel="noopener noreferrer">https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/</a></li><li>Continuous Cloud Infrastructure With Ansible, Molecule, and TravisCI on AWS (Jonas Hecht):
<a href="https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/" target="_blank" rel="noopener noreferrer">https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a class="hash-link" href="#setup" title="Direct link to heading">​</a></h2><p>You will want to use some sort of virtual environment for Molecule; hopefully you&#x27;re already doing this with Ansible
anyway. Using Python 3 as the Python binary is also highly recommended. In addition to what you need for ansible, you
will need these Python modules as well:</p><ul><li>molecule</li><li>molecule<!-- -->[<!-- -->docker<!-- -->]<!-- --> - For testing with docker containers (the default)</li><li>molecule<!-- -->[<!-- -->ec2<!-- -->]<!-- --> - For testing on ec2 instances</li><li>docker-py</li><li>boto</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-role-or-scenario">Creating a role or scenario<a class="hash-link" href="#creating-a-role-or-scenario" title="Direct link to heading">​</a></h2><p>If you’re just about to start making an Ansible role, you can use Molecule to do it and it will automatically build out
the Ansible role directory structure in the Galaxy-expected format in addition to creating the files needed for Molecule
testing. You can do this with:</p><blockquote><p><code>molecule init role -r your-role-name</code></p></blockquote><p>If you just want to add a Molecule scenario (a single test framework) to an already-existing role, go into the role
directory and run this command:</p><blockquote><p><code>molecule init scenario -r your-role-name [ -s scenario-name ]</code></p></blockquote><p>By default, these commands will both create a molecule/ directory, inside which you will find the scenarios for molecule
testing. The only one there by default is the default scenario, but you can add others (if you wanted one with docker,
for instance, and one with EC2). These commands both take a number of command line switches, but the most important one
you’ll probably use is <code>--driver-name</code>: This tells molecule which driver to use for the scenario it is creating; by
default this is docker, but this is where you would put ec2 or vagrant or whatever else if you wanted to test it another
way. See the Molecule docs here for more information:
<a href="https://molecule.readthedocs.io/en/latest/configuration.html#driver" target="_blank" rel="noopener noreferrer">https://molecule.readthedocs.io/en/latest/configuration.html#driver</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h2><p>The main configuration file for Molecule is <code>molecule.yml</code>, which is in the scenario directory. This is where you can
specify the different components you want to use like driver, linter, verifier, etc. It’s also where you’ll set up the
‘platform’; for docker, the platform section describes things like what image to use, while for EC2, this is where you
specify the AMI, instance type, and subnet. The Molecule driver docs above have more details on what can be set here.</p><p>Of special note is that for systemd-based docker images, you will need to use a few extra configuration options; the
bottom of the docker driver docs (<a href="https://molecule.readthedocs.io/en/latest/configuration.html#docker" target="_blank" rel="noopener noreferrer">https://molecule.readthedocs.io/en/latest/configuration.html#docker</a>) has more details.
Since most modern Linux distributions use systemd, you’ll probably need to use this.</p><p>If you have other Ansible roles your role is dependent on, be sure to specify this in the <code>meta/main.yml</code> file in your
Ansible role configuration, and add it to the <code>requirements.yml</code> file in the Molecule scenario directory. Here’s an
example of that file:</p><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token punctuation" style="color:#b6ad9a">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">src</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain">//github.com/trussworks/ansible</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">role</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">aws</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">cloudwatch</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">logs</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">agent</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once you have everything configured, you can make sure that Molecule is plumbed right by running this command:</p><blockquote><p><code>molecule --debug check</code></p></blockquote><p>If this works, you know that at least the Molecule parts are working right.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-in-ec2">Testing in EC2<a class="hash-link" href="#testing-in-ec2" title="Direct link to heading">​</a></h3><p>With EC2, there a couple of other steps you’ll need to take. First, you’ll have to define an EC2_REGION environment
variable like so (this is due to the error described here: <a href="https://github.com/ansible/molecule/issues/1570" target="_blank" rel="noopener noreferrer">https://github.com/ansible/molecule/issues/1570</a>):</p><blockquote><p><code>export EC2_REGION=”us-west-2”</code></p></blockquote><p>Molecule also assumes that the user you’ll be using the log in to your EC2 instance is “ubuntu” by default. With Amazon
Linux 2 and a number of other distros, this will actually be “ec2-user”. This means you’ll have to fix this. You can
find this in <code>molecule/scenario_name/create.yml</code>; look for the “ssh_user” variable and change that to what it needs to
be for your AMI.</p><p>In addition, you’ll also need to provide credentials. I used aws-vault, but I didn’t want to preface <em>all</em> Molecule
commands with aws-vault, so when I ran it, I just prefaced each of my Molecule commands with aws-vault like this
example:</p><blockquote><p><code>aws-vault exec my_aws_profile -- molecule check</code></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-molecule-tests">Running Molecule Tests<a class="hash-link" href="#running-molecule-tests" title="Direct link to heading">​</a></h2><p>You can run Molecule tests all at once or in stages; these are all done with the various subcommands. The ones I ended
up using the most were:</p><ul><li><code>create</code>: This creates the docker container, EC2 instance, or what have you, to allow for further testing.</li><li><code>converge</code>: This attempts to converge the playbook against the created test environment.</li><li><code>verify</code>: This runs the tests you’ve written in, say, Test-infra (more on that a little later). Obviously, if you do
this without converging first, they will likely fail.</li><li><code>destroy</code>: This tears down the created test environment; it’s especially important to do in EC2 so you don’t leave
your instances lying around.</li><li><code>test</code>: This runs the entire test sequence. This includes everything above plus things like linting and an idempotence
check (if you run a converge after a converge, is there anything to do?). It will destroy the test environment as its
last step, so if you want to iterate on an environment, you probably don’t want to use this right away.</li></ul><p>By default, you don’t get a ton of output about the state of your tests -- just a binary yes/no on success for the most
part. If you want more information, you can run with <code>--debug</code>, which will give you plenty of output. When running
Molecule in EC2 I also used <code>--debug</code> to find where Molecule was putting the ssh-key it was generating for its test
instances so I could poke around in them when something wasn’t working.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="writing-tests-in-molecule">Writing Tests in Molecule<a class="hash-link" href="#writing-tests-in-molecule" title="Direct link to heading">​</a></h2><p>By default, Molecule is not testing anything other than the accuracy of your Ansible code -- is it written right and
does it run without generating errors. This doesn’t tell you if it’s actually doing what you want it to, though. For
that, you’ll need to write additional tests. By default, these use Test-Infra
(<a href="https://testinfra.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://testinfra.readthedocs.io/en/latest/</a>); you’ll put these in the <code>molecule/scenario_name/tests</code> directory. You
should see a <code>test_default.py</code> file there already; this test is an example that just makes sure the <code>/etc/hosts</code> file
and root user exist, which is a bare minimum for things to actually work.</p><p>Writing tests for your role is going to depend a lot on what your role is supposed to do. Test-Infra is configured just
by writing Python functions and making assertions; you’ll need to read their docs in order to know how to test what you
want to.</p><p>Molecule does support other verifiers such as Goss and Inspec; see the Molecule docs for more information if you’d like
to use these.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/ansible/molecule-primer.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/infrasec/ansible/ansible-primer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ansible Primer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/infrasec/aws"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AWS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#molecule-documentation-and-articles" class="table-of-contents__link toc-highlight">Molecule documentation and articles</a></li><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#creating-a-role-or-scenario" class="table-of-contents__link toc-highlight">Creating a role or scenario</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a><ul><li><a href="#testing-in-ec2" class="table-of-contents__link toc-highlight">Testing in EC2</a></li></ul></li><li><a href="#running-molecule-tests" class="table-of-contents__link toc-highlight">Running Molecule Tests</a></li><li><a href="#writing-tests-in-molecule" class="table-of-contents__link toc-highlight">Writing Tests in Molecule</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2023 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3959b18f.js"></script>
<script src="/assets/js/main.896611c5.js"></script>
</body>
</html>