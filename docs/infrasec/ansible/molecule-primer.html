<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-infrasec/ansible/molecule-primer" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Molecule Primer | Truss Engineering Playbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Molecule Primer | Truss Engineering Playbook"><meta data-rh="true" name="description" content="Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of"><meta data-rh="true" property="og:description" content="Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ansible","item":"https://playbook.truss.dev/docs/infrasec/ansible/"},{"@type":"ListItem","position":2,"name":"Molecule Primer","item":"https://playbook.truss.dev/docs/infrasec/ansible/molecule-primer"}]}</script><link rel="stylesheet" href="/assets/css/styles.f2629a4b.css">
<script src="/assets/js/runtime~main.978db84b.js" defer="defer"></script>
<script src="/assets/js/main.ee0b65a6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/truss-icon-light.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Engineering Playbook</b></a><a class="navbar__item navbar__link" href="/docs">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/practices">Practices</a><a class="navbar__item navbar__link" href="/docs/incident-response">Incident Response</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/practices"><span title="Engineering Practices" class="linkLabel_WmDU">Engineering Practices</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/appeng"><span title="AppEng" class="categoryLinkLabel_W154">AppEng</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/infrasec"><span title="InfraSec" class="categoryLinkLabel_W154">InfraSec</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec"><span title="InfraSec Practice" class="linkLabel_WmDU">InfraSec Practice</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/infrasec/adrs"><span title="ADRs" class="categoryLinkLabel_W154">ADRs</span></a><button aria-label="Expand sidebar category &#x27;ADRs&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers"><span title="Alert Providers" class="linkLabel_WmDU">Alert Providers</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/infrasec/ansible"><span title="Ansible" class="categoryLinkLabel_W154">Ansible</span></a><button aria-label="Collapse sidebar category &#x27;Ansible&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ansible/ansible-primer"><span title="Ansible Primer" class="linkLabel_WmDU">Ansible Primer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/ansible/molecule-primer"><span title="Molecule Primer" class="linkLabel_WmDU">Molecule Primer</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/infrasec/aws"><span title="AWS" class="categoryLinkLabel_W154">AWS</span></a><button aria-label="Expand sidebar category &#x27;AWS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club"><span title="Book Club" class="linkLabel_WmDU">Book Club</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap"><span title="Project Bootstrap Guide" class="linkLabel_WmDU">Project Bootstrap Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs"><span title="SSL Certificates" class="linkLabel_WmDU">SSL Certificates</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter"><span title="InfraSec Practice Charter" class="linkLabel_WmDU">InfraSec Practice Charter</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ci_cd"><span title="CI/CD according to Truss" class="linkLabel_WmDU">CI/CD according to Truss</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/delivery-pipeline"><span title="Standard Delivery Pipeline" class="linkLabel_WmDU">Standard Delivery Pipeline</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra"><span title="Good Infrastructure - A Philosophy" class="linkLabel_WmDU">Good Infrastructure - A Philosophy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev"><span title="Professional Development" class="linkLabel_WmDU">Professional Development</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown"><span title="Project Teardown Guide" class="linkLabel_WmDU">Project Teardown Guide</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/infrasec/terraform"><span title="Terraform" class="categoryLinkLabel_W154">Terraform</span></a><button aria-label="Expand sidebar category &#x27;Terraform&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/docs/infrasec/tutorials"><span title="Tutorials" class="categoryLinkLabel_W154">Tutorials</span></a><button aria-label="Expand sidebar category &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">InfraSec</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/infrasec/ansible"><span>Ansible</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Molecule Primer</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Molecule Primer</h1></header>
<p>Molecule is the officially supported testing framework for Ansible. For now, this is mostly just a collection of
experiences and resources you can use when adding testing to your own Ansible roles; take these with a grain of salt.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="molecule-documentation-and-articles">Molecule documentation and articles<a href="#molecule-documentation-and-articles" class="hash-link" aria-label="Direct link to Molecule documentation and articles" title="Direct link to Molecule documentation and articles" translate="no">​</a></h2>
<p>These resources will likely come in handy when trying to get Molecule up and running for yourself:</p>
<ul>
<li class="">Molecule Official Docs: <a href="https://molecule.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer" class="">https://molecule.readthedocs.io/en/latest/</a></li>
<li class="">Testing Your Ansible Roles with Molecule (Jeff Geerling):
<a href="https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule" target="_blank" rel="noopener noreferrer" class="">https://www.jeffgeerling.com/blog/2018/testing-your-ansible-roles-molecule</a></li>
<li class="">Test-driven Infrastructure Development with Ansible and Molecule (Jonas Hecht):
<a href="https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/" target="_blank" rel="noopener noreferrer" class="">https://blog.codecentric.de/en/2018/12/test-driven-infrastructure-ansible-molecule/</a></li>
<li class="">Continuous Cloud Infrastructure With Ansible, Molecule, and TravisCI on AWS (Jonas Hecht):
<a href="https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/" target="_blank" rel="noopener noreferrer" class="">https://blog.codecentric.de/en/2019/01/ansible-molecule-travisci-aws/</a></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup" translate="no">​</a></h2>
<p>You will want to use some sort of virtual environment for Molecule; hopefully you&#x27;re already doing this with Ansible
anyway. Using Python 3 as the Python binary is also highly recommended. In addition to what you need for ansible, you
will need these Python modules as well:</p>
<ul>
<li class="">molecule</li>
<li class="">molecule[docker] - For testing with docker containers (the default)</li>
<li class="">molecule[ec2] - For testing on ec2 instances</li>
<li class="">docker-py</li>
<li class="">boto</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="creating-a-role-or-scenario">Creating a role or scenario<a href="#creating-a-role-or-scenario" class="hash-link" aria-label="Direct link to Creating a role or scenario" title="Direct link to Creating a role or scenario" translate="no">​</a></h2>
<p>If you’re just about to start making an Ansible role, you can use Molecule to do it and it will automatically build out
the Ansible role directory structure in the Galaxy-expected format in addition to creating the files needed for Molecule
testing. You can do this with:</p>
<blockquote>
<p><code>molecule init role -r your-role-name</code></p>
</blockquote>
<p>If you just want to add a Molecule scenario (a single test framework) to an already-existing role, go into the role
directory and run this command:</p>
<blockquote>
<p><code>molecule init scenario -r your-role-name [ -s scenario-name ]</code></p>
</blockquote>
<p>By default, these commands will both create a molecule/ directory, inside which you will find the scenarios for molecule
testing. The only one there by default is the default scenario, but you can add others (if you wanted one with docker,
for instance, and one with EC2). These commands both take a number of command line switches, but the most important one
you’ll probably use is <code>--driver-name</code>: This tells molecule which driver to use for the scenario it is creating; by
default this is docker, but this is where you would put ec2 or vagrant or whatever else if you wanted to test it another
way. See the Molecule docs here for more information:
<a href="https://molecule.readthedocs.io/en/latest/configuration.html#driver" target="_blank" rel="noopener noreferrer" class="">https://molecule.readthedocs.io/en/latest/configuration.html#driver</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration" translate="no">​</a></h2>
<p>The main configuration file for Molecule is <code>molecule.yml</code>, which is in the scenario directory. This is where you can
specify the different components you want to use like driver, linter, verifier, etc. It’s also where you’ll set up the
‘platform’; for docker, the platform section describes things like what image to use, while for EC2, this is where you
specify the AMI, instance type, and subnet. The Molecule driver docs above have more details on what can be set here.</p>
<p>Of special note is that for systemd-based docker images, you will need to use a few extra configuration options; the
bottom of the docker driver docs (<a href="https://molecule.readthedocs.io/en/latest/configuration.html#docker" target="_blank" rel="noopener noreferrer" class="">https://molecule.readthedocs.io/en/latest/configuration.html#docker</a>) has more details.
Since most modern Linux distributions use systemd, you’ll probably need to use this.</p>
<p>If you have other Ansible roles your role is dependent on, be sure to specify this in the <code>meta/main.yml</code> file in your
Ansible role configuration, and add it to the <code>requirements.yml</code> file in the Molecule scenario directory. Here’s an
example of that file:</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token punctuation" style="color:#b6ad9a">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">src</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain">//github.com/trussworks/ansible</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">role</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">aws</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">cloudwatch</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">logs</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">agent</span><br></span></code></pre></div></div>
<p>Once you have everything configured, you can make sure that Molecule is plumbed right by running this command:</p>
<blockquote>
<p><code>molecule --debug check</code></p>
</blockquote>
<p>If this works, you know that at least the Molecule parts are working right.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-in-ec2">Testing in EC2<a href="#testing-in-ec2" class="hash-link" aria-label="Direct link to Testing in EC2" title="Direct link to Testing in EC2" translate="no">​</a></h3>
<p>With EC2, there a couple of other steps you’ll need to take. First, you’ll have to define an EC2_REGION environment
variable like so (this is due to the error described here: <a href="https://github.com/ansible/molecule/issues/1570" target="_blank" rel="noopener noreferrer" class="">https://github.com/ansible/molecule/issues/1570</a>):</p>
<blockquote>
<p><code>export EC2_REGION=”us-west-2”</code></p>
</blockquote>
<p>Molecule also assumes that the user you’ll be using the log in to your EC2 instance is “ubuntu” by default. With Amazon
Linux 2 and a number of other distros, this will actually be “ec2-user”. This means you’ll have to fix this. You can
find this in <code>molecule/scenario_name/create.yml</code>; look for the “ssh_user” variable and change that to what it needs to
be for your AMI.</p>
<p>In addition, you’ll also need to provide credentials. I used aws-vault, but I didn’t want to preface <em>all</em> Molecule
commands with aws-vault, so when I ran it, I just prefaced each of my Molecule commands with aws-vault like this
example:</p>
<blockquote>
<p><code>aws-vault exec my_aws_profile -- molecule check</code></p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-molecule-tests">Running Molecule Tests<a href="#running-molecule-tests" class="hash-link" aria-label="Direct link to Running Molecule Tests" title="Direct link to Running Molecule Tests" translate="no">​</a></h2>
<p>You can run Molecule tests all at once or in stages; these are all done with the various subcommands. The ones I ended
up using the most were:</p>
<ul>
<li class=""><code>create</code>: This creates the docker container, EC2 instance, or what have you, to allow for further testing.</li>
<li class=""><code>converge</code>: This attempts to converge the playbook against the created test environment.</li>
<li class=""><code>verify</code>: This runs the tests you’ve written in, say, Test-infra (more on that a little later). Obviously, if you do
this without converging first, they will likely fail.</li>
<li class=""><code>destroy</code>: This tears down the created test environment; it’s especially important to do in EC2 so you don’t leave
your instances lying around.</li>
<li class=""><code>test</code>: This runs the entire test sequence. This includes everything above plus things like linting and an idempotence
check (if you run a converge after a converge, is there anything to do?). It will destroy the test environment as its
last step, so if you want to iterate on an environment, you probably don’t want to use this right away.</li>
</ul>
<p>By default, you don’t get a ton of output about the state of your tests -- just a binary yes/no on success for the most
part. If you want more information, you can run with <code>--debug</code>, which will give you plenty of output. When running
Molecule in EC2 I also used <code>--debug</code> to find where Molecule was putting the ssh-key it was generating for its test
instances so I could poke around in them when something wasn’t working.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="writing-tests-in-molecule">Writing Tests in Molecule<a href="#writing-tests-in-molecule" class="hash-link" aria-label="Direct link to Writing Tests in Molecule" title="Direct link to Writing Tests in Molecule" translate="no">​</a></h2>
<p>By default, Molecule is not testing anything other than the accuracy of your Ansible code -- is it written right and
does it run without generating errors. This doesn’t tell you if it’s actually doing what you want it to, though. For
that, you’ll need to write additional tests. By default, these use Test-Infra
(<a href="https://testinfra.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer" class="">https://testinfra.readthedocs.io/en/latest/</a>); you’ll put these in the <code>molecule/scenario_name/tests</code> directory. You
should see a <code>test_default.py</code> file there already; this test is an example that just makes sure the <code>/etc/hosts</code> file
and root user exist, which is a bare minimum for things to actually work.</p>
<p>Writing tests for your role is going to depend a lot on what your role is supposed to do. Test-Infra is configured just
by writing Python functions and making assertions; you’ll need to read their docs in order to know how to test what you
want to.</p>
<p>Molecule does support other verifiers such as Goss and Inspec; see the Molecule docs for more information if you’d like
to use these.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/ansible/molecule-primer.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/infrasec/ansible/ansible-primer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ansible Primer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/infrasec/aws"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AWS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#molecule-documentation-and-articles" class="table-of-contents__link toc-highlight">Molecule documentation and articles</a></li><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup</a></li><li><a href="#creating-a-role-or-scenario" class="table-of-contents__link toc-highlight">Creating a role or scenario</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a><ul><li><a href="#testing-in-ec2" class="table-of-contents__link toc-highlight">Testing in EC2</a></li></ul></li><li><a href="#running-molecule-tests" class="table-of-contents__link toc-highlight">Running Molecule Tests</a></li><li><a href="#writing-tests-in-molecule" class="table-of-contents__link toc-highlight">Writing Tests in Molecule</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2026 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>