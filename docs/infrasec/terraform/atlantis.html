<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-infrasec/terraform/atlantis">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Atlantis | Truss Engineering Playbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://playbook.truss.dev/docs/infrasec/terraform/atlantis"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Atlantis | Truss Engineering Playbook"><meta data-rh="true" name="description" content="Atlantis is a Terraform automation tool which integrates with GitHub pull requests to automatically generate Terraform plans, hold them for approval, and then apply the Terraform changes and merge the branch. It also manages locks on namespaces, preventing conflicts between PRs on in the same Terraform namespace. Using Atlantis (or a similar tool like Terraform Cloud) is a way to ensure safe and auditable Terraform changes, something which is important for many Truss projects."><meta data-rh="true" property="og:description" content="Atlantis is a Terraform automation tool which integrates with GitHub pull requests to automatically generate Terraform plans, hold them for approval, and then apply the Terraform changes and merge the branch. It also manages locks on namespaces, preventing conflicts between PRs on in the same Terraform namespace. Using Atlantis (or a similar tool like Terraform Cloud) is a way to ensure safe and auditable Terraform changes, something which is important for many Truss projects."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://playbook.truss.dev/docs/infrasec/terraform/atlantis"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/terraform/atlantis" hreflang="en"><link data-rh="true" rel="alternate" href="https://playbook.truss.dev/docs/infrasec/terraform/atlantis" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.24e6a3c2.css">
<link rel="preload" href="/assets/js/runtime~main.c136aba6.js" as="script">
<link rel="preload" href="/assets/js/main.42cc8253.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/truss-icon-light.png" alt="Truss Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering Playbook</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trussworks/Engineering-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">Engineering Playbook</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/compliance">Federal Compliance</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/developing">Tools and Practice</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tools and Practice&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/documentation">Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/incident-response">Incident Response</a><button aria-label="Toggle the collapsible sidebar category &#x27;Incident Response&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/infrasec">InfraSec</a><button aria-label="Toggle the collapsible sidebar category &#x27;InfraSec&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/infrasec/adr/tests_in_terraform">adr</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/alert-providers">Alert Providers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/ansible">Ansible</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ansible&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/aws">AWS</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/book-club">Book Club</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/bootstrap">Project Bootstrap Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/certs">SSL Certificates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/charter">InfraSec Practice Charter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/ci_cd">CI/CD according to Truss</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/good-infra">Good Infrastructure - A Philosophy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/pro-dev">Professional Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/teardown">Project Teardown Guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/infrasec/terraform">Terraform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Terraform&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/infrasec/terraform/atlantis">Atlantis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/terraform/naming">Naming conventions for Terraform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/terraform/terraform-import">terraform import</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/terraform/terraform-state-mv">`terraform state mv` in Delicate Circumstances</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/infrasec/terraform/terratest">Terratest Guide</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/infrasec/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/leadership">Leadership</a><button aria-label="Toggle the collapsible sidebar category &#x27;Leadership&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/practices">Engineering Practices</a><button aria-label="Toggle the collapsible sidebar category &#x27;Engineering Practices&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/templates">Templates</a><button aria-label="Toggle the collapsible sidebar category &#x27;Templates&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/web">Web Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec"><span itemprop="name">InfraSec</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/infrasec/terraform"><span itemprop="name">Terraform</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Atlantis</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Atlantis</h1><p><a href="https://runatlantis.io" target="_blank" rel="noopener noreferrer">Atlantis</a> is a Terraform automation tool which integrates with GitHub pull requests to automatically generate Terraform plans, hold them for approval, and then apply the Terraform changes and merge the branch. It also manages locks on namespaces, preventing conflicts between PRs on in the same Terraform namespace. Using Atlantis (or a similar tool like Terraform Cloud) is a way to ensure safe and auditable Terraform changes, something which is important for many Truss projects.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-atlantis-in-truss-projects">Deploying Atlantis in Truss Projects<a class="hash-link" href="#deploying-atlantis-in-truss-projects" title="Direct link to heading">​</a></h2><p>The most important thing to keep in mind when planning your Atlantis deployment is that <strong>you can only have a single Atlantis instance per git repo</strong>. This is because Atlantis relies on an <code>atlantis.yaml</code> configuration file which sits at the root of the repo that tells it what directories to operate on; if you had multiple Atlantis deployments in the same repo, they would share a configuration file and conflict with each other. This is one of the reasons we split commercial and GovCloud infrastructure repos.</p><p>Because of this, our general deployment pattern, when we are working in our standard <a href="https://github.com/trussworks/Engineering-Playbook/blob/main/infrasec/aws/aws-organizations.md" target="_blank" rel="noopener noreferrer">AWS organization setup</a>, is to deploy the actual Atlantis service in the <code>-infra</code> account of the organization, and then create roles the service can assume in the other accounts to run Terraform there. This guide will describe how to build this pattern.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="directory-structure">Directory structure<a class="hash-link" href="#directory-structure" title="Direct link to heading">​</a></h3><p>In our infrastructure repo, we&#x27;ll have the directories like so:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">org-infra-repo/</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"> - org-infra</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">   - admin-global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">   - atlantis-service</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">   - atlantis-global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"> - org-dev</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">   - admin-global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">   - atlantis-global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this structure, each account has an <code>atlantis-global</code> namespace which sets up the <code>atlantis</code> IAM role, and then there is a single <code>atlantis-service</code> (or <code>atlantis-prod</code>, or whatever you prefer) namespace which contains the functional components of the Atlantis service.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-atlantis-global">Setting up atlantis-global<a class="hash-link" href="#setting-up-atlantis-global" title="Direct link to heading">​</a></h3><p>The first step to getting Atlantis set up is to create the <code>atlantis-global</code> namespace within the accounts we want Atlantis to be able to operate in. This may be literally every account; for some deployments, we do not allow Atlantis to make changes in the <code>org-root</code> account, but there&#x27;s no reason Atlantis <em>cannot</em> work there.</p><p>In the account we will be deploying the Atlantis service to (<code>org-infra</code> in our example), we will set up the <code>atlantis-global</code> namespace with Terraform like so to allow Atlantis to assume roles in the other accounts:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>`atlantis-global/main.tf` for Atlantis service account</summary><div><div class="collapsibleContent_i85q"><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  org_root_account   = &quot;000000000001&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  org_id_account     = &quot;000000000002&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  org_dev_account    = &quot;000000000003&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Add any other accounts to be managed here</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_caller_identity&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_partition&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This is the atlantis role that will be assumed by the actual Atlantis service.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;atlantis&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name               = &quot;atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description        = &quot;Role for atlantis to assume.&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  assume_role_policy = data.aws_iam_policy_document.atlantis_role_assume_policy.json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;atlantis_role_assume_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actions = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      type = &quot;AWS&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      identifiers = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        data.aws_caller_identity.current.account_id,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        # This is the role your infra engineers use; we want them to be</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        # able to assume the atlantis role to run Terraform manually if</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        # necessary.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        &quot;arn:${data.aws_partition.current.partition}:${data.aws_caller_identity.current.account_id}:role/admin&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># The atlantis role needs wide ranging permissions because the intent is</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># to use it for all AWS changes.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;atlantis_iam_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  role       = aws_iam_role.atlantis.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy_arn = &quot;arn:${data.aws_partition.current.partition}:iam::aws:policy/AdministratorAccess&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This policy will be used in the atlantis-service namespace by the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># atlantis module so that the service can assume the atlantis role in</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># other accounts.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;atlantis&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actions = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    resources = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      &quot;arn:${data.aws_partition.current.partition}:iam::${local.org_root_account}:role/atlantis&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      &quot;arn:${data.aws_partition.current.partition}:iam::${local.org_id_account}:role/atlantis&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      &quot;arn:${data.aws_partition.current.partition}:iam::${local.org_dev_account}:role/atlantis&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_policy&quot; &quot;atlantis&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name   = &quot;atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  path   = &quot;/&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy = data.aws_iam_policy_document.atlantis.json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>In the other accounts, we&#x27;ll add resources like the following to allow the Atlantis service in the above account to assume their <code>atlantis</code> role:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>`atlantis-global/main.tf` for other accounts</summary><div><div class="collapsibleContent_i85q"><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  org_infra_account = &quot;000000000004&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_caller_identity&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_partition&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># The atlantis role in this account just needs to be able to be assumed</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># by the atlantis role in the infra account, as well as the role infra</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># engineers will be using if they need to run Terraform here.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;atlantis&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name               = &quot;atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description        = &quot;Role for atlantis to assume&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  assume_role_policy = data.aws_iam_policy_document.atlantis_role_assume_policy.json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;atlantis_role_assume_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actions = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      type = &quot;AWS&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      identifiers = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        local.org_infra_account,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        &quot;arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:role/admin&quot;,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># As in the infra account, the atlantis role needs expansive permissions</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># so it can do all Terraform operations we need.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;atlantis_iam_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  role       = aws_iam_role.atlantis.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy_arn = &quot;arn:${data.aws_partition.current.partition}:iam::aws:policy/AdministratorAccess&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Once we&#x27;ve set up the <code>atlantis-global</code> namespaces, we can move on to the <code>atlantis-service</code> namespace.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-atlantis-service">Setting up the Atlantis service<a class="hash-link" href="#setting-up-the-atlantis-service" title="Direct link to heading">​</a></h3><p>The <code>atlantis-service</code> namespace is where we&#x27;ll build the actual Atlantis service. The bulk of this work is done with the <a href="https://registry.terraform.io/modules/terraform-aws-modules/atlantis/aws/latest" target="_blank" rel="noopener noreferrer"><code>atlantis</code></a> Terraform module. It creates a number of resources, including:</p><ul><li>a VPC</li><li>a Fargate service fronted by an ALB</li><li>an ACM certificate and Route53 DNS entries</li><li>Parameter Store entries for secrets</li></ul><p>Aside from this module, we&#x27;ll also need to create some resources in GitHub for the integration; in GovCloud, we&#x27;ll also need to create the DNS entries for the ALB and the ACM certificate verification separately, as Route53 is not available for public DNS in GovCloud. There are also two configuration files we&#x27;ll need to add, one in the <code>atlantis-service</code> namespace and one in the root of the Terraform repo.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-robot-github-user">Creating a robot GitHub user<a class="hash-link" href="#creating-a-robot-github-user" title="Direct link to heading">​</a></h4><p>If your project does not already have a &quot;robot&quot; GitHub user for automation, you will need to create one to facilitate Atlantis&#x27; integration with GitHub. The usual rules apply for accounts of that nature; they should be tied to an email address that is not a specific Trussel, and credentials should be stored in a project 1Password store. You will also need to create a user access token; the specifics you need are detailed in the <a href="https://www.runatlantis.io/docs/access-credentials.html#generating-an-access-token" target="_blank" rel="noopener noreferrer">Atlantis docs</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="add-github-user-access-token-to-aws-ssm-parameter-store">Add GitHub user access token to AWS SSM Parameter Store<a class="hash-link" href="#add-github-user-access-token-to-aws-ssm-parameter-store" title="Direct link to heading">​</a></h4><p>Once you have created the GitHub user and generated a user access token, you&#x27;ll need to add that token into SSM so that Atlantis can use it. Use the following commmand line to add it to the <code>-infra</code> account:</p><div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">aws ssm put-parameter --name &quot;/atlantis-global/github-user-token&quot; --type SecureString --description &quot;GitHub user token for Atlantis&quot; --value $ATLANTIS_USER_TOKEN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We&#x27;re adding this manually so that we&#x27;re not keeping a secret in code; we&#x27;ll use a data source too retrieve it later.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="atlantis-service-configuration-file">Atlantis service configuration file<a class="hash-link" href="#atlantis-service-configuration-file" title="Direct link to heading">​</a></h4><p>The <code>atlantis_repo_config.json</code> file should go in your <code>atlantis-service</code> Terraform namespace. This file configures how the service will work; the <a href="https://www.runatlantis.io/docs/server-configuration.html" target="_blank" rel="noopener noreferrer">Atlantis docs</a> describe the various configuration options, but you can use this as a basic JSON config:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token property" style="color:#b29762">&quot;repos&quot;</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      </span><span class="token property" style="color:#b29762">&quot;apply_requirements&quot;</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token string" style="color:#728fcb">&quot;approved&quot;</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token string" style="color:#728fcb">&quot;mergeable&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      </span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      </span><span class="token property" style="color:#b29762">&quot;id&quot;</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">&quot;/.*/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will require that pull requests be both approved and mergeable before Atlantis will allow it to be applied.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="govcloud-prep-create-acm-certificate">GovCloud prep: create ACM certificate<a class="hash-link" href="#govcloud-prep-create-acm-certificate" title="Direct link to heading">​</a></h4><p>If you are working in GovCloud, you will need to create a certificate in the <code>atlantis-service</code> namespace for your Atlantis instance. See the <a href="/docs/infrasec/aws/govcloud/gov-acm">ACM in GovCloud</a> guide for details on how to do this.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-atlantis-terraform-module">Set up Atlantis Terraform module<a class="hash-link" href="#set-up-atlantis-terraform-module" title="Direct link to heading">​</a></h4><p>Once we have the GitHub user set up and the user token in SSM (and the certificate created, if we&#x27;re in GovCloud), we can set up the Atlantis Terraform module in the <code>atlantis-service</code> namespace. The Atlantis module can set up most of the resources you need itself, like the VPC, ACM certificate, and Route53 DNS entry, or you can specify these separately and plug them in. In most cases, we&#x27;ll want to just let it do that, because it should be separate from all your other services anyway, but if you need to use a specific pre-existing VPC, or in GovCloud, where you&#x27;ll need to create the certificate validation and ALB DNS entries in your commercial account, then you should be able to do this without issue.</p><p>In addition, if you have not already, you will need to add permissions to your AWS log bucket to allow the Atlantis ALB to write to it. This bucket is usually in the <code>admin-global</code> namespace, and you will want to make sure you have configuration that looks similar to this:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Terraform code for org-infra account AWS logs bucket</summary><div><div class="collapsibleContent_i85q"><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;org_infra_logs&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source = &quot;trussworks/aws/logs&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  s3_bucket_name = &quot;org-infra-aws-logs&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_logs_prefixes = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    &quot;alb/atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Calling the module will look something like this:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Terraform code for Atlantis module and associated resources</summary><div><div class="collapsibleContent_i85q"><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_caller_identity&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_partition&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Here, we&#x27;re creating a data source to access the SSM parameter we added</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># before with the AWS CLI that has our github user token.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_ssm_parameter&quot; &quot;github_user_token&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name = &quot;/atlantis/github-user-token&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This is an additional secret added for a webhook that makes sure that</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Atlantis is getting a legitimate request (the Github repo uses this key</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># to confirm to Atlantis that it is allowed to use the service). If you</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># have multiple repos being served by the same Atlantis server, you must</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># make sure both repos are using the same secret for their webhooks.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">#</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Unfortunately, because of the way Atlantis handles this (it will</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># generate a webhook secret when the module is applied), leave this out</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># until you have run the Atlantis module once, then add it when you add</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># the custom_environment_secrets parameter (see the module instance</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># below).</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_ssm_parameter&quot; &quot;github_webhook_secret&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name = &quot;/atlantis/github-webhook-secret&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This is used to make sure that Atlantis *only* accepts inbound</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># connections from Github IP ranges, which are provided by the Github</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Terraform provider.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;github_ip_ranges&quot; &quot;main&quot; {}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># The next two stanzas define a policy that allows Atlantis to access</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># the SSM parameters for the Github user token and the Github webhook</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># secret. This policy will be attached later in the Atlantis module</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># instance.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;atlantis_ssm_github_user_token&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    effect  = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actions = [&quot;ssm:GetParameters&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    resources = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      data.aws_ssm_parameter.github_user_token.arn,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      data.aws_ssm_parameter.github_webhook_secret.arn</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">resource &quot;aws_iam_policy&quot; &quot;atlantis_ssm_github_user_token&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name   = &quot;atlantis-ssm-access&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  path   = &quot;/&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policy = data.aws_iam_policy_document.atlantis_ssm_github_user_token.json</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This policy is created in the atlantis-global namespace -- because we</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># want to attach this policy to the Atlantis task role, we need to create</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># a data source here and pull it in this way.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">data &quot;aws_iam_policy&quot; &quot;atlantis_access_policy&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  arn = &quot;arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:policy/atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># This is where the magic happens -- this module sets up an ECS service for</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># Atlantis, an ALB, security groups, etc. See further comments for more</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"># detail.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">module &quot;atlantis&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  source  = &quot;terraform-aws-modules/atlantis/aws&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  version = &quot;2.43.0&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # This will be the name of the service that shows up in ECS.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  name = &quot;atlantis-org-infra&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # A few notes about this image; first, we do not use the atlantis image</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # maintained by the Atlantis folks so that we can add Python3 to the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # image, which allow us to handle the Python lambdas we use in the Slack</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # notification Terraformm modules. We also do not specify the &quot;latest&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # image, because if we do so then Terraform will not realize when the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # image has changed due to an update, so that will never get updated. We</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # specify a SHA directly. You should use the latest version, which can</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # be found at https://github.com/trussworks/trussworks-atlantis-ecs-image</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  atlantis_image = &quot;trussworks/atlantis:cef8470b4f0aa0a9382f2c4149c53d6a0207f07e&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # GovCloud Note:</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # If you are using this module in GovCloud, you will need to use this</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # parameter so that the module does not try to create the DNS entry.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # create_route53_record = false</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  #</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # In addition, you will need to add this parameter (with the correct</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # resource reference) to add the ACM certificate you already created to</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # the ALB. The Atlantis module *cannot* be deployed *until* the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # certificate has already been created.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # certificate_arn = aws_acm_certificate.atlantis_org_infra.arn</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # In commercial, we can just let the module do the work of setting up</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # the DNS and certificate resources.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  route53_zone_name           = &quot;example.com&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  acm_certificate_domain_name = &quot;atlantis.example.com&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # VPC</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # If we have an already existing VPC that we want to put the service in,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # we should define that elsewhere with data sources (I recommend in a</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # separate vpc.tf file) and then add the following parameters (with the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # correctly-named references):</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # vpc_id             = data.aws_vpc.org_infra_vpc.id</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # private_subnet_ids = data.aws_subnet_ids.org_infra_vpc_private.ids</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # public_subnet_ids  = data.aws_subnet_ids.org_infra_vpc_public.ids</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # If we&#x27;re okay allowing the module to create the VPC itself, we&#x27;ll need</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # the following parameters instead (feel free to change the cidr numbers</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # to suit; if Atlantis is the only thing in the VPC, they are essentially</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # arbitrary):</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  cidr            = &quot;10.10.0.0/16&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  azs             = [&quot;us-west-2a&quot;, &quot;us-west-2b&quot;, &quot;us-west-2c&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  private_subnets = [&quot;10.10.1.0/24&quot;, &quot;10.10.2.0/24&quot;, &quot;10.10.3.0/24&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  public_subnets  = [&quot;10.10.101.0/24&quot;, &quot;10.10.102.0/24&quot;, &quot;10.10.103.0/24&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # ALB</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # We want to turn on logging for the ALB the module will create. The</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # S3 bucket here is defined in our admin-global namespace (and we have</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # to allow the bucket to be written to in that namespace in order for</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # this to work).</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_log_bucket_name     = &quot;org-infra-aws-logs&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_log_location_prefix = &quot;alb/atlantis&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_logging_enabled     = true</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Security groups</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # This parameter defines the networks allowed to access the Atlantis</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # web interface (which can be used for clearing locks). That interface</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # is actually not really necessary since those commmands can also be</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # run via GitHub comments, but if you wanted to allow access to other</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # hosts to connect -- say, VPN endpoints -- here&#x27;s how:</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_ingress_cidr_blocks = [&quot;192.168.1.100/32&quot;, &quot;10.0.0.1/32&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Here is where we&#x27;re using the Github IPs data source to restrict</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # the acceptable IPs for hitting the webhook.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  github_webhooks_cidr_blocks = data.github_ip_ranges.main.hooks</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # GitHub Access</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # This is where we specify the GitHub user that we&#x27;ll be using for</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Atlantis in this environment that you&#x27;ve already created. We are</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # also specifically saying where too put the webhook parameter because</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # the default location does not match the format chamber expects,</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # which is a commmon way for us to manage these parameters.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  atlantis_github_user       = &quot;atlantis-my-org&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  webhook_ssm_parameter_name = &quot;/atlantis/github-webhook-secret&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # This is where we define which repos Atlantis should be watching. You</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # can specify multiple repos if you want, but for our example we&#x27;ll</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # just be using the one.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  atlantis_repo_whitelist          = [&quot;github.com/my-org/my-org-infra&quot;]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  atlantis_hide_prev_plan_comments = &quot;true&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # This is where we specify the policies we want to attach to the role</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Atlantis is going to be using. The first is the basic AWS policy that</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # allows task execution, the other two are the ones we have defined</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # above to access SSM parameters and assume roles.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  policies_arn = [&quot;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&quot;, aws_iam_policy.atlantis_ssm_github_user_token.arn, data.aws_iam_policy.atlantis_access_policy.arn]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  atlantis_security_group_tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Type = &quot;ecs&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_https_security_group_tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Type = &quot;alb-https&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  alb_http_security_group_tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Type = &quot;alb-http&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    Environment = var.environment</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # You can read about these environment variables in the Atlantis</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # documentation; most of these are relatively self-explanatory.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # ATLANTIS_AUTOMERGE tells Atlantis to merge PRs after a successful</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # terraform apply.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  custom_environment_variables = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name  = &quot;ATLANTIS_DEFAULT_TF_VERSION&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      value = &quot;1.0.5&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name  = &quot;ATLANTIS_REPO_CONFIG_JSON&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      value = file(&quot;atlantis_repo_config.json&quot;)</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name  = &quot;ATLANTIS_AUTOMERGE&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      value = &quot;true&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name  = &quot;ATLANTIS_WRITE_GIT_CREDS&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      value = &quot;true&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name  = &quot;GITHUB_ORGANIZATION&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      value = &quot;my-org&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # These two secrets are necessary because there&#x27;s some jankiness</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # with the Atlantis module and how we&#x27;re using it (where we don&#x27;t</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # want to put the two secrets in the Terraform code if possible).</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # Unfortunately, there&#x27;s a hoop to jump through here -- you will</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # to apply this module *without* this parameter first, *then*</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # re-add this parameter and reapply so that you can get the</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  # webhook secret, which Atlantis will generate.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  custom_environment_secrets = [</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name      = &quot;ATLANTIS_GH_TOKEN&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      valueFrom = data.aws_ssm_parameter.github_user_token.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      name      = &quot;ATLANTIS_GH_WEBHOOK_SECRET&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">      valueFrom = data.aws_ssm_parameter.github_webhook_secret.name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  allow_unauthenticated_access = true</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  allow_github_webhooks        = true</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>Note that, as the comments in this code detail, you will need to do two Terraform runs, one without the custom environment secrets and then one with, in order for the Atlantis module to correctly generate the webhook secret and then for the task definition to call it. Once this is done, the service itself should be set up; we can then move on to setting up the webhook.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="govcloud-followup-add-cname-for-alb">GovCloud followup: Add CNAME for ALB<a class="hash-link" href="#govcloud-followup-add-cname-for-alb" title="Direct link to heading">​</a></h3><p>If you&#x27;re working in GovCloud, you should also add the following output to your <code>atlantis-service</code> namespace:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>output for ALB AWS DNS entry</summary><div><div class="collapsibleContent_i85q"><div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">output &quot;atlantis_alb_aws_fqdn&quot; {</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  description = &quot;AWS FQDN for Atlantis ALB&quot;</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  value       = module.atlantis.alb_dns_name</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>This will add an output that will give you the AWS DNS entry that corresponds to your ALB. With that, you will need to add a <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record" target="_blank" rel="noopener noreferrer">Route53 CNAME entry</a> in your DNS that points your selected domain name to your ALB&#x27;s AWS DNS entry. Note that for some projects, you may not be able to do this yourself (such as at CMS); in that case, you will need to provide that FQDN to the DNS manager and have them create the CNAME.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-the-github-webhook">Setting up the GitHub webhook<a class="hash-link" href="#setting-up-the-github-webhook" title="Direct link to heading">​</a></h3><p>Rather than restate the Atlantis docs, you can find the instructions on how to set up the webhook for Atlantis <a href="https://www.runatlantis.io/docs/configuring-webhooks.html#github-github-enterprise" target="_blank" rel="noopener noreferrer">here</a>. Note that you will need to have the service configured (with DNS and certificate) and your webhook generated before you do this.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-repo-level-atlantis-config">Configure repo-level Atlantis config<a class="hash-link" href="#configure-repo-level-atlantis-config" title="Direct link to heading">​</a></h3><p>The last step is to configure the repo-level Atlantis configuration. The <code>atlantis.yaml</code> file goes in the root of the Git repo you&#x27;re using for your Terraform. The <a href="https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html" target="_blank" rel="noopener noreferrer">Atlantis docs</a> on this file will give you the full explanation of what you can put in here, but for most of our projects, the only thing you will need is a list of the Terraform namespaces you want Atlantis to manage. It will look something like this:</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example `atlantis.yaml` config</summary><div><div class="collapsibleContent_i85q"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token key atrule" style="color:#728fcb">version</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token key atrule" style="color:#728fcb">projects</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">name</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">id</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">bootstrap</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token key atrule" style="color:#728fcb">dir</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">id/bootstrap</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">name</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">id</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token key atrule" style="color:#728fcb">dir</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">id/admin</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">name</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">infra</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">bootstrap</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token key atrule" style="color:#728fcb">dir</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">infra/bootstrap</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">  </span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#728fcb">name</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">infra</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">admin</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token key atrule" style="color:#728fcb">dir</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> org</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">infra/admin</span><span class="token punctuation" style="color:#b6ad9a">-</span><span class="token plain">global</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>We generally don&#x27;t recommend having Atlantis handle the Terraform of its own namespace, just because that introduces the potential of breaking itself, and there is some debate whether having Atlantis administer the org-root account is a good idea. You should feel free to make the decision that makes the most sense for your project (especially since changing this in the future is possible).</p><p>Once you&#x27;ve set up this file, you should be able to make a pull request and see Atlantis running a plan if you&#x27;ve set things up correctly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tips-and-troubleshooting">Tips and Troubleshooting<a class="hash-link" href="#tips-and-troubleshooting" title="Direct link to heading">​</a></h2><ul><li>If you update an SSM parameter, be sure to cycle the task (you can kill the running Atlantis task and let AWS restart it); these are read into the container&#x27;s environment at startup time, so they do not take effect unless you do this.</li><li>As the module configuration example states, we recommend against using <code>latest</code> as the container version, because this will force you to to two steps in order to upgrade the container version; instead, we recommend using the actual git SHA of the container.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="links-and-other-reading">Links and other reading<a class="hash-link" href="#links-and-other-reading" title="Direct link to heading">​</a></h2><ul><li><a href="https://runatlantis.io" target="_blank" rel="noopener noreferrer">Atlantis Official Site</a></li><li><a href="https://truss.works/blog/infrastructure-management-with-atlantis" target="_blank" rel="noopener noreferrer">Truss&#x27;s Atlantis blog post</a></li><li>🔒 <a href="https://github.com/trussworks/legendary-waddle" target="_blank" rel="noopener noreferrer">Atlantis setup in Truss&#x27;s commercial accounts</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/trussworks/Engineering-Playbook/edit/main/docs/infrasec/terraform/atlantis.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/infrasec/terraform"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Terraform</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/infrasec/terraform/naming"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Naming conventions for Terraform</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deploying-atlantis-in-truss-projects" class="table-of-contents__link toc-highlight">Deploying Atlantis in Truss Projects</a><ul><li><a href="#directory-structure" class="table-of-contents__link toc-highlight">Directory structure</a></li><li><a href="#setting-up-atlantis-global" class="table-of-contents__link toc-highlight">Setting up atlantis-global</a></li><li><a href="#setting-up-the-atlantis-service" class="table-of-contents__link toc-highlight">Setting up the Atlantis service</a></li><li><a href="#govcloud-followup-add-cname-for-alb" class="table-of-contents__link toc-highlight">GovCloud followup: Add CNAME for ALB</a></li><li><a href="#setting-up-the-github-webhook" class="table-of-contents__link toc-highlight">Setting up the GitHub webhook</a></li><li><a href="#configure-repo-level-atlantis-config" class="table-of-contents__link toc-highlight">Configure repo-level Atlantis config</a></li></ul></li><li><a href="#tips-and-troubleshooting" class="table-of-contents__link toc-highlight">Tips and Troubleshooting</a></li><li><a href="#links-and-other-reading" class="table-of-contents__link toc-highlight">Links and other reading</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://6130eb5cde15830007fdf57b--docusaurus-2.netlify.app/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 2023 TrussWorks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c136aba6.js"></script>
<script src="/assets/js/main.42cc8253.js"></script>
</body>
</html>